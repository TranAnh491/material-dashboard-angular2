<div class="delivery-container">

  <!-- Header -->
  <div class="delivery-header">
    <h2>
      <i class="material-icons">local_shipping</i>
      RM Delivery
    </h2>
    <div class="header-actions">
      <button class="menu-btn" (click)="goToMenu()" title="Về Menu">
        <i class="material-icons">home</i>
        Menu
      </button>
    </div>
  </div>

  <!-- Action buttons + Search — 1 hàng ngang -->
  <div class="delivery-content">
    <div class="toolbar-row">
      <button class="toolbar-btn" (click)="selectGiaoHang()" title="Giao Hàng">
        <i class="material-icons">local_shipping</i>
        <span>Giao Hàng</span>
      </button>
      <button class="toolbar-btn" (click)="deleteLsxHistory()" title="Xóa lịch sử theo LSX">
        <i class="material-icons">delete_outline</i>
        <span>Xóa</span>
      </button>
      <button class="toolbar-btn btn-desktop-only" (click)="printByLsx()" title="In chi tiết theo LSX">
        <i class="material-icons">print</i>
        <span>In</span>
      </button>
      <button class="toolbar-btn btn-desktop-only" (click)="downloadByMonth()" title="Tải về theo tháng">
        <i class="material-icons">download</i>
        <span>Tải về</span>
      </button>

      <!-- Ô tìm kiếm LSX -->
      <div class="search-input-wrap">
        <i class="material-icons search-icon" *ngIf="!isSearching">search</i>
        <i class="material-icons search-icon rotating" *ngIf="isSearching">refresh</i>
        <input
          type="text"
          class="search-input"
          [(ngModel)]="searchLsx"
          (keyup.enter)="onSearchLsx()"
          (ngModelChange)="searchResults = null"
          placeholder="Tìm LSX..."
          autocomplete="off"
        />
        <button class="search-clear" *ngIf="searchLsx" (click)="clearSearch()" title="Xóa">
          <i class="material-icons">close</i>
        </button>
        <button class="search-btn" (click)="onSearchLsx()" [disabled]="!searchLsx || isSearching" title="Tìm">
          <i class="material-icons">arrow_forward</i>
        </button>
      </div>
    </div>
  </div>

  <!-- Lịch sử giao hàng -->
  <div class="history-section">
    <h3>
      <i class="material-icons">history</i>
      Lịch sử giao hàng
    </h3>

    <!-- Loading -->
    <div class="loading-state" *ngIf="isLoadingHistory">
      <i class="material-icons rotating">refresh</i>
      <p>Đang tải...</p>
    </div>

    <!-- Chưa search -->
    <div class="empty-state hint-state" *ngIf="!isSearching && searchResults === null">
      <i class="material-icons">manage_search</i>
      <p>Nhập mã LSX và nhấn Enter để xem lịch sử giao hàng</p>
    </div>

    <!-- Đang tìm -->
    <div class="empty-state" *ngIf="isSearching">
      <i class="material-icons rotating">refresh</i>
      <p>Đang tìm kiếm...</p>
    </div>

    <!-- Không có kết quả -->
    <div class="empty-state" *ngIf="!isSearching && searchResults !== null && filteredHistory.length === 0">
      <i class="material-icons">search_off</i>
      <p>Không tìm thấy kết quả cho LSX <strong>"{{ searchLsx }}"</strong></p>
    </div>

    <!-- Danh sách record cards -->
    <div class="record-list" *ngIf="!isLoadingHistory && filteredHistory.length > 0">
      <div class="record-card" *ngFor="let record of filteredHistory; let ri = index">

        <!-- LSX header -->
        <div class="record-header">
          <span class="record-lsx">
            <i class="material-icons">assignment</i>
            {{ record.lsx || '—' }}
          </span>
          <span class="record-index">#{{ ri + 1 }}</span>
        </div>

        <!-- 4 info boxes -->
        <div class="record-info-boxes">
          <div class="info-box">
            <span class="info-label">NV Giao</span>
            <span class="info-value">{{ record.employeeName || record.employeeId || '—' }}</span>
          </div>
          <div class="info-box">
            <span class="info-label">NV Nhận</span>
            <span class="info-value">{{ record.receiverEmployeeName || record.receiverEmployeeId || '—' }}</span>
          </div>
          <div class="info-box">
            <span class="info-label">Line</span>
            <span class="info-value">{{ record.lineNhan || '—' }}</span>
          </div>
          <div class="info-box">
            <span class="info-label">Thời gian</span>
            <span class="info-value time-val">{{ formatDate(record.timestamp) }}</span>
          </div>
        </div>

        <!-- Bảng chi tiết pxkLines -->
        <div class="record-table-wrap" *ngIf="record.pxkLines && record.pxkLines.length > 0">
          <table class="record-table">
            <thead>
              <tr>
                <th>STT</th>
                <th>Mã Nguyên Liệu</th>
                <th>PO</th>
                <th>Số lượng</th>
                <th>Lượng Giao</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let line of record.pxkLines; let i = index"
                  [class.row-checked]="(line.checkQuantity ?? 0) > 0">
                <td>{{ i + 1 }}</td>
                <td>{{ line.materialCode }}</td>
                <td>{{ line.poNumber }}</td>
                <td>{{ line.quantity }}</td>
                <td class="col-giao">{{ line.checkQuantity != null ? line.checkQuantity : '—' }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="record-no-lines" *ngIf="!record.pxkLines || record.pxkLines.length === 0">
          Chưa có dữ liệu dòng hàng
        </div>

      </div>
    </div>
  </div>

</div>
