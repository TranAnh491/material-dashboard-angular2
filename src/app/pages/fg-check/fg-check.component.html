<!-- FG Check -->
<div class="main-content">
  <div class="content-container">
    
    <!-- Header -->
    <div class="header-section">
      <h2 class="page-title">
        <i class="material-icons">fact_check</i>
        FG Check
      </h2>
    </div>
    
    <!-- Action Buttons and Search -->
    <div class="action-section">
      <div class="action-buttons">
        <!-- Step 3: Scan Mã TP + Số lượng (hiển thị sau khi nhập shipment và pallet) -->
        <div class="scan-step-3" *ngIf="checkStep === 3">
          <div class="scan-info-row">
            <span class="scan-info-item">Shipment: <strong>{{scannedShipment}}</strong></span>
            <span class="scan-info-item">Pallet: <strong>{{currentPalletNo}}</strong></span>
            <span class="scan-info-item">Đã scan: <strong>{{scannedItems.length}} items</strong></span>
          </div>
          <div class="scan-inputs-row">
            <input type="text" 
                   class="custom-input scan-material-input" 
                   [(ngModel)]="currentScanInput"
                   (keyup.enter)="onMaterialCodeEntered()"
                   placeholder="Mã hàng..."
                   style="text-transform: uppercase;">
            <input type="text" 
                   class="custom-input scan-qty-input" 
                   [(ngModel)]="currentQtyInput"
                   (keyup.enter)="onMaterialAndQtyScanned()"
                   placeholder="Số lượng">
            <button class="custom-btn" (click)="onMaterialAndQtyScanned()" [disabled]="!currentScanInput || !currentQtyInput">
              <i class="material-icons">add</i>
            </button>
            <button class="custom-btn btn-success" (click)="saveScannedData()" [disabled]="scannedItems.length === 0">
              <i class="material-icons">check_circle</i>
              Done
            </button>
            <button class="custom-btn" (click)="resetCheck()">
              <i class="material-icons">close</i>
              Hủy
            </button>
          </div>
        </div>
        
        <button class="custom-btn btn-primary" (click)="openCheck()" *ngIf="checkStep === 0">
          <i class="material-icons">qr_code_scanner</i>
          Check
        </button>
        
        <!-- Filter indicator - hiển thị khi đang filter theo shipment -->
        <div class="filter-indicator" *ngIf="filterByShipment && !isScanning">
          <i class="material-icons">filter_alt</i>
          <span>Đang lọc: Shipment <strong>{{filterByShipment}}</strong></span>
          <button class="clear-filter-btn" (click)="clearShipmentFilter()" title="Xóa bộ lọc">
            <i class="material-icons">close</i>
          </button>
        </div>
        
        <button class="custom-btn" (click)="openChangeShipmentDialog()" *ngIf="checkStep === 0">
          <i class="material-icons">swap_horiz</i>
          Đổi số shipment
        </button>
        
        <div class="dropdown" *ngIf="checkStep === 0">
          <button class="custom-btn dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="material-icons">more_vert</i>
            More
          </button>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="javascript:void(0)" (click)="loadItemsFromFirebase(); $event.preventDefault()">
              <i class="material-icons">refresh</i>
              Refresh
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="reloadMappingAndUpdate(); $event.preventDefault()">
              <i class="material-icons">sync</i>
              Reload Mapping & Cập nhật Mã TP
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="forceReloadShipmentData(); $event.preventDefault()">
              <i class="material-icons">refresh</i>
              Reload Shipment Data & Tính lại
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="forceSaveCheckResults(); $event.preventDefault()">
              <i class="material-icons">save</i>
              Force Save Check Results
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="debugShipmentData(); $event.preventDefault()">
              <i class="material-icons">bug_report</i>
              Debug Shipment Data
            </a>
          </div>
        </div>
      </div>
      
      <div class="search-box">
        <input type="text" 
               placeholder="Tìm kiếm theo Shipment, Mã TP, Mã Hàng, ID Check..."
               [(ngModel)]="searchTerm"
               (input)="onSearchChange($event)"
               class="custom-input search-input-uppercase">
      </div>
    </div>
    
    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="loading-indicator">
      <i class="material-icons">refresh</i>
      <span>Đang tải dữ liệu...</span>
    </div>

    <!-- Data Table -->
    <div class="excel-body" [style.display]="isLoading ? 'none' : 'block'">
      <table class="excel-table">
        <thead>
          <tr>
            <th>Shipment</th>
            <th class="row-header">No</th>
            <th>Mã TP</th>
            <th>Mã Hàng</th>
            <th>Số Thùng</th>
            <th>Số Lượng</th>
            <th>Thùng Shipment</th>
            <th>Lượng Shipment</th>
            <th>So sánh</th>
            <th>ID Check</th>
            <th>Reset</th>
            <th>Lock</th>
            <th>Pallet No</th>
            <th>Xóa</th>
          </tr>
        </thead>
        <tbody>
          <!-- Show message when no results found -->
          <tr *ngIf="filteredItems.length === 0">
            <td colspan="14" class="text-center" style="padding: 20px; color: #000000;">
              <i class="material-icons" style="font-size: 48px; margin-bottom: 10px;">inbox</i>
              <br>
              Không có dữ liệu
            </td>
          </tr>
          
          <tr *ngFor="let item of filteredItems; let i = index">
            <td>{{item.shipment || ''}}</td>
            <td class="row-header">{{i + 1}}</td>
            <td class="code-cell" [class.duplicate-material]="isDuplicateMaterialCode(item)">{{item.materialCode}}</td>
            <td class="code-cell" [class.scanned-customer-code]="item.scannedCustomerCode">{{item.customerCode}}</td>
            <td class="number-cell">{{formatNumber(getDisplayCarton(item))}}</td>
            <td class="number-cell" [class.scanned-quantity]="item.scannedQuantity">{{formatNumber(item.quantity)}}</td>
            <td class="number-cell">{{formatNumber(item.shipmentCarton || 0)}}</td>
            <td class="number-cell">{{formatNumber(item.shipmentQuantity || 0)}}</td>
            <td class="status-cell">-</td>
            <td class="code-cell">{{item.checkId}}</td>
            <td class="action-cell">
              <button class="btn-reset" 
                      (click)="resetItem(item)" 
                      [disabled]="item.isLocked"
                      title="Reset dữ liệu đã scan">
                <i class="material-icons">refresh</i>
              </button>
            </td>
            <td class="action-cell">
              <input type="checkbox" 
                     class="lock-checkbox"
                     [checked]="item.isLocked"
                     (change)="toggleLockItem(item)"
                     title="Lock/Unlock dữ liệu">
            </td>
            <td class="code-cell">
              <input type="text"
                     class="pallet-input"
                     [(ngModel)]="item.palletNo"
                     [disabled]="item.isLocked"
                     (change)="updateItemInFirebase(item)"
                     placeholder="Pallet No"
                     style="text-transform: uppercase;">
            </td>
            <td class="action-cell">
              <button class="btn-delete" (click)="deleteItem(item)" title="Xóa">
                <i class="material-icons">delete</i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


<!-- Popup nhập Shipment và Pallet -->
<div class="modal-overlay" 
     *ngIf="showCheckDialog" 
     (click)="closeCheckDialog()"
     [style.position]="'fixed'"
     [style.top.px]="0"
     [style.left.px]="0"
     [style.width.%]="100"
     [style.height.%]="100"
     [style.background]="'rgba(0, 0, 0, 0.5)'"
     [style.display]="'flex'"
     [style.align-items]="'center'"
     [style.justify-content]="'center'"
     [style.z-index]="10000">
  <div class="modal-container" 
       (click)="$event.stopPropagation()">
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 class="modal-title" style="margin: 0;">
        <i class="material-icons">qr_code_scanner</i>
        Nhập thông tin Check
      </h3>
      <button class="close-btn" (click)="closeCheckDialog()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="form-group" style="margin-bottom: 20px;">
        <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 600;">Số Shipment:</label>
        <input type="text" 
               class="form-input" 
               [(ngModel)]="scannedShipment"
               (keyup.enter)="currentPalletNo && confirmCheckInfo()"
               placeholder="Nhập hoặc quét mã Shipment"
               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; text-transform: uppercase;"
               autofocus>
      </div>
      
      <div class="form-group" style="margin-bottom: 20px;">
        <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 600;">Số Pallet:</label>
        <input type="text" 
               class="form-input" 
               [(ngModel)]="currentPalletNo"
               (keyup.enter)="scannedShipment && confirmCheckInfo()"
               placeholder="Nhập hoặc quét số Pallet"
               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; text-transform: uppercase;">
      </div>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="btn btn-cancel" (click)="closeCheckDialog()">
        <i class="material-icons">close</i>
        Hủy
      </button>
      <button type="button" 
              class="btn btn-success" 
              (click)="confirmCheckInfo()" 
              [disabled]="!scannedShipment || !currentPalletNo"
              [style.opacity]="(!scannedShipment || !currentPalletNo) ? '0.5' : '1'"
              [style.cursor]="(!scannedShipment || !currentPalletNo) ? 'not-allowed' : 'pointer'">
        <i class="material-icons">check</i>
        Xác nhận
      </button>
    </div>
  </div>
</div>

<!-- Dialog Đổi số shipment -->
<div class="modal-overlay" 
     *ngIf="showChangeShipmentDialog" 
     (click)="closeChangeShipmentDialog()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">
        <i class="material-icons">swap_horiz</i>
        Đổi số shipment
      </h3>
      <button class="close-btn" (click)="closeChangeShipmentDialog()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Số shipment hiện tại (đã được check):</label>
        <input type="text" 
               class="form-input" 
               [(ngModel)]="oldShipmentCode"
               placeholder="Nhập số shipment cũ..."
               (keyup.enter)="newShipmentCode && changeShipmentCode()"
               style="text-transform: uppercase;">
      </div>
      
      <div class="form-group">
        <label class="form-label">Số shipment mới:</label>
        <input type="text" 
               class="form-input" 
               [(ngModel)]="newShipmentCode"
               placeholder="Nhập số shipment mới..."
               (keyup.enter)="oldShipmentCode && changeShipmentCode()"
               style="text-transform: uppercase;">
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="closeChangeShipmentDialog()">
        <i class="material-icons">close</i>
        Hủy
      </button>
      <button class="btn btn-apply" (click)="changeShipmentCode()" [disabled]="!oldShipmentCode || !newShipmentCode">
        <i class="material-icons">check</i>
        Done
      </button>
    </div>
  </div>
</div>

