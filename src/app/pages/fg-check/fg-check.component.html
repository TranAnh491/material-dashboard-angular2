<!-- FG Check -->
<div class="main-content">
  <div class="content-container">
    
    <!-- Header -->
    <div class="header-section">
      <h2 class="page-title">
        <i class="material-icons">fact_check</i>
        FG Check
      </h2>
    </div>
    
    <!-- Action Buttons and Search -->
    <div class="action-section">
      <div class="action-buttons">
        <!-- Step 3: Scan Mã TP + Số lượng (hiển thị sau khi nhập shipment và pallet) -->
        <div class="scan-step-3" *ngIf="checkStep === 3">
          <div class="scan-info-row">
            <span class="scan-info-item">Shipment: <strong>{{scannedShipment}}</strong></span>
            <span class="scan-info-item">Pallet: <strong>{{currentPalletNo}}</strong></span>
            <span class="scan-info-item">Đã scan: <strong>{{checkMode === 'pn' ? getCurrentPalletScannedCarton() : getCurrentPalletScannedQuantity()}}</strong>{{checkMode === 'pn' ? ' thùng' : ''}}</span>
          </div>
          <div class="scan-inputs-row">
            <input type="text" 
                   class="custom-input scan-material-input" 
                   [(ngModel)]="currentScanInput"
                   (keyup.enter)="checkMode === 'pn' ? onMaterialScannedForCarton() : onMaterialCodeEntered()"
                   placeholder="Mã hàng..."
                   style="text-transform: uppercase;">
            <input type="text" 
                   *ngIf="checkMode === 'pn-qty'"
                   class="custom-input scan-qty-input" 
                   [(ngModel)]="currentQtyInput"
                   (keyup.enter)="onMaterialAndQtyScanned()"
                   placeholder="Số lượng">
            <button *ngIf="checkMode === 'pn-qty'" class="custom-btn" (click)="onMaterialAndQtyScanned()" [disabled]="!currentScanInput || !currentQtyInput">
              <i class="material-icons">add</i>
            </button>
            <button *ngIf="checkMode === 'pn'" class="custom-btn" (click)="onMaterialScannedForCarton()" [disabled]="!currentScanInput">
              <i class="material-icons">add</i>
            </button>
            <button class="custom-btn btn-success" (click)="saveScannedData()" [disabled]="scannedItems.length === 0">
              <i class="material-icons">check_circle</i>
              Done
            </button>
            <button class="custom-btn" (click)="resetCheck()">
              <i class="material-icons">close</i>
              Hủy
            </button>
          </div>
        </div>
        
        <button class="custom-btn btn-primary" (click)="openCheck()" *ngIf="checkStep === 0">
          <i class="material-icons">qr_code_scanner</i>
          Check
        </button>
        
        <!-- Filter indicator - hiển thị khi đang filter theo shipment -->
        <div class="filter-indicator" *ngIf="filterByShipment && !isScanning">
          <i class="material-icons">filter_alt</i>
          <span>Đang lọc: Shipment <strong>{{filterByShipment}}</strong></span>
          <button class="clear-filter-btn" (click)="clearShipmentFilter()" title="Xóa bộ lọc">
            <i class="material-icons">close</i>
          </button>
        </div>
        
        <button class="custom-btn" (click)="openChangeShipmentDialog()" *ngIf="checkStep === 0">
          <i class="material-icons">swap_horiz</i>
          Đổi số shipment
        </button>
        
        <button class="custom-btn" type="button" (click)="openUnhideDialog()" *ngIf="checkStep === 0">
          <i class="material-icons">visibility</i>
          UNHIDE
        </button>
        <button class="custom-btn" type="button" (click)="openMorePopup()" *ngIf="checkStep === 0">
          <i class="material-icons">more_vert</i>
          More
        </button>
      </div>
      
      <div class="search-box">
        <input type="text" 
               placeholder="Tìm kiếm theo Shipment, Mã TP, Mã Hàng, ID Check..."
               [(ngModel)]="searchTerm"
               (input)="onSearchChange($event)"
               class="custom-input search-input-uppercase">
      </div>
    </div>
    
    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="loading-indicator">
      <i class="material-icons">refresh</i>
      <span>Đang tải dữ liệu...</span>
    </div>

    <!-- Data Table -->
    <div class="excel-body" [style.display]="isLoading ? 'none' : 'block'">
      <table class="excel-table">
        <thead>
          <tr>
            <th>Shipment</th>
            <th class="row-header">No</th>
            <th>Mã TP</th>
            <th>Mã Hàng</th>
            <th *ngIf="checkMode !== 'pn-qty'">Số Thùng</th>
            <th>Số Lượng</th>
            <th>ID Check</th>
            <th>Time</th>
            <th>Lock</th>
            <th>Pallet No</th>
            <th>Xóa</th>
          </tr>
        </thead>
        <tbody>
          <!-- Show message when no results found -->
          <tr *ngIf="filteredItems.length === 0">
            <td [attr.colspan]="checkMode === 'pn-qty' ? 10 : 11" class="text-center" style="padding: 20px; color: #000000;">
              <i class="material-icons" style="font-size: 48px; margin-bottom: 10px;">inbox</i>
              <br>
              Không có dữ liệu
            </td>
          </tr>
          
          <tr *ngFor="let item of filteredItems; let i = index">
            <td>{{item.shipment || ''}}</td>
            <td class="row-header">{{i + 1}}</td>
            <td class="code-cell" [class.duplicate-material]="isDuplicateMaterialCode(item)">{{item.materialCode}}</td>
            <td class="code-cell" [class.scanned-customer-code]="item.scannedCustomerCode">{{item.customerCode}}</td>
            <td *ngIf="checkMode !== 'pn-qty'" class="number-cell" [class.carton-ok]="isCartonOk(item)">
              {{formatNumber(getDisplayCarton(item))}}
              <span class="carton-ok-label" *ngIf="isCartonOk(item)"> OK</span>
            </td>
            <td class="number-cell" [class.scanned-quantity]="item.scannedQuantity">{{formatNumber(item.quantity)}}</td>
            <td class="code-cell code-cell-check-id" 
                (click)="showCheckTime(item)" 
                [title]="'Thời gian check: ' + formatCheckTime(item.createdAt)">
              {{item.scanId || item.checkId}}
            </td>
            <td class="code-cell code-cell-time" [title]="formatCheckTime(item.createdAt)">
              {{formatCheckTime(item.createdAt)}}
            </td>
            <td class="action-cell">
              <input type="checkbox" 
                     class="lock-checkbox"
                     [checked]="item.isLocked"
                     (change)="toggleLockItem(item)"
                     title="Lock/Unlock dữ liệu">
            </td>
            <td class="code-cell">
              <input type="text"
                     class="pallet-input"
                     [(ngModel)]="item.palletNo"
                     [disabled]="item.isLocked"
                     (change)="updateItemInFirebase(item)"
                     placeholder="Pallet No"
                     style="text-transform: uppercase;">
            </td>
            <td class="action-cell">
              <button class="btn-delete" (click)="openDeleteConfirm(item)" title="Xóa">
                <i class="material-icons">delete</i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


<!-- Popup nhập Shipment và Pallet -->
<div class="modal-overlay" 
     *ngIf="showCheckDialog" 
     (click)="closeCheckDialog()"
     [style.position]="'fixed'"
     [style.top.px]="0"
     [style.left.px]="0"
     [style.width.%]="100"
     [style.height.%]="100"
     [style.background]="'rgba(0, 0, 0, 0.5)'"
     [style.display]="'flex'"
     [style.align-items]="'center'"
     [style.justify-content]="'center'"
     [style.z-index]="10000">
  <div class="modal-container" 
       (click)="$event.stopPropagation()">
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 class="modal-title" style="margin: 0;">
        <i class="material-icons">qr_code_scanner</i>
        {{ checkDialogStep === 'mode' ? 'Chọn loại Check' : 'Nhập thông tin Check' }}
      </h3>
      <button class="close-btn" (click)="closeCheckDialog()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <!-- Bước 1: Chọn Check Thùng hoặc Check Số Lượng -->
    <div class="modal-body" *ngIf="checkDialogStep === 'mode'">
      <p class="check-mode-hint" style="margin-bottom: 16px; color: #333;">Chọn loại kiểm tra:</p>
      <div class="check-mode-options">
        <button type="button" class="btn btn-check-mode" (click)="selectCheckMode('pn')">
          <i class="material-icons">inventory_2</i>
          Check Thùng
        </button>
        <button type="button" class="btn btn-check-mode" (click)="selectCheckMode('pn-qty')">
          <i class="material-icons">numbers</i>
          Check Số Lượng
        </button>
      </div>
    </div>
    
    <!-- Bước 2: Nhập ID, Shipment, Pallet -->
    <div class="modal-body" *ngIf="checkDialogStep === 'form'">
      <div class="form-group" style="margin-bottom: 20px;">
        <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 600;">ID <span style="color: #c00;">*</span> (ASP + 4 số, VD: ASP1234):</label>
        <input type="text" 
               #idInput
               class="form-input check-id-input"
               [(ngModel)]="scannedCheckId"
               (keyup.enter)="onIdEnterMoveToShipment()"
               (input)="scannedCheckId = scannedCheckId.toUpperCase(); scannedCheckId = scannedCheckId.substring(0, 7)"
               maxlength="7"
               placeholder="Quét hoặc nhập ID (7 ký tự)"
               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; text-transform: uppercase;"
               autofocus>
      </div>
      <div class="form-group" style="margin-bottom: 20px;">
        <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 600;">Số Shipment <span style="color: #c00;">*</span>:</label>
        <input type="text" 
               #shipmentInput
               class="form-input check-shipment-input"
               [(ngModel)]="scannedShipment"
               (keyup.enter)="onShipmentEnterMoveToPallet()"
               placeholder="Nhập hoặc quét mã Shipment"
               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; text-transform: uppercase;">
      </div>
      
      <div class="form-group" style="margin-bottom: 12px;">
        <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 600;">Số Pallet <span style="color: #c00;">*</span>:</label>
        <input type="text" 
               #palletInput
               class="form-input check-pallet-input"
               [(ngModel)]="currentPalletNo"
               (keyup.enter)="onPalletEnterConfirm()"
               placeholder="Nhập hoặc quét số Pallet"
               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; text-transform: uppercase;">
      </div>
      <div class="form-group" style="margin-bottom: 20px;">
        <button type="button" class="btn btn-ship-le" (click)="setPalletToShipLe()">
          <i class="material-icons">local_shipping</i>
          Ship Lẻ
        </button>
      </div>
    </div>
    
    <div class="modal-footer" *ngIf="checkDialogStep === 'form'">
      <button type="button" class="btn btn-cancel" (click)="closeCheckDialog()">
        <i class="material-icons">close</i>
        Hủy
      </button>
      <button type="button" 
              class="btn btn-success" 
              (click)="confirmCheckInfo()" 
              [disabled]="!isCheckIdValid() || !scannedShipment || !currentPalletNo"
              [style.opacity]="(!isCheckIdValid() || !scannedShipment || !currentPalletNo) ? '0.5' : '1'"
              [style.cursor]="(!isCheckIdValid() || !scannedShipment || !currentPalletNo) ? 'not-allowed' : 'pointer'">
        <i class="material-icons">check</i>
        Xác nhận
      </button>
    </div>
  </div>
</div>

<!-- Dialog Đổi số shipment -->
<div class="modal-overlay" 
     *ngIf="showChangeShipmentDialog" 
     (click)="closeChangeShipmentDialog()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">
        <i class="material-icons">swap_horiz</i>
        Đổi số shipment
      </h3>
      <button class="close-btn" (click)="closeChangeShipmentDialog()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Số shipment hiện tại (đã được check):</label>
        <input type="text" 
               class="form-input" 
               [(ngModel)]="oldShipmentCode"
               placeholder="Nhập số shipment cũ..."
               (keyup.enter)="newShipmentCode && changeShipmentCode()"
               style="text-transform: uppercase;">
      </div>
      
      <div class="form-group">
        <label class="form-label">Số shipment mới:</label>
        <input type="text" 
               class="form-input" 
               [(ngModel)]="newShipmentCode"
               placeholder="Nhập số shipment mới..."
               (keyup.enter)="oldShipmentCode && changeShipmentCode()"
               style="text-transform: uppercase;">
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="closeChangeShipmentDialog()">
        <i class="material-icons">close</i>
        Hủy
      </button>
      <button class="btn btn-apply" (click)="changeShipmentCode()" [disabled]="!oldShipmentCode || !newShipmentCode">
        <i class="material-icons">check</i>
        Done
      </button>
    </div>
  </div>
</div>

<!-- Popup xóa: quét mã quản lý (chỉ scan, không nhập tay) -->
<div class="modal-overlay" 
     *ngIf="showDeleteConfirmPopup" 
     (click)="closeDeleteConfirm()">
  <div class="modal-container delete-confirm-modal" (click)="$event.stopPropagation()">
    <h3>Xóa item đã lock</h3>
    <p class="delete-confirm-info" *ngIf="deleteConfirmItem">
      Shipment: {{deleteConfirmItem.shipment}} | Mã TP: {{deleteConfirmItem.materialCode}}
    </p>
    <p class="delete-confirm-hint">Item đã lock – cần quét mã quản lý (chỉ quét, không nhập tay):</p>
    <input type="text"
           #deleteManagerInput
           class="form-input delete-manager-scan-input"
           [(ngModel)]="deleteManagerScanInput"
           (input)="onDeleteManagerScanInput($event)"
           placeholder="Quét mã..."
           maxlength="7"
           autocomplete="off"
           style="text-transform: uppercase; font-size: 18px;">
    <div class="modal-actions">
      <button type="button" class="btn btn-cancel" (click)="closeDeleteConfirm()">
        <i class="material-icons">close</i>
        Hủy
      </button>
    </div>
  </div>
</div>

<!-- Popup More -->
<div class="modal-overlay" 
     *ngIf="showMorePopup" 
     (click)="closeMorePopup()">
  <div class="modal-container more-popup-modal" (click)="$event.stopPropagation()">
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h3 class="modal-title" style="margin: 0;">
        <i class="material-icons">more_vert</i>
        More
      </h3>
      <button class="close-btn" (click)="closeMorePopup()">
        <i class="material-icons">close</i>
      </button>
    </div>
    <div class="more-popup-options">
      <button type="button" class="more-popup-item" (click)="openReportMonthDialog()">
        <i class="material-icons">description</i>
        <span>1. Tải báo cáo Check theo tháng</span>
      </button>
      <button type="button" class="more-popup-item" (click)="loadItemsFromFirebase(); closeMorePopup()">
        <i class="material-icons">refresh</i>
        <span>Refresh</span>
      </button>
      <button type="button" class="more-popup-item" (click)="reloadMappingAndUpdate(); closeMorePopup()">
        <i class="material-icons">sync</i>
        <span>Reload Mapping & Cập nhật Mã TP</span>
      </button>
      <button type="button" class="more-popup-item" (click)="forceReloadShipmentData(); closeMorePopup()">
        <i class="material-icons">refresh</i>
        <span>Reload Shipment Data & Tính lại</span>
      </button>
      <button type="button" class="more-popup-item" (click)="forceSaveCheckResults(); closeMorePopup()">
        <i class="material-icons">save</i>
        <span>Force Save Check Results</span>
      </button>
      <button type="button" class="more-popup-item" (click)="debugShipmentData(); closeMorePopup()">
        <i class="material-icons">bug_report</i>
        <span>Debug Shipment Data</span>
      </button>
    </div>
  </div>
</div>

<!-- Dialog chọn tháng/năm để tải báo cáo Check -->
<div class="modal-overlay" 
     *ngIf="showReportMonthDialog" 
     (click)="closeReportMonthDialog()">
  <div class="modal-container report-month-modal" (click)="$event.stopPropagation()">
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h3 class="modal-title" style="margin: 0;">Tải báo cáo Check theo tháng</h3>
      <button class="close-btn" (click)="closeReportMonthDialog()">
        <i class="material-icons">close</i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group" style="margin-bottom: 16px;">
        <label class="form-label">Tháng</label>
        <select class="form-input" [(ngModel)]="reportMonth" style="width: 100%; padding: 10px;">
          <option *ngFor="let m of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="m">Tháng {{m}}</option>
        </select>
      </div>
      <div class="form-group" style="margin-bottom: 16px;">
        <label class="form-label">Năm</label>
        <input type="number" class="form-input" [(ngModel)]="reportYear" min="2020" max="2030" style="width: 100%; padding: 10px;">
      </div>
    </div>
    <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 16px;">
      <button type="button" class="btn btn-cancel" (click)="closeReportMonthDialog()">
        <i class="material-icons">close</i>
        Hủy
      </button>
      <button type="button" class="btn btn-success" (click)="downloadCheckReportByMonth()">
        <i class="material-icons">file_download</i>
        Tải báo cáo
      </button>
    </div>
  </div>
</div>

<!-- Dialog UNHIDE: nhập Shipment để hiển thị dữ liệu đã ẩn (Lock), có thể Bỏ Lock -->
<div class="modal-overlay" 
     *ngIf="showUnhideDialog" 
     (click)="closeUnhideDialog()">
  <div class="modal-container unhide-modal" (click)="$event.stopPropagation()">
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h3 class="modal-title" style="margin: 0;">
        <i class="material-icons">visibility</i>
        UNHIDE – Hiển thị Shipment đã ẩn
      </h3>
      <button class="close-btn" (click)="closeUnhideDialog()">
        <i class="material-icons">close</i>
      </button>
    </div>
    <div class="modal-body">
      <p class="unhide-hint" style="margin-bottom: 12px; color: #333;">Nhập số Shipment để hiển thị lại dữ liệu đã bị ẩn (Lock).</p>
      <div class="form-group" style="margin-bottom: 16px;">
        <label class="form-label">Số Shipment</label>
        <input type="text"
               class="form-input unhide-shipment-input"
               [(ngModel)]="unhideShipmentInput"
               placeholder="Nhập hoặc quét Shipment"
               style="text-transform: uppercase; width: 100%; padding: 10px;">
      </div>
    </div>
    <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap;">
      <button type="button" class="btn btn-cancel" (click)="closeUnhideDialog()">
        <i class="material-icons">close</i>
        Hủy
      </button>
      <button type="button" class="btn btn-primary" (click)="confirmUnhideShipment()" [disabled]="!unhideShipmentInput?.trim()">
        <i class="material-icons">visibility</i>
        Hiển thị
      </button>
      <button type="button" class="btn btn-success" (click)="unlockShipmentAndClose()" [disabled]="!unhideShipmentInput?.trim()">
        <i class="material-icons">lock_open</i>
        Bỏ Lock
      </button>
    </div>
  </div>
</div>

