<!-- Password Modal -->
<div *ngIf="showPasswordModal" class="password-modal-overlay">
  <div class="password-modal-content">
    <div class="password-modal-header">
      <h4>
        <i class="material-icons">lock</i>
        Yêu cầu mật khẩu
      </h4>
    </div>
    <div class="password-modal-body">
      <p>Vui lòng nhập mật khẩu để truy cập tab Manage:</p>
      <div class="password-input-group">
        <input 
          type="password" 
          class="form-control password-input"
          [(ngModel)]="password"
          (keyup)="onPasswordKeyPress($event)"
          placeholder="Nhập mật khẩu..."
          autofocus>
        <div *ngIf="passwordError" class="password-error">
          <i class="material-icons">error</i>
          {{ passwordError }}
        </div>
      </div>
      <div class="password-modal-actions">
        <button class="btn btn-primary" (click)="checkPassword()">
          <i class="material-icons">check</i>
          Xác nhận
        </button>
      </div>
    </div>
  </div>
</div>

<div class="manage-container" *ngIf="!showPasswordModal">
  <div class="card">
    <div class="card-header">
      <h4 class="card-title">
        <i class="material-icons">manage_search</i>
        MANAGE MATERIALS
      </h4>
      <div class="header-actions">
        <button 
          class="btn btn-import" 
          (click)="importPriceFile()"
          title="Import file giá vật tư">
          <i class="material-icons">file_upload</i>
          Import File
        </button>
        <button 
          class="btn btn-download" 
          (click)="downloadReport()"
          [disabled]="summaryData.length === 0"
          title="Tải report Excel">
          <i class="material-icons">download</i>
          Tải Report
        </button>
      </div>
    </div>
    <div class="card-body">
      <!-- Selection Controls -->
      <div class="selection-controls">
        <div class="form-group">
          <label for="factory-select">NHÀ MÁY:</label>
          <select 
            id="factory-select" 
            class="form-control" 
            [(ngModel)]="selectedFactory"
            (change)="onFactoryChange()">
            <option value="ASM1">ASM1</option>
            <option value="ASM2">ASM2</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="material-input">MÃ NGUYÊN LIỆU:</label>
          <input 
            id="material-input"
            type="text" 
            class="form-control" 
            [(ngModel)]="materialCode"
            (input)="onMaterialCodeChange()"
            (keyup.enter)="searchMaterial()"
            placeholder="NHẬP MÃ NGUYÊN LIỆU..."
            style="text-transform: uppercase;">
        </div>
        
        <div class="form-group">
          <label for="location-input">VỊ TRÍ:</label>
          <input 
            id="location-input"
            type="text" 
            class="form-control" 
            [(ngModel)]="locationSearch"
            (input)="onLocationSearch()"
            (keyup.enter)="searchByLocation()"
            placeholder="NHẬP VỊ TRÍ..."
            style="text-transform: uppercase;">
        </div>
        
        <div class="form-group">
          <label>&nbsp;</label>
          <button 
            class="btn btn-primary reload-btn" 
            (click)="reloadData()"
            [disabled]="!materialCode && !locationSearch"
            title="Load lại dữ liệu">
            <i class="material-icons">refresh</i>
            Load lại
          </button>
        </div>
      </div>

      <!-- Top Filter Buttons -->
      <div class="top-filter-controls">
        <label>Lọc theo giá trị:</label>
        <button 
          class="btn btn-filter" 
          [class.active]="topFilter === null"
          (click)="applyTopFilter(null)"
          [disabled]="summaryData.length === 0">
          Tất cả
        </button>
        <button 
          class="btn btn-filter" 
          [class.active]="topFilter === 20"
          (click)="applyTopFilter(20)"
          [disabled]="summaryData.length === 0">
          Top 20
        </button>
        <button 
          class="btn btn-filter" 
          [class.active]="topFilter === 30"
          (click)="applyTopFilter(30)"
          [disabled]="summaryData.length === 0">
          Top 30
        </button>
        <button 
          class="btn btn-filter" 
          [class.active]="topFilter === 50"
          (click)="applyTopFilter(50)"
          [disabled]="summaryData.length === 0">
          Top 50
        </button>
      </div>

      <!-- Loading Indicator -->
      <div *ngIf="isLoading" class="loading-indicator">
        <div class="spinner"></div>
        <span>Đang tải dữ liệu...</span>
      </div>

      <!-- Summary Table -->
      <div *ngIf="!isLoading && summaryData.length > 0" class="summary-table-container">
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>STT</th>
              <th>Mã nguyên liệu</th>
              <th>PO</th>
              <th>IMD</th>
              <th>Vị trí</th>
              <th>Tồn kho</th>
              <th>Giá trị</th>
              <th>Standard Packing</th>
              <th>Cuộn chẵn</th>
              <th>Cuộn lẻ</th>
              <th>Lượng lẻ</th>
              <th>Trọng lượng cuộn (g)</th>
              <th>Ngày import</th>
              <th>Lịch sử gần nhất</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of summaryData; let i = index">
              <td class="text-center">{{ i + 1 }}</td>
              <td>{{ item.materialCode }}</td>
              <td>{{ item.poNumber }}</td>
              <td>{{ item.imd }}</td>
              <td>
                <span 
                  *ngFor="let loc of item.locations; let last = last" 
                  class="location-badge"
                  (click)="showLocationDetails(loc)"
                  [title]="'Click để xem danh sách materials ở vị trí ' + loc">
                  {{ loc }}<span *ngIf="!last">, </span>
                </span>
                <span *ngIf="item.locations.length === 0" class="text-muted">-</span>
              </td>
              <td class="text-right">{{ item.stock | number:'1.0-2' }}</td>
              <td class="text-right">
                <span *ngIf="item.materialValue !== undefined && item.materialValue > 0">
                  {{ item.materialValue | number:'1.0-2' }}
                </span>
                <span *ngIf="item.materialValue === undefined || item.materialValue === 0" class="text-muted">-</span>
              </td>
              <td class="text-right">{{ item.standardPacking | number:'1.0-2' }}</td>
              <td class="text-right">{{ item.evenRolls | number:'1.0-0' }}</td>
              <td class="text-right">{{ item.oddRolls | number:'1.2-2' }}</td>
              <td class="text-right">{{ item.oddQuantity | number:'1.0-2' }}</td>
              <td class="text-right">{{ item.totalWeight | number:'1.0-2' }}</td>
              <td class="text-center">{{ item.lastActionDate ? (item.lastActionDate | date:'dd/MM/yyyy') : '-' }}</td>
              <td class="activity-cell">
                <div *ngIf="item.lastActivity" class="activity-info" [class]="getActivityTypeClass(item.lastActivity.activityType)">
                  <div class="activity-type-badge" [class]="getActivityTypeClass(item.lastActivity.activityType)">
                    {{ getActivityTypeLabel(item.lastActivity.activityType) }}
                  </div>
                  <div class="activity-details">
                    <div class="activity-date">{{ item.lastActivity.activityDate | date:'dd/MM/yyyy HH:mm' }}</div>
                    <div class="activity-notes" *ngIf="item.lastActivity.notes">{{ item.lastActivity.notes }}</div>
                    <div class="activity-location" *ngIf="item.lastActivity.location">Vị trí: {{ item.lastActivity.location }}</div>
                  </div>
                </div>
                <span *ngIf="!item.lastActivity" class="text-muted">-</span>
              </td>
            </tr>
            <!-- Dòng tổng -->
            <tr class="total-row" *ngIf="summaryData.length > 0">
              <td colspan="6" class="text-right"><strong>TỔNG:</strong></td>
              <td class="text-right"><strong>{{ totalMaterialValue | number:'1.0-2' }}</strong></td>
              <td class="text-right"></td>
              <td class="text-right"><strong>{{ totalEvenRolls | number:'1.0-0' }}</strong></td>
              <td class="text-right"><strong>{{ totalOddRolls | number:'1.2-2' }}</strong></td>
              <td colspan="4"></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- No Data Message -->
      <div *ngIf="!isLoading && materialCode && summaryData.length === 0" class="no-data-message">
        <i class="material-icons">info</i>
        <p>Không tìm thấy dữ liệu cho mã nguyên liệu: <strong>{{ materialCode }}</strong></p>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isLoading && !materialCode && !locationSearch" class="empty-state">
        <i class="material-icons">search</i>
        <p>Vui lòng nhập mã nguyên liệu hoặc vị trí để tìm kiếm</p>
      </div>
    </div>
  </div>
</div>

<!-- Location Details Modal -->
<div *ngIf="showLocationModal" class="modal-overlay" (click)="closeLocationModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h4>Danh sách materials tại vị trí: <strong>{{ selectedLocation }}</strong></h4>
      <button class="close-btn" (click)="closeLocationModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    <div class="modal-body">
      <div *ngIf="isLoading" class="loading-indicator">
        <div class="spinner"></div>
        <span>Đang tải...</span>
      </div>
      <div *ngIf="!isLoading && locationMaterials.length === 0" class="no-data-message">
        <p>Không có materials nào tại vị trí này</p>
      </div>
      <table *ngIf="!isLoading && locationMaterials.length > 0" class="table table-striped">
        <thead>
          <tr>
            <th>Mã nguyên liệu</th>
            <th>PO</th>
            <th>IMD</th>
            <th>Tồn kho</th>
            <th>Standard Packing</th>
            <th>Số cuộn</th>
            <th>Trọng lượng (g)</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let mat of locationMaterials">
            <td>{{ mat.materialCode }}</td>
            <td>{{ mat.poNumber }}</td>
            <td>{{ getDisplayIMD(mat) }}</td>
            <td class="text-right">{{ calculateStock(mat) | number:'1.0-2' }}</td>
            <td class="text-right">{{ mat.standardPacking | number:'1.0-2' }}</td>
            <td class="text-right">{{ (calculateStock(mat) / (mat.standardPacking || 1)) | number:'1.0-2' }}</td>
            <td class="text-right">{{ (calculateStock(mat) * (mat.unitWeight || 0)) | number:'1.0-2' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

