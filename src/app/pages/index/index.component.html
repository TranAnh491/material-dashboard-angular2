<div class="main-content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-body">
            
            <!-- Import Section -->
            <div class="import-section" *ngIf="selectedFunction === 'import'">
              <h4 class="section-title">
                <i class="material-icons">upload_file</i> Import D·ªØ li·ªáu NVL
              </h4>
              
              <div class="import-controls">
                <div class="file-types-container">
                  <h5 class="file-types-title">Ch·ªçn lo·∫°i file ƒë·ªÉ import:</h5>
                  
                  <div class="file-types-grid">
                    <!-- File T·ªìn ƒë·∫ßu SXXK -->
                    <div class="file-type-card" (click)="selectFileType('ton-dau-sxxk')" [class.selected]="selectedFileType === 'ton-dau-sxxk'">
                      <div class="file-type-icon">
                        <i class="material-icons">inventory</i>
                      </div>
                      <div class="file-type-info">
                        <h6>File T·ªìn ƒë·∫ßu SXXK</h6>
                        <p>D·ªØ li·ªáu t·ªìn ƒë·∫ßu theo SXXK</p>
                      </div>
                    </div>

                    <!-- File B·∫£ng K√™ Xu·∫•t -->
                    <div class="file-type-card" (click)="selectFileType('bang-ke-xuat')" [class.selected]="selectedFileType === 'bang-ke-xuat'">
                      <div class="file-type-icon">
                        <i class="material-icons">exit_to_app</i>
                      </div>
                      <div class="file-type-info">
                        <h6>File B·∫£ng K√™ Xu·∫•t</h6>
                        <p>B·∫£ng k√™ xu·∫•t kho</p>
                      </div>
                    </div>

                    <!-- File B·∫£ng K√™ Nh·∫≠p -->
                    <div class="file-type-card" (click)="selectFileType('bang-ke-nhap')" [class.selected]="selectedFileType === 'bang-ke-nhap'">
                      <div class="file-type-icon">
                        <i class="material-icons">input</i>
                      </div>
                      <div class="file-type-info">
                        <h6>File B·∫£ng K√™ Nh·∫≠p</h6>
                        <p>B·∫£ng k√™ nh·∫≠p kho</p>
                      </div>
                    </div>

                    <!-- File B√°o C√°o T·ªìn Kho Hi·ªán T·∫°i -->
                    <div class="file-type-card" (click)="selectFileType('bao-cao-ton-hien-tai')" [class.selected]="selectedFileType === 'bao-cao-ton-hien-tai'">
                      <div class="file-type-icon">
                        <i class="material-icons">assessment</i>
                      </div>
                      <div class="file-type-info">
                        <h6>File B√°o C√°o T·ªìn Kho Hi·ªán T·∫°i</h6>
                        <p>B√°o c√°o t·ªìn kho hi·ªán t·∫°i</p>
                      </div>
                    </div>

                    <!-- File B√°o C√°o T·ªìn Kho 2024 -->
                    <div class="file-type-card" (click)="selectFileType('bao-cao-ton-2024')" [class.selected]="selectedFileType === 'bao-cao-ton-2024'">
                      <div class="file-type-icon">
                        <i class="material-icons">analytics</i>
                      </div>
                      <div class="file-type-info">
                        <h6>File B√°o C√°o T·ªìn Kho 2024</h6>
                        <p>B√°o c√°o t·ªìn kho nƒÉm 2024</p>
                      </div>
                    </div>

                    <!-- File Ti√™u H·ªßy -->
                    <div class="file-type-card" (click)="selectFileType('tieu-huy')" [class.selected]="selectedFileType === 'tieu-huy'">
                      <div class="file-type-icon">
                        <i class="material-icons">delete_forever</i>
                      </div>
                      <div class="file-type-info">
                        <h6>File Ti√™u H·ªßy</h6>
                        <p>D·ªØ li·ªáu ti√™u h·ªßy</p>
                      </div>
                    </div>

                    <!-- File CNVN -->
                    <div class="file-type-card" (click)="selectFileType('cnvn')" [class.selected]="selectedFileType === 'cnvn'">
                      <div class="file-type-icon">
                        <i class="material-icons">person</i>
                      </div>
                      <div class="file-type-info">
                        <h6>File CNVN</h6>
                        <p>D·ªØ li·ªáu CNVN</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="file-input-container" *ngIf="selectedFileType">
                  <input type="file" 
                         id="excelFileInput" 
                         accept=".xlsx,.xls" 
                         (change)="onFileSelected($event)" 
                         style="display: none;">
                  <label for="excelFileInput" class="btn btn-primary">
                    <i class="material-icons">file_upload</i> Ch·ªçn file Excel
                  </label>
                  <button class="btn btn-outline-info" (click)="showTimeRangeDialog = true">
                    <i class="material-icons">schedule</i> Ch·ªçn th·ªùi gian
                  </button>
                  <button class="btn btn-outline-success" (click)="exportIndexDataByTimeRange()">
                    <i class="material-icons">download</i> T·∫£i v·ªÅ
                  </button>
                  <button class="btn btn-outline-primary" (click)="downloadTemplate()">
                    <i class="material-icons">download</i> T·∫£i Form
                  </button>
                  <button mat-raised-button color="accent" (click)="showAllIndexData()" class="btn btn-outline-warning">
                    <mat-icon>visibility</mat-icon> Hi·ªÉn th·ªã t·∫•t c·∫£
                  </button>
                </div>

                <!-- Imported Files List -->
                <div class="imported-files-section" *ngIf="selectedFileType">
                  <div class="section-header">
                    <h5 class="section-title">
                      <i class="material-icons">folder</i> 
                      Files ƒë√£ import cho {{getFileTypeName(selectedFileType)}}
                    </h5>
                    <span class="file-count">{{importedFiles.length}} files</span>
                  </div>

                  <div class="loading-files" *ngIf="isLoadingFiles">
                    <div class="spinner"></div>
                    <span>ƒêang t·∫£i danh s√°ch files...</span>
                  </div>

                  <div class="imported-files-list" *ngIf="!isLoadingFiles">
                    <div class="no-files" *ngIf="importedFiles.length === 0">
                      <i class="material-icons">folder_open</i>
                      <p>Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c import cho lo·∫°i n√†y</p>
                    </div>

                    <div class="file-item" *ngFor="let file of importedFiles" [class.error]="file.status === 'error'">
                      <div class="file-info">
                        <div class="file-header">
                          <div class="file-name">
                            <i class="material-icons">description</i>
                            <span>{{file.fileName}}</span>
                          </div>
                          <div class="file-status">
                            <i class="material-icons" [style.color]="getStatusColor(file.status)">
                              {{getStatusIcon(file.status)}}
                            </i>
                            <span class="status-text" [style.color]="getStatusColor(file.status)">
                              {{file.status === 'success' ? 'Th√†nh c√¥ng' : 
                                file.status === 'error' ? 'L·ªói' : 'ƒêang x·ª≠ l√Ω'}}
                            </span>
                          </div>
                        </div>
                        
                        <div class="file-details">
                          <div class="detail-item">
                            <i class="material-icons">storage</i>
                            <span>{{getFileSizeDisplay(file.fileSize)}}</span>
                          </div>
                          <div class="detail-item">
                            <i class="material-icons">person</i>
                            <span>{{file.importedBy}}</span>
                          </div>
                          <div class="detail-item">
                            <i class="material-icons">schedule</i>
                            <span>{{file.importDate | date:'dd/MM/yyyy HH:mm'}}</span>
                          </div>
                          <div class="detail-item">
                            <i class="material-icons">list</i>
                            <span>{{file.recordCount}} records</span>
                          </div>
                        </div>

                        <div class="error-message" *ngIf="file.status === 'error' && file.errorMessage">
                          <i class="material-icons">error_outline</i>
                          <span>{{file.errorMessage}}</span>
                        </div>
                      </div>

                      <div class="file-actions">
                        <button class="btn btn-sm btn-outline-danger" 
                                (click)="deleteImportedFile(file.id)"
                                matTooltip="X√≥a file">
                          <i class="material-icons">delete</i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="import-info" *ngIf="selectedFileType">
                  <p>üí° H∆∞·ªõng d·∫´n cho <strong>{{getFileTypeName(selectedFileType)}}</strong>:</p>
                  <ul>
                    <li>File Excel ph·∫£i c√≥ ƒë·ªãnh d·∫°ng ph√π h·ª£p v·ªõi lo·∫°i file ƒë√£ ch·ªçn</li>
                    <li>D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c n·ªëi ti·∫øp v·ªõi d·ªØ li·ªáu hi·ªán c√≥ (kh√¥ng ghi ƒë√®)</li>
                    <li>File t·ªëi ƒëa 10MB</li>
                    <li>Format chi ti·∫øt s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t sau</li>
                  </ul>
                </div>
                
                <div class="firebase-status" *ngIf="firebaseSaved">
                  <span class="status-success">‚úÖ ƒê√£ l∆∞u v√†o Firebase</span>
                </div>
                
                <div class="loading-indicator" *ngIf="isSaving">
                  <div class="spinner"></div>
                  <span>ƒêang l∆∞u v√†o Firebase...</span>
                </div>
                
                <div class="loading-indicator" *ngIf="isLoading">
                  <div class="spinner"></div>
                  <span>ƒêang x·ª≠ l√Ω file Excel...</span>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="row action-buttons-row">
              <div class="col-md-12">
                <div class="action-buttons">
                  <!-- More Button - Dropdown -->
                  <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" 
                            type="button" 
                            id="moreDropdown" 
                            data-toggle="dropdown" 
                            aria-haspopup="true" 
                            aria-expanded="false">
                      <i class="material-icons">more_horiz</i>
                      <span>MORE</span>
                    </button>
                    <div class="dropdown-menu" aria-labelledby="moreDropdown">
                      <a class="dropdown-item" href="javascript:void(0)" (click)="selectFunction('import'); $event.preventDefault()">
                        <i class="material-icons">file_upload</i> Import File
                      </a>
                      <a class="dropdown-item" href="javascript:void(0)" (click)="downloadTemplate(); $event.preventDefault()">
                        <i class="material-icons">download</i> T·∫£i Template
                      </a>
                      <a class="dropdown-item" href="javascript:void(0)" (click)="downloadReport(); $event.preventDefault()">
                        <i class="material-icons">assessment</i> T·∫£i Report
                      </a>
                    </div>
                  </div>

                  <!-- Back Button -->
                  <button class="btn btn-outline-secondary" (click)="goBack()">
                    <i class="material-icons">arrow_back</i>
                    <span>BACK</span>
                  </button>

                  <!-- Delete Button -->
                  <button class="btn btn-outline-danger" (click)="showDeleteDialog = true" *ngIf="hasDeletePermission()">
                    <i class="material-icons">delete</i>
                    <span>DELETE</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Add NVL Data Form -->
            <div class="row" *ngIf="isAddingIndexData">
              <div class="col-md-12">
                <div class="card compact-form">
                  <div class="card-header card-header-success">
                    <h4 class="card-title">Th√™m D·ªØ li·ªáu NVL</h4>
                  </div>
                  <div class="card-body">
                    <form>
                      <div class="row">
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>M√£ NVL</mat-label>
                            <input matInput [(ngModel)]="newIndexData.materialCode" name="materialCode" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>T·ªìn ƒë·∫ßu E31</mat-label>
                            <input matInput type="number" [(ngModel)]="newIndexData.openingStockE31" name="openingStockE31" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>T·ªìn ƒë·∫ßu ND</mat-label>
                            <input matInput type="number" [(ngModel)]="newIndexData.openingStockND" name="openingStockND" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>NK E31</mat-label>
                            <input matInput type="number" [(ngModel)]="newIndexData.importE31" name="importE31" required>
                          </mat-form-field>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>NK ND</mat-label>
                            <input matInput type="number" [(ngModel)]="newIndexData.importND" name="importND" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>PN E31</mat-label>
                            <input matInput type="number" [(ngModel)]="newIndexData.receiptE31" name="receiptE31" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>PN ND</mat-label>
                            <input matInput type="number" [(ngModel)]="newIndexData.receiptND" name="receiptND" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>PX E31</mat-label>
                            <input matInput type="number" [(ngModel)]="newIndexData.issueE31" name="issueE31" required>
                          </mat-form-field>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>PX ND</mat-label>
                            <input matInput type="number" [(ngModel)]="newIndexData.issueND" name="issueND" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>T·ªìn cu·ªëi E31</mat-label>
                            <input matInput type="number" [(ngModel)]="newIndexData.closingStockE31" name="closingStockE31" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>T·ªìn cu·ªëi ND</mat-label>
                            <input matInput type="number" [(ngModel)]="newIndexData.closingStockND" name="closingStockND" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>T·ªìn BCTK</mat-label>
                            <input matInput type="number" [(ngModel)]="newIndexData.reportStock" name="reportStock" required>
                          </mat-form-field>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>SS BCTK</mat-label>
                            <input matInput type="number" [(ngModel)]="newIndexData.reportDifference" name="reportDifference" required>
                          </mat-form-field>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-12">
                          <button mat-raised-button color="primary" (click)="addNewIndexData()" [disabled]="!isValidIndexData()">
                            <mat-icon>save</mat-icon> L∆∞u D·ªØ li·ªáu NVL
                          </button>
                          <button mat-raised-button (click)="isAddingIndexData = false; resetForm()" class="ml-2">
                            <mat-icon>cancel</mat-icon> H·ªßy
                          </button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <!-- NVL Data Table -->
            <div class="row table-row">
              <div class="col-md-12">
                <div class="card table-card">
                  <div class="card-body table-responsive table-container">
                    <table class="table table-hover compact-table">
                      <thead class="text-primary">
                        <tr>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 80px; font-size: 13.33px; font-weight: normal;">M√£ NVL</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 70px; font-size: 13.33px; font-weight: normal;">T·ªìn ƒë·∫ßu E31</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 70px; font-size: 13.33px; font-weight: normal;">T·ªìn ƒë·∫ßu ND</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 60px; font-size: 13.33px; font-weight: normal;">NK E31</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 60px; font-size: 13.33px; font-weight: normal;">NK ND</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 60px; font-size: 13.33px; font-weight: normal;">PN E31</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 60px; font-size: 13.33px; font-weight: normal;">PN ND</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 60px; font-size: 13.33px; font-weight: normal;">PX E31</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 60px; font-size: 13.33px; font-weight: normal;">PX ND</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 70px; font-size: 13.33px; font-weight: normal;">T·ªìn cu·ªëi E31</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 70px; font-size: 13.33px; font-weight: normal;">T·ªìn cu·ªëi ND</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 70px; font-size: 13.33px; font-weight: normal;">T·ªìn BCTK</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 60px; font-size: 13.33px; font-weight: normal;">SS BCTK</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 35px; font-size: 13.33px; font-weight: normal;">S·ª≠a</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 35px; font-size: 13.33px; font-weight: normal;">X√≥a</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let data of filteredIndexData; let i = index" 
                            [class]="getStatusClass(data.status || 'active') + (isSelected(data) ? ' selected-row' : '')">
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{data.materialCode}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{data.openingStockE31 | number}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{data.openingStockND | number}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{data.importE31 | number}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{data.importND | number}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{data.receiptE31 | number}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{data.receiptND | number}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{data.issueE31 | number}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{data.issueND | number}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{data.closingStockE31 | number}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{data.closingStockND | number}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{data.reportStock | number}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{data.reportDifference | number}}</td>
                          <td style="text-align: center; vertical-align: middle;">
                              <button mat-icon-button color="primary" (click)="editIndexData(data)" 
                                    *ngIf="canEdit()"
                                    matTooltip="Edit NVL Data" class="compact-btn"
                                    style="width: 36px; height: 36px; min-width: 36px; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                              <mat-icon style="font-size: 21px; width: 21px; height: 21px;">edit</mat-icon>
                              </button>
                              <span *ngIf="!canEdit()" style="font-size: 10px; color: #999;">Kh√¥ng c√≥ quy·ªÅn</span>
                          </td>
                          <td style="text-align: center; vertical-align: middle;">
                              <button mat-icon-button color="warn" (click)="deleteIndexData(data)" 
                                    *ngIf="hasDeletePermission()"
                                    matTooltip="Delete NVL Data" class="compact-btn"
                                    style="width: 36px; height: 36px; min-width: 36px; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                              <mat-icon style="font-size: 21px; width: 21px; height: 21px;">delete</mat-icon>
                              </button>
                              <span *ngIf="!hasDeletePermission()" style="font-size: 10px; color: #999;">Kh√¥ng c√≥ quy·ªÅn</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                    
                    <div *ngIf="filteredIndexData.length === 0" class="no-data">
                      <p>Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu NVL n√†o.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div> 