<div class="main-content">
  <!-- Excel-like Container -->
  <div class="excel-container">
    <!-- Report Title -->
    <div class="excel-header">
      <h4>üìç LOCATION MANAGEMENT</h4>
    </div>
    
    <!-- Excel Actions -->
    <div class="excel-actions">
      <div class="action-controls-horizontal">
        <!-- Desktop Controls -->
        <div class="desktop-controls">
          <!-- More Button with Dropdown -->
          <div class="dropdown">
            <button class="more-btn" (click)="toggleDropdown($event)">
              <i class="material-icons">more_vert</i>
              More
            </button>
            <div class="dropdown-menu" [class.show]="isDropdownOpen">
              <a class="dropdown-item" href="javascript:void(0)" (click)="exportToExcel()">
                <i class="material-icons">file_download</i>
                Export to Excel
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="javascript:void(0)" (click)="importLocations()">
                <i class="material-icons">file_upload</i>
                Import V·ªã Tr√≠
              </a>
              <a class="dropdown-item" href="javascript:void(0)" (click)="downloadTemplate()">
                <i class="material-icons">description</i>
                Template V·ªã Tr√≠
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="javascript:void(0)" (click)="importCustomerCodes()">
                <i class="material-icons">file_upload</i>
                Import m√£ kh√°ch h√†ng
              </a>
              <a class="dropdown-item" href="javascript:void(0)" (click)="downloadCustomerTemplate()">
                <i class="material-icons">description</i>
                Template m√£ kh√°ch h√†ng
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="javascript:void(0)" (click)="openFGModal()">
                <i class="material-icons">check_circle_outline</i>
                FG
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="javascript:void(0)" (click)="initializeSampleData()">
                <i class="material-icons">add_circle</i>
                Initialize Sample Data
              </a>
              <a class="dropdown-item" href="javascript:void(0)" (click)="deleteAllLocations()" *ngIf="filteredItems.length > 0">
                <i class="material-icons">delete_forever</i>
                X√≥a T·∫•t C·∫£
              </a>
            </div>
          </div>
          
          <!-- Total Counter Box -->
          <div class="total-counter-box">
            <i class="material-icons">location_on</i>
            <span>T·ªïng: {{ filteredItems.length }} v·ªã tr√≠</span>
          </div>
          
          <!-- Action Buttons -->
          <div class="action-buttons">
            <button class="store-material-btn" (click)="openStoreMaterialModal()" title="C·∫•t nguy√™n v·∫≠t li·ªáu">
              <i class="material-icons">inventory</i>
              C·∫•t NVL
            </button>
            <button class="change-location-btn-desktop" (click)="openChangeLocationModal()" title="Thay ƒë·ªïi v·ªã tr√≠">
              <i class="material-icons">swap_horiz</i>
              Change Location
            </button>
            <button class="refresh-btn" (click)="refreshData()" title="L√†m m·ªõi d·ªØ li·ªáu Location">
              <i class="material-icons">refresh</i>
              Refresh
            </button>
            <button class="customer-btn" (click)="openCustomerModal()" title="Danh s√°ch m√£ kh√°ch h√†ng">
              <i class="material-icons">people</i>
              Customer
            </button>
          </div>
        </div>
        
        <!-- Mobile Controls -->
        <div class="mobile-controls">
          <!-- Store Material Button -->
          <button class="store-material-btn mobile" (click)="openStoreMaterialModal()" title="C·∫•t nguy√™n v·∫≠t li·ªáu">
            <i class="material-icons">inventory</i>
            C·∫•t NVL
          </button>
          <!-- Change Location Button -->
          <button class="change-location-btn" (click)="openChangeLocationModal()" title="Thay ƒë·ªïi v·ªã tr√≠">
            <i class="material-icons">swap_horiz</i>
            Change Location
          </button>
        </div>
        
        <!-- Search Box -->
        <div class="search-box">
          <input type="text"
                 [placeholder]="isLoading ? 'üîç ƒêang t·∫£i...' : 'Nh·∫≠p ƒë·ªÉ t√¨m ki·∫øm'"
                 [(ngModel)]="searchTerm"
                 (input)="onSearchInput($event)"
                 (keyup)="onSearchKeyUp($event)"
                 class="search-input"
                 [disabled]="isLoading">
          
          <!-- Clear search button -->
          <button class="clear-search-btn" 
                  *ngIf="searchTerm" 
                  (click)="clearSearch()" 
                  title="X√≥a t√¨m ki·∫øm">
            <i class="material-icons">clear</i>
          </button>
          
          <!-- Search warning -->
          <div class="search-warning" *ngIf="searchTerm && searchTerm.length < 2">
            <i class="material-icons">info</i>
            C·∫ßn √≠t nh·∫•t 2 k√Ω t·ª±
          </div>
        </div>
      </div>
    </div>

    <!-- Add New Item Form -->
    <div class="add-item-form">
      <h5>‚ûï Th√™m V·ªã Tr√≠ M·ªõi</h5>
      <div class="form-row">
        <div class="form-group">
          <label for="newViTri">V·ªã Tr√≠:</label>
          <input type="text" 
                 id="newViTri"
                 [(ngModel)]="newItem.viTri" 
                 (input)="onViTriInputChange($event)"
                 [class.valid]="newItem.viTri && validateViTriInput(newItem.viTri)"
                 [class.invalid]="newItem.viTri && !validateViTriInput(newItem.viTri)"
                 class="form-input"
                 placeholder="VD: A1-01, B2-03"
                 maxlength="20"
                 title="Ch·ªâ cho ph√©p ch·ªØ c√°i, s·ªë, d·∫•u ch·∫•m (.) v√† d·∫•u g·∫°ch ngang (-)">
          <div class="validation-message" 
               [class.error]="newItem.viTri && !validateViTriInput(newItem.viTri)"
               [class.success]="newItem.viTri && validateViTriInput(newItem.viTri)"
               *ngIf="newItem.viTri">
            <span *ngIf="!validateViTriInput(newItem.viTri)">
              ‚ö†Ô∏è Ch·ªâ cho ph√©p ch·ªØ c√°i, s·ªë, d·∫•u ch·∫•m (.) v√† d·∫•u g·∫°ch ngang (-)
            </span>
            <span *ngIf="validateViTriInput(newItem.viTri)">
              ‚úÖ ƒê·ªãnh d·∫°ng h·ª£p l·ªá
            </span>
          </div>
        </div>
        
        <div class="form-group">
          <button class="add-btn" (click)="addLocationItem()" title="Th√™m v·ªã tr√≠ m·ªõi">
            <i class="material-icons">add</i>
            Th√™m
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading-container" *ngIf="isLoading">
      <div class="loading-spinner">
        <i class="material-icons rotating">sync</i>
        <span>ƒêang t·∫£i d·ªØ li·ªáu Location...</span>
      </div>
    </div>

    <!-- Table Container -->
    <div class="table-container desktop-only" *ngIf="!isLoading">
      <!-- Table -->
      <table class="excel-table">
        <thead>
          <tr>
            <th>STT</th>
            <th>V·ªã Tr√≠</th>
            <th>QR Code</th>
            <th>Thao T√°c</th>
            <th>X√≥a</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of filteredItems; trackBy: trackByFn; let i = index">
            <!-- STT Column -->
            <td class="stt-cell">
              <ng-container *ngIf="editingItem?.id !== item.id; else editStt">
                {{ item.stt }}
              </ng-container>
              <ng-template #editStt>
                <input type="number" 
                       [(ngModel)]="editingItem.stt" 
                       class="edit-input"
                       min="1">
              </ng-template>
            </td>
            
            <!-- V·ªã Tr√≠ Column -->
            <td class="vitri-cell">
              <ng-container *ngIf="editingItem?.id !== item.id; else editViTri">
                {{ item.viTri }}
              </ng-container>
              <ng-template #editViTri>
                <input type="text" 
                       [(ngModel)]="editingItem.viTri" 
                       (input)="onViTriInputChange($event, true)"
                       [class.valid]="editingItem.viTri && validateViTriInput(editingItem.viTri)"
                       [class.invalid]="editingItem.viTri && !validateViTriInput(editingItem.viTri)"
                       class="edit-input"
                       placeholder="Nh·∫≠p v·ªã tr√≠"
                       maxlength="20"
                       title="Ch·ªâ cho ph√©p ch·ªØ c√°i, s·ªë, d·∫•u ch·∫•m (.) v√† d·∫•u g·∫°ch ngang (-)">
                <div class="validation-message" 
                     [class.error]="editingItem.viTri && !validateViTriInput(editingItem.viTri)"
                     [class.success]="editingItem.viTri && validateViTriInput(editingItem.viTri)"
                     *ngIf="editingItem.viTri">
                  <span *ngIf="!validateViTriInput(editingItem.viTri)">
                    ‚ö†Ô∏è Ch·ªâ cho ph√©p ch·ªØ c√°i, s·ªë, d·∫•u ch·∫•m (.) v√† d·∫•u g·∫°ch ngang (-)
                  </span>
                  <span *ngIf="validateViTriInput(editingItem.viTri)">
                    ‚úÖ ƒê·ªãnh d·∫°ng h·ª£p l·ªá
                  </span>
                </div>
              </ng-template>
            </td>
            
                         <!-- QR Code Column -->
             <td class="qr-cell">
               <button class="qr-btn" 
                       (click)="printQRCode(item)"
                       title="T·∫°o QR code cho {{item.viTri}}"
                       *ngIf="editingItem?.id !== item.id">
                 <i class="material-icons">qr_code</i>
               </button>
             </td>
            
            <!-- Actions Column -->
            <td class="actions-cell">
              <ng-container *ngIf="editingItem?.id !== item.id; else editActions">
                <button class="edit-btn" 
                        (click)="editLocationItem(item)"
                        title="S·ª≠a {{item.viTri}}">
                  <i class="material-icons">edit</i>
                </button>
              </ng-container>
              <ng-template #editActions>
                <button class="save-btn" 
                        (click)="saveEditedItem()"
                        title="L∆∞u thay ƒë·ªïi">
                  <i class="material-icons">save</i>
                </button>
                <button class="cancel-btn" 
                        (click)="cancelEdit()"
                        title="H·ªßy b·ªè">
                  <i class="material-icons">cancel</i>
                </button>
              </ng-template>
            </td>
            
            <!-- Delete Column -->
            <td class="delete-cell">
              <button class="delete-btn" 
                      (click)="deleteLocationItem(item)"
                      title="X√≥a {{item.viTri}}">
                <i class="material-icons">delete</i>
                <span class="delete-text">X</span>
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="!searchTerm && filteredItems.length === 0 && !isLoading">
        <div class="empty-state-content">
          <i class="material-icons">location_off</i>
          <h3>üìç Ch∆∞a c√≥ v·ªã tr√≠ n√†o</h3>
          <p>H√£y th√™m v·ªã tr√≠ m·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω</p>
          
          <!-- Quick Stats -->
          <div class="quick-stats">
            <div class="stat-item">
              <i class="material-icons">add_location</i>
              <span>Th√™m V·ªã Tr√≠</span>
            </div>
            <div class="stat-item">
              <i class="material-icons">qr_code</i>
              <span>QR T·ª± ƒê·ªông</span>
            </div>
            <div class="stat-item">
              <i class="material-icons">print</i>
              <span>In Tem QR</span>
            </div>
          </div>
        </div>
      </div>

      <!-- No Search Results -->
      <div class="no-results" *ngIf="searchTerm && filteredItems.length === 0 && !isLoading">
        <div class="no-results-content">
          <i class="material-icons">search_off</i>
          <h4>üîç Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h4>
          <p>Kh√¥ng t√¨m th·∫•y v·ªã tr√≠ n√†o cho "<strong>{{searchTerm}}</strong>"</p>
          
          <!-- Search Tips -->
          <div class="search-tips">
            <h6>üí° M·∫πo t√¨m ki·∫øm:</h6>
            <ul>
              <li>Ki·ªÉm tra ch√≠nh t·∫£</li>
              <li>Th·ª≠ t√¨m ki·∫øm v·ªõi √≠t k√Ω t·ª± h∆°n</li>
              <li>Th·ª≠ t√¨m ki·∫øm theo STT ho·∫∑c v·ªã tr√≠</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading-state" *ngIf="isLoading">
        <div class="loading-content">
          <i class="material-icons rotating">sync</i>
          <h4>üîç ƒêang t√¨m ki·∫øm...</h4>
          <p>T√¨m ki·∫øm "<strong>{{searchTerm}}</strong>" trong Location</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Change Location Modal -->
<div class="modal-overlay" *ngIf="showChangeLocationModal" (click)="closeChangeLocationModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üîÑ Thay ƒê·ªïi V·ªã Tr√≠</h3>
      <button class="close-btn" (click)="closeChangeLocationModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <!-- Step 1: Choose Scanner Type -->
      <div class="step-container" *ngIf="changeLocationStep === 1">
        <h4>Ch·ªçn lo·∫°i qu√©t:</h4>
        <div class="scanner-options">
          <button class="scanner-option-btn" (click)="selectScannerType('camera')">
            <i class="material-icons">camera_alt</i>
            <span>Camera</span>
          </button>
          <button class="scanner-option-btn" (click)="selectScannerType('scanner')">
            <i class="material-icons">qr_code_scanner</i>
            <span>Scanner</span>
          </button>
        </div>
      </div>
      
      <!-- Step 2: Scan Material Code -->
      <div class="step-container" *ngIf="changeLocationStep === 2">
        <h4>B∆∞·ªõc 1: Qu√©t m√£ h√†ng</h4>
        
        <!-- QR Scanner View -->
        <div class="scanner-container" *ngIf="selectedScannerType === 'camera'">
          <div class="scanner-wrapper">
            <div id="material-scanner-container" class="scanner-video-container">
              <!-- QR Scanner will be injected here -->
            </div>
            
            <!-- Scanner Ready Status -->
            <div class="scanner-ready-overlay" *ngIf="isScannerReady && !isActivelyScanningMaterial && !materialScanCompleted">
              <div class="ready-content">
                <i class="material-icons">qr_code_scanner</i>
                <p>Camera s·∫µn s√†ng</p>
              </div>
            </div>
            
            <!-- Actively Scanning -->
            <div class="scanner-overlay" *ngIf="isActivelyScanningMaterial">
              <div class="scan-frame">
                <div class="scan-corners">
                  <div class="corner top-left"></div>
                  <div class="corner top-right"></div>
                  <div class="corner bottom-left"></div>
                  <div class="corner bottom-right"></div>
                </div>
                <p class="scan-instruction">ƒê∆∞a m√£ QR/Barcode v√†o khung</p>
              </div>
            </div>
            
            <div class="scanner-loading" *ngIf="scannerState === 'starting'">
              <i class="material-icons">camera_alt</i>
              <p>ƒêang kh·ªüi t·∫°o camera...</p>
            </div>
            <div class="scanner-error" *ngIf="scannerState === 'error'">
              <i class="material-icons">error</i>
              <p>{{ errorMessage }}</p>
              <button class="retry-btn" (click)="startMaterialScanning()">
                <i class="material-icons">refresh</i>
                <span>Th·ª≠ l·∫°i</span>
              </button>
            </div>
          </div>
          
          <!-- Scanner Controls -->
          <div class="scanner-controls" *ngIf="isScannerReady">
            <button class="scanner-btn scan-btn" (click)="startMaterialScan()" 
                    *ngIf="!isActivelyScanningMaterial && !materialScanCompleted">
              <i class="material-icons">qr_code</i>
              <span>Scan m√£ h√†ng</span>
            </button>
            <button class="scanner-btn stop-btn" (click)="stopScanning()" *ngIf="isActivelyScanningMaterial">
              <i class="material-icons">stop</i>
              <span>D·ª´ng Scan</span>
            </button>
            <button class="scanner-btn close-btn" (click)="closeChangeLocationModal()">
              <i class="material-icons">close</i>
              <span>ƒê√≥ng</span>
            </button>
          </div>
        </div>
        
        <!-- Scanner Input -->
        <div class="scan-input-container" *ngIf="selectedScannerType === 'scanner'">
          <input type="text" 
                 id="materialInput"
                 [(ngModel)]="scannedMaterialCode" 
                 (keyup.enter)="processMaterialCode()"
                 placeholder="Qu√©t ho·∫∑c nh·∫≠p m√£ h√†ng"
                 class="scan-input"
                 #materialInput>
          <button class="scan-btn" (click)="processMaterialCode()">
            <i class="material-icons">check</i>
          </button>
        </div>
        
        <!-- Material Scan Results -->
        <div class="material-scan-results" *ngIf="materialScanCompleted && foundRM1Item">
          <div class="success-header">
            <i class="material-icons success-icon">check_circle</i>
            <h5>‚úÖ ƒê√£ qu√©t th√†nh c√¥ng m√£ h√†ng!</h5>
          </div>
          
          <div class="scanned-info-card">
            <h6>üìã Th√¥ng tin ƒë√£ qu√©t:</h6>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">M√£ h√†ng:</span>
                <span class="value">{{ foundRM1Item.parsedData?.materialCode || foundRM1Item.materialCode }}</span>
              </div>
              <div class="info-item">
                <span class="label">PO:</span>
                <span class="value">{{ foundRM1Item.parsedData?.poNumber || foundRM1Item.poNumber || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <span class="label">IMD:</span>
                <span class="value">{{ foundRM1Item.parsedData?.imd || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <span class="label">V·ªã tr√≠ hi·ªán t·∫°i:</span>
                <span class="value location-highlight">{{ currentLocation }}</span>
              </div>
            </div>
          </div>
          
          <div class="next-action">
            <button class="next-step-btn" (click)="proceedToLocationScan()">
              <i class="material-icons">location_on</i>
              Scan v·ªã tr√≠ m·ªõi
            </button>
          </div>
        </div>
      </div>
      
      <!-- Step 3: Scan New Location -->
      <div class="step-container" *ngIf="changeLocationStep === 3">
        <h4>B∆∞·ªõc 2: Qu√©t v·ªã tr√≠ m·ªõi</h4>
        
        <!-- Location QR Scanner View -->
        <div class="scanner-container" *ngIf="selectedScannerType === 'camera'">
          <div class="scanner-wrapper">
            <div id="location-scanner-container" class="scanner-video-container">
              <!-- QR Scanner will be injected here -->
            </div>
            
            <!-- Scanner Ready Status -->
            <div class="scanner-ready-overlay" *ngIf="isScannerReady && !isActivelyScanningLocation && !locationScanCompleted">
              <div class="ready-content">
                <i class="material-icons">place</i>
                <p>Camera s·∫µn s√†ng</p>
              </div>
            </div>
            
            <!-- Actively Scanning Location -->
            <div class="scanner-overlay" *ngIf="isActivelyScanningLocation">
              <div class="scan-frame">
                <div class="scan-corners">
                  <div class="corner top-left"></div>
                  <div class="corner top-right"></div>
                  <div class="corner bottom-left"></div>
                  <div class="corner bottom-right"></div>
                </div>
                <p class="scan-instruction">ƒê∆∞a m√£ v·ªã tr√≠ v√†o khung</p>
              </div>
            </div>
            
            <div class="scanner-loading" *ngIf="scannerState === 'starting'">
              <i class="material-icons">camera_alt</i>
              <p>ƒêang kh·ªüi t·∫°o camera...</p>
            </div>
            <div class="scanner-error" *ngIf="scannerState === 'error'">
              <i class="material-icons">error</i>
              <p>{{ errorMessage }}</p>
              <button class="retry-btn" (click)="startLocationScanning()">
                <i class="material-icons">refresh</i>
                <span>Th·ª≠ l·∫°i</span>
              </button>
            </div>
          </div>
          
          <!-- Scanner Controls -->
          <div class="scanner-controls" *ngIf="isScannerReady">
            <button class="scanner-btn scan-btn" (click)="startLocationScan()" 
                    *ngIf="!isActivelyScanningLocation && !locationScanCompleted">
              <i class="material-icons">qr_code_scanner</i>
              <span>Scan v·ªã tr√≠</span>
            </button>
            <button class="scanner-btn stop-btn" (click)="stopLocationScan()" *ngIf="isActivelyScanningLocation">
              <i class="material-icons">stop</i>
              <span>D·ª´ng Scan</span>
            </button>
            <button class="scanner-btn back-btn" (click)="goBackToMaterialScan()">
              <i class="material-icons">arrow_back</i>
              <span>Quay l·∫°i</span>
            </button>
          </div>
        </div>
        
        <!-- Location Scanner Input -->
        <div class="scan-input-container" *ngIf="selectedScannerType === 'scanner'">
          <input type="text" 
                 id="locationInput"
                 [(ngModel)]="scannedNewLocation" 
                 (keyup.enter)="processNewLocation()"
                 placeholder="Qu√©t ho·∫∑c nh·∫≠p v·ªã tr√≠ m·ªõi"
                 class="scan-input"
                 #locationInput>
          <button class="scan-btn" 
                  (click)="processNewLocation()"
                  [disabled]="!canProcessNewLocation"
                  [class.disabled]="!canProcessNewLocation"
                  title="C·∫ßn c√≥ ƒë·ªß M√£ h√†ng, PO, v√† IMD ƒë·ªÉ ti·∫øp t·ª•c">
            <i class="material-icons">check</i>
          </button>
        </div>
        <div class="scan-info">
          <div *ngIf="foundRM1Item?.parsedData" class="parsed-info">
            <p>M√£ h√†ng: <strong>{{ foundRM1Item.parsedData.materialCode }}</strong></p>
            <p *ngIf="foundRM1Item.parsedData.poNumber">PO: <strong>{{ foundRM1Item.parsedData.poNumber }}</strong></p>
            <p *ngIf="foundRM1Item.parsedData.imd">IMD: <strong>{{ foundRM1Item.parsedData.imd }}</strong></p>
            <p *ngIf="foundRM1Item.parsedData.quantity">S·ªë l∆∞·ª£ng: <strong>{{ foundRM1Item.parsedData.quantity }}</strong></p>
          </div>
          <div *ngIf="!foundRM1Item?.parsedData && foundRM1Item">
            <p>M√£ h√†ng: <strong>{{ foundRM1Item.materialCode }}</strong></p>
            <p *ngIf="foundRM1Item?.poNumber">PO: <strong>{{ foundRM1Item.poNumber }}</strong></p>
            <p *ngIf="foundRM1Item?.importDate">IMD: <strong>{{ foundRM1Item.importDate }}</strong></p>
          </div>
          <p>V·ªã tr√≠ hi·ªán t·∫°i: <strong>{{ currentLocation }}</strong></p>
          <p>V·ªã tr√≠ m·ªõi: <strong>{{ scannedNewLocation }}</strong></p>
        </div>
      </div>
      
      <!-- Step 4: Confirmation -->
      <div class="step-container" *ngIf="changeLocationStep === 4">
        <h4>X√°c nh·∫≠n thay ƒë·ªïi</h4>
        <div class="confirmation-info">
          <div class="info-item" *ngIf="foundRM1Item?.parsedData">
            <span class="label">M√£ h√†ng:</span>
            <span class="value">{{ foundRM1Item.parsedData.materialCode }}</span>
          </div>
          <div class="info-item" *ngIf="!foundRM1Item?.parsedData && foundRM1Item">
            <span class="label">M√£ h√†ng:</span>
            <span class="value">{{ foundRM1Item.materialCode }}</span>
          </div>
          <div class="info-item" *ngIf="foundRM1Item?.parsedData?.poNumber">
            <span class="label">PO:</span>
            <span class="value">{{ foundRM1Item.parsedData.poNumber }}</span>
          </div>
          <div class="info-item" *ngIf="!foundRM1Item?.parsedData && foundRM1Item?.poNumber">
            <span class="label">PO:</span>
            <span class="value">{{ foundRM1Item.poNumber }}</span>
          </div>
          <div class="info-item" *ngIf="foundRM1Item?.parsedData?.imd">
            <span class="label">IMD:</span>
            <span class="value">{{ foundRM1Item.parsedData.imd }}</span>
          </div>
          <div class="info-item" *ngIf="!foundRM1Item?.parsedData && foundRM1Item?.importDate">
            <span class="label">IMD:</span>
            <span class="value">{{ foundRM1Item.importDate }}</span>
          </div>
          <div class="info-item" *ngIf="foundRM1Item?.parsedData?.quantity">
            <span class="label">S·ªë l∆∞·ª£ng:</span>
            <span class="value">{{ foundRM1Item.parsedData.quantity }}</span>
          </div>
          <div class="info-item">
            <span class="label">V·ªã tr√≠ c≈©:</span>
            <span class="value">{{ currentLocation }}</span>
          </div>
          <div class="info-item">
            <span class="label">V·ªã tr√≠ m·ªõi:</span>
            <span class="value">{{ scannedNewLocation }}</span>
          </div>
        </div>
        <div class="confirmation-actions">
          <button class="confirm-btn" (click)="confirmLocationChange()">
            <i class="material-icons">check</i>
            X√°c nh·∫≠n
          </button>
          <button class="cancel-btn" (click)="resetChangeLocation()">
            <i class="material-icons">cancel</i>
            H·ªßy
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Success Notification -->
<div class="success-notification" *ngIf="showSuccessNotification" [@slideIn]>
  <div class="notification-content">
    <i class="material-icons">check_circle</i>
    <span>{{ successMessage }}</span>
  </div>
</div>

<!-- Store Material Modal (C·∫•t NVL) -->
<div class="modal-overlay" *ngIf="showStoreMaterialModal" (click)="closeStoreMaterialModal()">
  <div class="modal-content store-material-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="material-icons">inventory</i>
        C·∫•t Nguy√™n V·∫≠t Li·ªáu
      </h3>
      <button class="close-btn" (click)="closeStoreMaterialModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <!-- Step 1: Scan QR -->
      <div *ngIf="storeMaterialStep === 'scan'" class="store-step">
        <div class="step-title">
          <h4>B∆∞·ªõc 1: Scan m√£ QR m√£ h√†ng c·∫ßn c·∫•t</h4>
        </div>
        
        <div class="scan-input-container">
          <input 
            type="text" 
            id="storeMaterialQRInput"
            [(ngModel)]="storeMaterialQRInput"
            (keyup.enter)="processStoreMaterialQR()"
            placeholder="Qu√©t ho·∫∑c nh·∫≠p m√£ QR..."
            class="scan-input"
            autofocus
            [disabled]="isSearchingMaterial">
          
          <button 
            class="scan-btn"
            (click)="processStoreMaterialQR()"
            [disabled]="isSearchingMaterial || !storeMaterialQRInput.trim()">
            <i class="material-icons">{{ isSearchingMaterial ? 'hourglass_empty' : 'qr_code_scanner' }}</i>
            {{ isSearchingMaterial ? 'ƒêang t√¨m...' : 'T√¨m ki·∫øm' }}
          </button>
        </div>
        
        <div *ngIf="isSearchingMaterial" class="loading-indicator">
          <div class="spinner"></div>
          <span>ƒêang t√¨m ki·∫øm material...</span>
        </div>
      </div>


      <!-- Step 2: Choose Target Location -->
      <div *ngIf="storeMaterialStep === 'choose-location'" class="store-step">
        <div class="step-title">
          <h4>B∆∞·ªõc 2: Ch·ªçn v·ªã tr√≠ ƒë√≠ch</h4>
          <p class="step-description" *ngIf="selectedMaterialForStore">
            Material: <strong>{{ selectedMaterialForStore.materialCode }}</strong> (PO: {{ selectedMaterialForStore.poNumber }})
          </p>
        </div>
        
        <!-- Material Info -->
        <div class="material-info-card" *ngIf="selectedMaterialForStore">
          <div class="info-row">
            <span class="label">M√£ h√†ng:</span>
            <span class="value">{{ selectedMaterialForStore.materialCode }}</span>
          </div>
          <div class="info-row">
            <span class="label">PO:</span>
            <span class="value">{{ selectedMaterialForStore.poNumber }}</span>
          </div>
          <div class="info-row">
            <span class="label">V·ªã tr√≠ hi·ªán t·∫°i:</span>
            <span class="value highlight-current">{{ selectedMaterialForStore.location || 'Ch∆∞a c√≥' }}</span>
          </div>
          <div class="info-row">
            <span class="label">T·ªìn kho:</span>
            <span class="value">{{ selectedMaterialForStore.stock | number:'1.0-2' }}</span>
          </div>
        </div>
        
        <!-- All Current Locations (clickable) -->
        <div class="other-locations-section" *ngIf="suggestedLocations.length > 0">
          <p class="locations-title">üìç C√°c v·ªã tr√≠ hi·ªán c√≥ c·ªßa m√£ h√†ng n√†y (b·∫•m ƒë·ªÉ ch·ªçn):</p>
          <div class="location-options">
            <button 
              *ngFor="let loc of suggestedLocations"
              class="location-option-btn"
              [class.selected]="selectedTargetLocation === loc"
              [class.current-location]="selectedMaterialForStore?.location === loc"
              (click)="selectedTargetLocation = loc">
              {{ loc }}
              <span *ngIf="selectedMaterialForStore?.location === loc" class="current-badge">(hi·ªán t·∫°i)</span>
            </button>
          </div>
        </div>
        
        <div class="custom-location-input">
          <label>Ho·∫∑c nh·∫≠p/scan v·ªã tr√≠ m·ªõi:</label>
          <input 
            type="text" 
            id="targetLocationInput"
            [(ngModel)]="selectedTargetLocation"
            (keyup.enter)="confirmStoreMaterial()"
            placeholder="Nh·∫≠p ho·∫∑c scan v·ªã tr√≠ m·ªõi..."
            class="location-input"
            autofocus>
        </div>
      </div>

      <!-- Step 4: Confirm -->
      <div *ngIf="storeMaterialStep === 'confirm'" class="store-step">
        <div class="step-title">
          <h4>B∆∞·ªõc 4: X√°c nh·∫≠n</h4>
        </div>
        
        <div class="confirm-info" *ngIf="selectedMaterialForStore">
          <div class="info-row">
            <span class="label">M√£ h√†ng:</span>
            <span class="value">{{ selectedMaterialForStore.materialCode }}</span>
          </div>
          <div class="info-row">
            <span class="label">PO:</span>
            <span class="value">{{ selectedMaterialForStore.poNumber }}</span>
          </div>
          <div class="info-row">
            <span class="label">V·ªã tr√≠ hi·ªán t·∫°i:</span>
            <span class="value">{{ selectedMaterialForStore.location || 'Ch∆∞a c√≥' }}</span>
          </div>
          <div class="info-row">
            <span class="label">V·ªã tr√≠ m·ªõi:</span>
            <span class="value highlight">{{ selectedTargetLocation }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="closeStoreMaterialModal()">
        <i class="material-icons">close</i>
        H·ªßy
      </button>
      <button 
        *ngIf="storeMaterialStep === 'choose-location'"
        class="btn btn-confirm"
        (click)="confirmStoreMaterial()"
        [disabled]="!selectedTargetLocation.trim()">
        <i class="material-icons">check</i>
        X√°c nh·∫≠n
      </button>
    </div>
  </div>
</div>

<!-- FG Location Modal -->
<div class="modal-overlay" *ngIf="showFGModal" (click)="closeFGModal()">
  <div class="modal-content fg-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h4>
        <i class="material-icons">check_circle_outline</i>
        Danh m·ª•c V·ªã tr√≠ Th√†nh ph·∫©m (FG)
      </h4>
      <button class="close-btn" (click)="closeFGModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <!-- Search Box -->
      <div class="search-box">
        <i class="material-icons">search</i>
        <input 
          type="text" 
          placeholder="T√¨m ki·∫øm v·ªã tr√≠ FG..."
          [(ngModel)]="fgSearchTerm"
          (input)="onFGSearchInput($event)"
          class="search-input">
        <button class="clear-search-btn" *ngIf="fgSearchTerm" (click)="clearFGSearch()">
          <i class="material-icons">clear</i>
        </button>
      </div>
      
      <!-- FG Locations Table -->
      <div class="table-container">
        <table class="fg-table">
          <thead>
            <tr>
              <th>STT</th>
              <th>V·ªã tr√≠</th>
              <th>QR Code</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of filteredFGLocations; trackBy: trackByFG">
              <td>{{ item.stt }}</td>
              <td>{{ item.viTri }}</td>
              <td>{{ item.qrCode }}</td>
            </tr>
            <tr *ngIf="filteredFGLocations.length === 0">
              <td colspan="3" class="no-data">
                <i class="material-icons">info</i>
                Kh√¥ng t√¨m th·∫•y v·ªã tr√≠ FG n√†o
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Total Count -->
      <div class="total-info">
        <span>T·ªïng: {{ filteredFGLocations.length }} v·ªã tr√≠ FG</span>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="closeFGModal()">
        <i class="material-icons">close</i>
        ƒê√≥ng
      </button>
    </div>
  </div>
</div>

<!-- Customer Modal -->
<div class="modal-overlay" *ngIf="showCustomerModal" (click)="closeCustomerModal()">
  <div class="modal-content customer-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h4>
        <i class="material-icons">people</i>
        Danh s√°ch M√£ Kh√°ch H√†ng
      </h4>
      <button class="close-btn" (click)="closeCustomerModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <!-- Search Box -->
      <div class="search-box">
        <i class="material-icons">search</i>
        <input 
          type="text" 
          placeholder="T√¨m ki·∫øm m√£ kh√°ch h√†ng..."
          [(ngModel)]="customerSearchTerm"
          (input)="onCustomerSearchInput($event)"
          class="search-input">
        <button class="clear-search-btn" *ngIf="customerSearchTerm" (click)="clearCustomerSearch()">
          <i class="material-icons">clear</i>
        </button>
      </div>
      
      <!-- Customer Codes Table -->
      <div class="table-container">
        <table class="customer-table">
          <thead>
            <tr>
              <th>No</th>
              <th>Customer</th>
              <th>Group</th>
              <th>Code</th>
              <th>Label</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let customer of filteredCustomerCodes">
              <td>{{ customer.no }}</td>
              <td>{{ customer.customer }}</td>
              <td>{{ customer.group }}</td>
              <td>{{ customer.code }}</td>
              <td>
                <button class="label-btn" (click)="printCustomerLabel(customer)" title="In tem">
                  <i class="material-icons">print</i>
                  Label
                </button>
              </td>
            </tr>
            <tr *ngIf="filteredCustomerCodes.length === 0">
              <td colspan="5" class="no-data">
                <i class="material-icons">info</i>
                Kh√¥ng t√¨m th·∫•y m√£ kh√°ch h√†ng n√†o
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Total Count -->
      <div class="total-info">
        <span>T·ªïng: {{ filteredCustomerCodes.length }} m√£ kh√°ch h√†ng</span>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="closeCustomerModal()">
        <i class="material-icons">close</i>
        ƒê√≥ng
      </button>
    </div>
  </div>
</div>
