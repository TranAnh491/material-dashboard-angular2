<div class="main-content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-body">
            
            <!-- Import Section -->
            <div class="import-section" *ngIf="selectedFunction === 'import'">
              <h4 class="section-title">
                <i class="material-icons">upload_file</i> ƒêi·ªÅu ch·ªânh Work Orders
              </h4>
              
              <div class="import-controls">
                <div class="file-input-container">
                  <input type="file" 
                         id="excelFileInput" 
                         accept=".xlsx,.xls" 
                         (change)="onFileSelected($event)" 
                         style="display: none;">
                  <label for="excelFileInput" class="btn btn-primary">
                    <i class="material-icons">file_upload</i> Ch·ªçn file Excel
                  </label>
                  <button class="btn btn-outline-info" (click)="showTimeRangeDialog = true">
                    <i class="material-icons">schedule</i> Ch·ªçn th·ªùi gian
                  </button>
                  <button class="btn btn-outline-success" (click)="exportWorkOrdersByTimeRange()">
                    <i class="material-icons">download</i> T·∫£i v·ªÅ
                  </button>
                  <button class="btn btn-outline-primary" (click)="downloadTemplate()">
                    <i class="material-icons">download</i> T·∫£i Form
                  </button>
                  <button mat-raised-button color="accent" (click)="showAllWorkOrders()" class="btn btn-outline-warning">
                    <mat-icon>visibility</mat-icon> Hi·ªÉn th·ªã t·∫•t c·∫£
                  </button>
                </div>
                
                <div class="import-info">
                  <p>üí° H∆∞·ªõng d·∫´n:</p>
                  <ul>
                    <li>File Excel ph·∫£i c√≥ header: NƒÉm, Th√°ng, S·ªë th·ª© t·ª±, M√£ s·∫£n ph·∫©m, L·ªánh s·∫£n xu·∫•t, S·ªë l∆∞·ª£ng, Kh√°ch h√†ng, Ng√†y giao h√†ng, Line s·∫£n xu·∫•t, Tr·∫°ng th√°i, Ng∆∞·ªùi t·∫°o, Ng√†y nh·∫≠n k·∫ø ho·∫°ch, Ghi ch√∫</li>
                    <li>D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c n·ªëi ti·∫øp v·ªõi d·ªØ li·ªáu hi·ªán c√≥ (kh√¥ng ghi ƒë√®)</li>
                    <li>File t·ªëi ƒëa 10MB</li>
                  </ul>
                </div>
                
                <div class="firebase-status" *ngIf="firebaseSaved">
                  <span class="status-success">‚úÖ ƒê√£ l∆∞u v√†o Firebase</span>
                </div>
                
                <div class="loading-indicator" *ngIf="isSaving">
                  <div class="spinner"></div>
                  <span>ƒêang l∆∞u v√†o Firebase...</span>
                </div>
                
                <div class="loading-indicator" *ngIf="isLoading">
                  <div class="spinner"></div>
                  <span>ƒêang x·ª≠ l√Ω file Excel...</span>
                </div>
              </div>
            </div>
            
            <!-- Summary Cards -->
            <div class="row summary-row">
              <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card card-stats compact-stats summary-card">
                  <div class="card-header">
                    <p class="card-category">Total Orders</p>
                    <h3 class="card-title">{{totalOrders}}</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card card-stats compact-stats summary-card">
                  <div class="card-header">
                    <p class="card-category">Waiting</p>
                    <h3 class="card-title">{{waitingOrders}}</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card card-stats compact-stats summary-card">
                  <div class="card-header">
                    <p class="card-category">Kitting</p>
                    <h3 class="card-title">{{kittingOrders}}</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card card-stats compact-stats summary-card">
                  <div class="card-header">
                    <p class="card-category">Ready</p>
                    <h3 class="card-title">{{readyOrders}}</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card card-stats compact-stats summary-card">
                  <div class="card-header">
                    <p class="card-category">Done</p>
                    <h3 class="card-title">{{doneOrders}}</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card card-stats compact-stats summary-card">
                  <div class="card-header">
                    <p class="card-category">Delay</p>
                    <h3 class="card-title">{{delayOrders}}</h3>
                  </div>
                </div>
              </div>
            </div>

            <!-- Factory Selection -->
            <div class="row function-selection-row">
              <div class="col-md-12">
                <div class="function-buttons">
                  <button class="btn btn-outline-primary" 
                          [class.active]="selectedFactory === 'ASM1'"
                          (click)="selectFactory('ASM1')"
                          style="color: #1976d2; border: none;"
                          [style.background]="selectedFactory === 'ASM1' ? '#fce4ec' : 'transparent'">
                    <i class="material-icons">factory</i> ASM1
                  </button>
                  <button class="btn btn-outline-primary" 
                          [class.active]="selectedFactory === 'ASM2'"
                          (click)="selectFactory('ASM2')"
                          style="color: #4caf50; border: none;"
                          [style.background]="selectedFactory === 'ASM2' ? '#fce4ec' : 'transparent'">
                    <i class="material-icons">factory</i> ASM2
                  </button>
                  <button class="btn btn-outline-primary" 
                          [class.active]="selectedFactory === 'Sample 1'"
                          (click)="selectFactory('Sample 1')"
                          style="color: #1976d2; border: none;"
                          [style.background]="selectedFactory === 'Sample 1' ? '#fce4ec' : 'transparent'">
                    <i class="material-icons">factory</i> Sample 1
                  </button>
                  <button class="btn btn-outline-primary" 
                          [class.active]="selectedFactory === 'Sample 2'"
                          (click)="selectFactory('Sample 2')"
                          style="color: #4caf50; border: none;"
                          [style.background]="selectedFactory === 'Sample 2' ? '#fce4ec' : 'transparent'">
                    <i class="material-icons">factory</i> Sample 2
                  </button>
                  <button class="btn btn-outline-primary" 
                          [class.active]="selectedFunction === 'import'"
                          (click)="selectFunction('import')"
                          style="color: #000; border: none;"
                          [style.background]="selectedFunction === 'import' ? '#fce4ec' : 'transparent'">
                    <i class="material-icons">more_horiz</i> MORE
                  </button>
                  <button class="btn btn-outline-primary" 
                          [class.active]="selectedFunction === 'view'"
                          (click)="selectFunction('view')"
                          style="color: #000; border: none;"
                          [style.background]="selectedFunction === 'view' ? '#fce4ec' : 'transparent'">
                    <i class="material-icons">arrow_back</i> BACK
                  </button>
                  <button class="btn btn-outline-danger" 
                          (click)="showDeleteDialog = true"
                          *ngIf="hasDeletePermissionValue"
                          style="color: #f44336; border: none;">
                    <i class="material-icons">delete</i> X√ìA
                  </button>
                </div>
              </div>
            </div>

            <!-- Controls -->
            <div class="row controls-row" *ngIf="selectedFunction === 'view'">
              <div class="col-md-12">
                <div class="card compact-controls">
                  <div class="card-body">
                    <div class="row">
                      <!-- Search -->
                      <div class="col-md-3">
                        <mat-form-field class="full-width compact-field">
                          <mat-label>Search Work Orders</mat-label>
                          <input matInput [(ngModel)]="searchTerm" (input)="onSearchChange()" 
                                 placeholder="Order number, product code, customer">
                          <mat-icon matSuffix>search</mat-icon>
                        </mat-form-field>
                      </div>
                      
                      <!-- Year Filter -->
                      <div class="col-md-2">
                        <mat-form-field class="full-width compact-field">
                          <mat-label>Year</mat-label>
                          <mat-select [(value)]="yearFilter" (selectionChange)="onYearFilterChange()">
                            <mat-option *ngFor="let year of years" [value]="year">{{year}}</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>
                      
                      <!-- Month Filter -->
                      <div class="col-md-2">
                        <mat-form-field class="full-width compact-field">
                          <mat-label>Month</mat-label>
                          <mat-select [(value)]="monthFilter" (selectionChange)="onMonthFilterChange()">
                            <mat-option *ngFor="let month of months" [value]="month.value">{{month.name}}</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>
                      
                      <!-- Status Filter -->
                      <div class="col-md-5">
                        <mat-form-field class="full-width compact-field">
                          <mat-label>Filter by Status</mat-label>
                          <mat-select [(value)]="statusFilter" (selectionChange)="onStatusFilterChange()">
                            <mat-option value="all">All Status</mat-option>
                            <mat-option value="waiting">Waiting</mat-option>
                            <mat-option value="kitting">Kitting</mat-option>
                            <mat-option value="ready">Ready</mat-option>
                            <mat-option value="done">Done</mat-option>
                            <mat-option value="delay">Delay</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
                      </div>
                      


            <!-- Add Work Order Form -->
            <div class="row" *ngIf="isAddingWorkOrder">
              <div class="col-md-12">
                <div class="card compact-form">
                  <div class="card-header card-header-success">
                    <h4 class="card-title">Add New Work Order</h4>
                  </div>
                  <div class="card-body">
                    <form>
                      <div class="row">
                        <div class="col-md-2">
                          <mat-form-field class="full-width">
                            <mat-label>Year</mat-label>
                            <mat-select [(value)]="newWorkOrder.year" required>
                              <mat-option *ngFor="let year of years" [value]="year">{{year}}</mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>
                        <div class="col-md-2">
                          <mat-form-field class="full-width">
                            <mat-label>Month</mat-label>
                            <mat-select [(value)]="newWorkOrder.month" required>
                              <mat-option *ngFor="let month of months" [value]="month.value">{{month.name}}</mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>
                        <div class="col-md-4">
                          <mat-form-field class="full-width">
                            <mat-label>No</mat-label>
                            <input matInput [(ngModel)]="newWorkOrder.orderNumber" name="orderNumber" 
                                   placeholder="Auto-generated if left empty">
                          </mat-form-field>
                        </div>
                        <div class="col-md-4">
                          <mat-form-field class="full-width">
                            <mat-label>P/N</mat-label>
                            <input matInput [(ngModel)]="newWorkOrder.productCode" name="productCode" required>
                          </mat-form-field>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-4">
                          <mat-form-field class="full-width">
                            <mat-label>Work Order</mat-label>
                            <input matInput [(ngModel)]="newWorkOrder.productionOrder" name="productionOrder" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-2">
                          <mat-form-field class="full-width">
                            <mat-label>Quantity</mat-label>
                            <input matInput type="number" [(ngModel)]="newWorkOrder.quantity" name="quantity" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>Customer</mat-label>
                            <input matInput [(ngModel)]="newWorkOrder.customer" name="customer" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>Delivery Date</mat-label>
                            <input matInput [matDatepicker]="deliveryPicker" [(ngModel)]="newWorkOrder.deliveryDate" name="deliveryDate" required>
                            <mat-datepicker-toggle matSuffix [for]="deliveryPicker"></mat-datepicker-toggle>
                            <mat-datepicker #deliveryPicker></mat-datepicker>
                          </mat-form-field>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>Line</mat-label>
                            <mat-select [(value)]="newWorkOrder.productionLine" name="productionLine" required>
                              <mat-option *ngFor="let line of availableLines" [value]="line">{{line}}</mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>Kitting</mat-label>
                            <mat-select [(value)]="newWorkOrder.createdBy" name="createdBy" required>
                              <mat-option *ngFor="let person of availablePersons" [value]="person">{{person}}</mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>Checked By</mat-label>
                            <mat-select [(value)]="newWorkOrder.checkedBy" name="checkedBy">
                              <mat-option value="">None</mat-option>
                              <mat-option *ngFor="let person of availablePersons" [value]="person">{{person}}</mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>Plan Received Date</mat-label>
                            <input matInput [matDatepicker]="planPicker" [(ngModel)]="newWorkOrder.planReceivedDate" name="planReceivedDate" required>
                            <mat-datepicker-toggle matSuffix [for]="planPicker"></mat-datepicker-toggle>
                            <mat-datepicker #planPicker></mat-datepicker>
                          </mat-form-field>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-12">
                          <mat-form-field class="full-width">
                            <mat-label>Notes</mat-label>
                            <textarea matInput [(ngModel)]="newWorkOrder.notes" name="notes" rows="3"></textarea>
                          </mat-form-field>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-12">
                          <button mat-raised-button color="primary" (click)="addNewWorkOrder()" [disabled]="!isValidWorkOrder()">
                            <mat-icon>save</mat-icon> Save Work Order
                          </button>
                          <button mat-raised-button (click)="isAddingWorkOrder = false; resetForm()" class="ml-2">
                            <mat-icon>cancel</mat-icon> Cancel
                          </button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <!-- Work Orders Table -->
            <div class="row table-row">
              <div class="col-md-12">
                <div class="card table-card">
                  <div class="card-body table-responsive table-container">
                    <table class="table table-hover compact-table">
                      <thead class="text-primary">
                        <tr>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 60px; font-size: 13.33px; font-weight: normal;">Nh√† M√°y</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 35px; font-size: 13.33px; font-weight: normal;">NƒÉm</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 35px; font-size: 13.33px; font-weight: normal;">Th√°ng</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 35px; font-size: 13.33px; font-weight: normal;">STT</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 45px; font-size: 13.33px; font-weight: normal;">Ho√†n th√†nh</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 65px; font-size: 13.33px; font-weight: normal;">M√£ TP VN</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 85px; font-size: 13.33px; font-weight: normal;">LSX</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 45px; font-size: 13.33px; font-weight: normal;">L∆∞·ª£ng s·∫£n ph·∫©m</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 55px; font-size: 13.33px; font-weight: normal;">Kh√°ch h√†ng</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 25px; font-size: 13.33px; font-weight: normal;">G·∫•p</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 55px; font-size: 13.33px; font-weight: normal;">Ng√†y Giao NVL</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 45px; font-size: 13.33px; font-weight: normal;">Line</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 55px; font-size: 13.33px; font-weight: normal;">NVL thi·∫øu</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 25px; font-size: 13.33px; font-weight: normal;">Ng∆∞·ªùi so·∫°n</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 25px; font-size: 13.33px; font-weight: normal;">T√¨nh tr·∫°ng</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 45px; font-size: 13.33px; font-weight: normal;">ƒê·ªß/Thi·∫øu</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 55px; font-size: 13.33px; font-weight: normal;">Ng√†y nh·∫≠n th√¥ng tin</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 35px; font-size: 13.33px; font-weight: normal;">Ghi Ch√∫</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 35px; font-size: 13.33px; font-weight: normal;">S·ª≠a</th>
                          <th style="padding: 4px; border: 1px solid #ddd; text-align: center; min-width: 35px; font-size: 13.33px; font-weight: normal;">X√≥a</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let wo of filteredWorkOrders; let i = index" 
                            [class]="getStatusClass(wo.status || 'waiting') + ' ' + getPriorityClass(wo.deliveryDate) + (isSelected(wo) ? ' selected-row' : '') + (wo.isUrgent && wo.status !== 'done' ? ' urgent-row' : '')">
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{wo.factory || selectedFactory}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{wo.year}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{wo.month}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{i + 1}}</td>
                                                    <td style="text-align: center; vertical-align: middle;">
                            <button mat-icon-button color="success"
                                    (click)="completeWorkOrder(wo)"
                                    matTooltip="Ho√†n th√†nh Work Order"
                                    *ngIf="wo.status !== 'done' && canEdit()"
                                    style="width: 36px; height: 36px; min-width: 36px; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                              <mat-icon style="font-size: 24px; width: 24px; height: 24px;">check_circle</mat-icon>
                            </button>
                            <span *ngIf="wo.status !== 'done' && !canEdit()" style="font-size: 10px; color: #999;">Kh√¥ng c√≥ quy·ªÅn</span>
                            <span *ngIf="wo.status === 'done'" style="color: #4caf50; font-size: 20px; display: block; text-align: center;">‚úÖ</span>
                          </td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{wo.productCode}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{wo.productionOrder}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{wo.quantity | number}}</td>
                          <td style="font-size: 11.67px; text-align: center; vertical-align: middle;">{{wo.customer}}</td>
                                                    <td style="text-align: center; vertical-align: middle;">
                            <button mat-icon-button color="warning"
                                    (click)="toggleUrgent(wo)"
                                    matTooltip="ƒê√°nh d·∫•u g·∫•p"
                                    *ngIf="!wo.isUrgent"
                                    style="width: 36px; height: 36px; min-width: 36px; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                              <mat-icon style="font-size: 24px; width: 24px; height: 24px;">priority_high</mat-icon>
                            </button>
                            <span *ngIf="wo.isUrgent" style="color: #666; font-size: 17.5px; display: block; text-align: center;">üî•</span>
                          </td>
                          <td style="text-align: center; vertical-align: middle;">
                            <mat-form-field class="date-field compact-date-field flat-field">
                              <input matInput [matDatepicker]="deliveryPicker" 
                                     [(ngModel)]="wo.deliveryDate" 
                                     (dateChange)="updateWorkOrder(wo, 'deliveryDate', $event.value)"
                                     style="font-size: 11.67px; text-align: center;">
                              <mat-datepicker-toggle matSuffix [for]="deliveryPicker" style="width: 20px; height: 20px;"></mat-datepicker-toggle>
                              <mat-datepicker #deliveryPicker></mat-datepicker>
                            </mat-form-field>
                          </td>
                          <td style="text-align: center; vertical-align: middle;">
                            <span class="badge badge-info" style="font-size: 11.67px; color: #666;">{{wo.productionLine}}</span>
                          </td>
                          <td style="text-align: center; vertical-align: middle;">
                            <mat-form-field class="missing-materials-field compact-missing-materials-field flat-field" *ngIf="canEdit()">
                              <input matInput [value]="wo.missingMaterials || ''" (blur)="updateWorkOrder(wo, 'missingMaterials', $event.target.value)" 
                                     [class.red-text]="wo.missingMaterials"
                                     style="font-size: 11.67px; text-align: center;">
                            </mat-form-field>
                            <span *ngIf="!canEdit()" [class.red-text]="wo.missingMaterials" style="font-size: 10px; color: #666;">{{wo.missingMaterials || 'Ch∆∞a c√≥'}}</span>
                          </td>
                          <td style="text-align: center; vertical-align: middle;">
                            <select [(ngModel)]="wo.createdBy" (change)="updateWorkOrder(wo, 'createdBy', $event.target.value)" 
                                    [disabled]="!canEdit()"
                                    style="width: 100%; padding: 6px; border: none; background: transparent; font-size: 11.67px; text-align: center; cursor: pointer; outline: none;">
                              <option value="">Ch·ªçn ng∆∞·ªùi</option>
                              <option value="Tu·∫•n">Tu·∫•n</option>
                              <option value="T√¨nh">T√¨nh</option>
                              <option value="V≈©">V≈©</option>
                              <option value="Ph√∫c">Ph√∫c</option>
                              <option value="T√∫">T√∫</option>
                              <option value="H∆∞ng">H∆∞ng</option>
                              <option value="To√†n">To√†n</option>
                              <option value="Ninh">Ninh</option>
                            </select>
                            <span *ngIf="!canEdit()" style="font-size: 10px; color: #666;">{{wo.createdBy || 'Ch∆∞a c√≥'}}</span>
                          </td>
                          <td style="text-align: center; vertical-align: middle;">
                            <select [(ngModel)]="wo.status" (change)="updateWorkOrderStatus(wo, $event.target.value)" 
                                    [disabled]="!canEdit()"
                                    style="width: 100%; padding: 6px; border: none; background: transparent; font-size: 11.67px; text-align: center; cursor: pointer; outline: none;">
                              <option value="">Ch·ªçn t√¨nh tr·∫°ng</option>
                              <option value="waiting">Waiting</option>
                              <option value="kitting">Kitting</option>
                              <option value="ready">Ready</option>
                              <option value="done">Done</option>
                              <option value="delay">Delay</option>
                            </select>
                            <span *ngIf="!canEdit()" style="font-size: 10px; color: #666;">{{wo.status || 'Ch∆∞a c√≥'}}</span>
                          </td>
                          <td style="text-align: center; vertical-align: middle;">
                            <select [(ngModel)]="wo.materialsStatus" (change)="updateWorkOrder(wo, 'materialsStatus', $event.target.value); updateWorkOrder(wo, 'materialsComplete', $event.target.value === 'sufficient')" 
                                    [disabled]="!canEdit()"
                                    style="width: 100%; padding: 6px; border: none; background: transparent; font-size: 11.67px; text-align: center; cursor: pointer; outline: none;">
                              <option value="">Ch·ªçn</option>
                              <option value="sufficient">ƒê·ªß</option>
                              <option value="insufficient">Thi·∫øu</option>
                            </select>
                            <span *ngIf="!canEdit()" style="font-size: 10px; color: #666;">{{wo.materialsStatus === 'sufficient' ? 'ƒê·ªß' : wo.materialsStatus === 'insufficient' ? 'Thi·∫øu' : 'Ch∆∞a c√≥'}}</span>
                          </td>
                          <td style="text-align: center; vertical-align: middle;">
                            <mat-form-field class="date-field compact-date-field flat-field" *ngIf="canEdit()">
                              <input matInput [matDatepicker]="planPicker" 
                                     [(ngModel)]="wo.planReceivedDate" 
                                     (dateChange)="updateWorkOrder(wo, 'planReceivedDate', $event.value)"
                                     style="font-size: 11.67px; text-align: center;">
                              <mat-datepicker-toggle matSuffix [for]="planPicker" style="width: 20px; height: 20px;"></mat-datepicker-toggle>
                              <mat-datepicker #planPicker></mat-datepicker>
                            </mat-form-field>
                            <span *ngIf="!canEdit()" style="font-size: 10px; color: #666;">{{wo.planReceivedDate | date:'dd/MM/yyyy' || 'Ch∆∞a c√≥'}}</span>
                          </td>
                          <td style="text-align: center; vertical-align: middle;">
                            <mat-form-field class="notes-field compact-notes-field flat-field" *ngIf="canEdit()">
                              <input matInput [value]="wo.notes || ''" (blur)="updateWorkOrder(wo, 'notes', $event.target.value)" 
                                     [class.red-text]="wo.notes"
                                     style="font-size: 11.67px; text-align: center;">
                            </mat-form-field>
                            <span *ngIf="!canEdit()" [class.red-text]="wo.notes" style="font-size: 10px; color: #666;">{{wo.notes || 'Ch∆∞a c√≥'}}</span>
                          </td>
                          <td style="text-align: center; vertical-align: middle;">
                              <button mat-icon-button color="primary" (click)="editWorkOrder(wo)" 
                                    *ngIf="canEdit()"
                                    matTooltip="Edit Work Order" class="compact-btn"
                                    style="width: 36px; height: 36px; min-width: 36px; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                              <mat-icon style="font-size: 21px; width: 21px; height: 21px;">edit</mat-icon>
                              </button>
                              <span *ngIf="!canEdit()" style="font-size: 10px; color: #999;">Kh√¥ng c√≥ quy·ªÅn</span>
                          </td>
                          <td style="text-align: center; vertical-align: middle;">
                              <button mat-icon-button color="warn" (click)="deleteWorkOrder(wo)" 
                                    *ngIf="hasDeletePermissionValue"
                                    matTooltip="Delete Work Order" class="compact-btn"
                                    style="width: 36px; height: 36px; min-width: 36px; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                              <mat-icon style="font-size: 21px; width: 21px; height: 21px;">delete</mat-icon>
                              </button>
                              <span *ngIf="!hasDeletePermissionValue" style="font-size: 10px; color: #999;">Kh√¥ng c√≥ quy·ªÅn</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                    
                    <div *ngIf="filteredWorkOrders.length === 0" class="no-data">
                      <p>No work orders found for the selected criteria.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Excel Import Dialog -->
            <div class="import-dialog-overlay" *ngIf="showImportDialog" (click)="closeImportDialog()">
              <div class="import-dialog" (click)="$event.stopPropagation()">
                <div class="import-dialog-header">
                  <h4>Import Work Orders from Excel</h4>
                  <button mat-icon-button (click)="closeImportDialog()">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
                
                <div class="import-dialog-content">
                  <!-- Step 1: Download Template -->
                  <div class="import-step">
                    <h5>Step 1: Download Template</h5>
                    <p>Download the Excel template with the correct format:</p>
                    <button mat-raised-button color="primary" (click)="downloadTemplate()">
                      <mat-icon>download</mat-icon> Download Template
                    </button>
                  </div>

                  <!-- Step 2: Upload File -->
                  <div class="import-step">
                    <h5>Step 2: Upload Excel File</h5>
                    <p>Select your Excel file with work order data:</p>
                    
                    <div class="file-upload-area">
                      <input type="file" 
                             #fileInput 
                             accept=".xlsx,.xls" 
                             (change)="onFileSelected($event)"
                             style="display: none;">
                      
                      <button mat-raised-button 
                              color="accent" 
                              (click)="fileInput.click()" 
                              [disabled]="isImporting">
                        <mat-icon>cloud_upload</mat-icon> 
                        {{isImporting ? 'Importing...' : 'Choose Excel File'}}
                      </button>
                    </div>
                  </div>

                  <!-- Progress Bar -->
                  <div class="import-step" *ngIf="isImporting">
                    <h5>Importing...</h5>
                    <mat-progress-bar mode="determinate" [value]="importProgress"></mat-progress-bar>
                    <p class="progress-text">{{importProgress}}% completed</p>
                  </div>

                  <!-- Import Results -->
                  <div class="import-step" *ngIf="importResults">
                    <h5>Import Results</h5>
                    <div class="import-summary">
                      <div class="result-item success" *ngIf="importResults.success > 0">
                        <mat-icon>check_circle</mat-icon>
                        <span>Successfully imported: {{importResults.success}} work orders</span>
                      </div>
                      
                      <div class="result-item error" *ngIf="importResults.failed > 0">
                        <mat-icon>error</mat-icon>
                        <span>Failed to import: {{importResults.failed}} work orders</span>
                      </div>
                    </div>

                    <!-- Error Details -->
                    <div class="error-details" *ngIf="importResults.errors && importResults.errors.length > 0">
                      <h6>Error Details:</h6>
                      <div class="error-list">
                        <div class="error-item" *ngFor="let error of importResults.errors">
                          <strong>Row {{error.row}}:</strong> {{error.error}}
                        </div>
                      </div>
                    </div>

                    <div class="import-actions">
                      <button mat-raised-button color="primary" (click)="closeImportDialog()">
                        <mat-icon>check</mat-icon> Done
                      </button>
                    </div>
                  </div>

                  <!-- Instructions -->
                  <div class="import-instructions">
                    <h6>Excel Format Guidelines:</h6>
                    <ul>
                      <li>Use the provided template for correct column order</li>
                      <li>Year and Month columns must be numbers</li>
                      <li>Quantity must be a positive number</li>
                      <li>Dates should be in Excel date format or YYYY-MM-DD</li>
                      <li>Order Number can be left empty for auto-generation</li>
                      <li>Required fields: Product Code, Production Order, Quantity, Customer, Delivery Date, Production Line, Created By, Plan Received Date</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Time Range Dialog -->
  <div class="time-range-dialog-overlay" *ngIf="showTimeRangeDialog">
    <div class="time-range-dialog">
      <div class="dialog-header">
        <h4>Ch·ªçn kho·∫£ng th·ªùi gian</h4>
        <button mat-icon-button (click)="showTimeRangeDialog = false">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="dialog-content">
        <div class="form-group">
          <label>T·ª´ ng√†y:</label>
          <mat-form-field class="full-width">
            <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate" placeholder="Ch·ªçn ng√†y b·∫Øt ƒë·∫ßu">
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field>
        </div>
        <div class="form-group">
          <label>ƒê·∫øn ng√†y:</label>
          <mat-form-field class="full-width">
            <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate" placeholder="Ch·ªçn ng√†y k·∫øt th√∫c">
            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>
        </div>
        <div class="dialog-actions">
          <button mat-raised-button color="primary" (click)="exportWorkOrdersByTimeRange(); showTimeRangeDialog = false">
            <mat-icon>download</mat-icon> T·∫£i v·ªÅ
          </button>
          <button mat-raised-button (click)="showTimeRangeDialog = false">
            <mat-icon>cancel</mat-icon> H·ªßy
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Time Range Dialog -->
  <div class="modal-overlay" *ngIf="showDeleteDialog" (click)="showDeleteDialog = false">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h4><mat-icon>delete</mat-icon> X√≥a Work Orders theo th·ªùi gian</h4>
        <button class="close-button" (click)="showDeleteDialog = false">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>T·ª´ ng√†y:</label>
          <mat-form-field class="full-width">
            <input matInput [matDatepicker]="deleteStartPicker" [(ngModel)]="deleteStartDate" placeholder="Ch·ªçn ng√†y b·∫Øt ƒë·∫ßu">
            <mat-datepicker-toggle matSuffix [for]="deleteStartPicker"></mat-datepicker-toggle>
            <mat-datepicker #deleteStartPicker></mat-datepicker>
          </mat-form-field>
        </div>
        <div class="form-group">
          <label>ƒê·∫øn ng√†y:</label>
          <mat-form-field class="full-width">
            <input matInput [matDatepicker]="deleteEndPicker" [(ngModel)]="deleteEndDate" placeholder="Ch·ªçn ng√†y k·∫øt th√∫c">
            <mat-datepicker-toggle matSuffix [for]="deleteEndPicker"></mat-datepicker-toggle>
            <mat-datepicker #deleteEndPicker></mat-datepicker>
          </mat-form-field>
        </div>
        <div class="form-group">
          <label>Nh√† m√°y:</label>
          <select [(ngModel)]="deleteFactoryFilter" class="form-control">
            <option value="">T·∫•t c·∫£ nh√† m√°y</option>
            <option value="ASM1">ASM1</option>
            <option value="ASM2">ASM2</option>
            <option value="Sample 1">Sample 1</option>
            <option value="Sample 2">Sample 2</option>
          </select>
        </div>
        <div class="warning-message">
          <mat-icon>warning</mat-icon>
          <p><strong>C·∫£nh b√°o:</strong> Thao t√°c n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn c√°c Work Orders trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn kh·ªèi Firebase. Kh√¥ng th·ªÉ ho√†n t√°c!</p>
        </div>
        <div class="preview-section" *ngIf="deletePreviewItems.length > 0">
          <h5>S·∫Ω x√≥a {{deletePreviewItems.length}} Work Orders:</h5>
          <ul class="delete-preview-list">
            <li *ngFor="let item of deletePreviewItems">
              {{item.orderNumber}} - {{item.productCode}} - {{item.customer}}
            </li>
          </ul>
        </div>
      </div>
      <div class="dialog-actions">
        <button mat-raised-button color="primary" (click)="previewDeleteItems()" [disabled]="!deleteStartDate || !deleteEndDate">
          <mat-icon>preview</mat-icon> Xem tr∆∞·ªõc
        </button>
        <button mat-raised-button color="warn" (click)="deleteWorkOrdersByTimeRange()" 
                [disabled]="deletePreviewItems.length === 0 || isDeleting">
          <mat-icon>delete</mat-icon> 
          <span *ngIf="!isDeleting">X√≥a {{deletePreviewItems.length}} items</span>
          <span *ngIf="isDeleting">ƒêang x√≥a...</span>
        </button>
        <button mat-raised-button (click)="showDeleteDialog = false; deletePreviewItems = []">
          <mat-icon>cancel</mat-icon> H·ªßy
        </button>
      </div>
    </div>
  </div>


</div>
