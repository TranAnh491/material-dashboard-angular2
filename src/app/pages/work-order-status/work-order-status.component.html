<div class="main-content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header card-header-primary">
            <h4 class="card-title">Work Order Management</h4>
            <p class="card-category">Daily Operations - Manage production work orders</p>
          </div>
          <div class="card-body">
            
            <!-- Factory Selection -->
            <div class="row">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Select Factory</h5>
                    <mat-button-toggle-group [(value)]="selectedFactory" (change)="onFactoryChange()" class="factory-toggle">
                      <mat-button-toggle *ngFor="let factory of factories" [value]="factory">
                        {{factory}}
                      </mat-button-toggle>
                    </mat-button-toggle-group>
                  </div>
                </div>
              </div>
            </div>

            <!-- Summary Cards -->
            <div class="row">
              <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="card card-stats">
                  <div class="card-header card-header-warning card-header-icon">
                    <div class="card-icon">
                      <i class="material-icons">assignment</i>
                    </div>
                    <p class="card-category">Total Orders</p>
                    <h3 class="card-title">{{totalOrders}}</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="card card-stats">
                  <div class="card-header card-header-info card-header-icon">
                    <div class="card-icon">
                      <i class="material-icons">pending_actions</i>
                    </div>
                    <p class="card-category">Pending</p>
                    <h3 class="card-title">{{pendingOrders}}</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="card card-stats">
                  <div class="card-header card-header-success card-header-icon">
                    <div class="card-icon">
                      <i class="material-icons">engineering</i>
                    </div>
                    <p class="card-category">In Progress</p>
                    <h3 class="card-title">{{inProgressOrders}}</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="card card-stats">
                  <div class="card-header card-header-rose card-header-icon">
                    <div class="card-icon">
                      <i class="material-icons">task_alt</i>
                    </div>
                    <p class="card-category">Completed</p>
                    <h3 class="card-title">{{completedOrders}}</h3>
                  </div>
                </div>
              </div>
            </div>

            <!-- Controls -->
            <div class="row">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-body">
                    <div class="row">
                      <!-- Search -->
                      <div class="col-md-3">
                        <mat-form-field class="full-width">
                          <mat-label>Search Work Orders</mat-label>
                          <input matInput [(ngModel)]="searchTerm" (input)="onSearchChange()" 
                                 placeholder="Order number, product code, customer">
                          <mat-icon matSuffix>search</mat-icon>
                        </mat-form-field>
                      </div>
                      
                      <!-- Year Filter -->
                      <div class="col-md-2">
                        <mat-form-field class="full-width">
                          <mat-label>Year</mat-label>
                          <mat-select [(value)]="yearFilter" (selectionChange)="onYearFilterChange()">
                            <mat-option *ngFor="let year of years" [value]="year">{{year}}</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>
                      
                      <!-- Month Filter -->
                      <div class="col-md-2">
                        <mat-form-field class="full-width">
                          <mat-label>Month</mat-label>
                          <mat-select [(value)]="monthFilter" (selectionChange)="onMonthFilterChange()">
                            <mat-option *ngFor="let month of months" [value]="month.value">{{month.name}}</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>
                      
                      <!-- Status Filter -->
                      <div class="col-md-3">
                        <mat-form-field class="full-width">
                          <mat-label>Filter by Status</mat-label>
                          <mat-select [(value)]="statusFilter" (selectionChange)="onStatusFilterChange()">
                            <mat-option value="all">All Status</mat-option>
                            <mat-option value="pending">Pending</mat-option>
                            <mat-option value="in_progress">In Progress</mat-option>
                            <mat-option value="on_hold">On Hold</mat-option>
                            <mat-option value="completed">Completed</mat-option>
                            <mat-option value="cancelled">Cancelled</mat-option>
                            <mat-option value="quality_check">Quality Check</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>
                      
                      <!-- Actions -->
                      <div class="col-md-2">
                        <button mat-raised-button color="primary" (click)="isAddingWorkOrder = true" class="btn-block mb-2">
                          <mat-icon>add</mat-icon> Add Work Order
                        </button>
                        <button mat-raised-button color="accent" (click)="openImportDialog()" class="btn-block">
                          <mat-icon>upload_file</mat-icon> Import Excel
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Add Work Order Form -->
            <div class="row" *ngIf="isAddingWorkOrder">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-header card-header-success">
                    <h4 class="card-title">Add New Work Order - {{selectedFactory}}</h4>
                  </div>
                  <div class="card-body">
                    <form>
                      <div class="row">
                        <div class="col-md-2">
                          <mat-form-field class="full-width">
                            <mat-label>Year</mat-label>
                            <mat-select [(value)]="newWorkOrder.year" required>
                              <mat-option *ngFor="let year of years" [value]="year">{{year}}</mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>
                        <div class="col-md-2">
                          <mat-form-field class="full-width">
                            <mat-label>Month</mat-label>
                            <mat-select [(value)]="newWorkOrder.month" required>
                              <mat-option *ngFor="let month of months" [value]="month.value">{{month.name}}</mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>
                        <div class="col-md-4">
                          <mat-form-field class="full-width">
                            <mat-label>Order Number</mat-label>
                            <input matInput [(ngModel)]="newWorkOrder.orderNumber" name="orderNumber" 
                                   placeholder="Auto-generated if left empty">
                          </mat-form-field>
                        </div>
                        <div class="col-md-4">
                          <mat-form-field class="full-width">
                            <mat-label>Product Code</mat-label>
                            <input matInput [(ngModel)]="newWorkOrder.productCode" name="productCode" required>
                          </mat-form-field>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-4">
                          <mat-form-field class="full-width">
                            <mat-label>Production Order</mat-label>
                            <input matInput [(ngModel)]="newWorkOrder.productionOrder" name="productionOrder" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-2">
                          <mat-form-field class="full-width">
                            <mat-label>Quantity</mat-label>
                            <input matInput type="number" [(ngModel)]="newWorkOrder.quantity" name="quantity" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>Customer</mat-label>
                            <input matInput [(ngModel)]="newWorkOrder.customer" name="customer" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>Delivery Date</mat-label>
                            <input matInput [matDatepicker]="deliveryPicker" [(ngModel)]="newWorkOrder.deliveryDate" name="deliveryDate" required>
                            <mat-datepicker-toggle matSuffix [for]="deliveryPicker"></mat-datepicker-toggle>
                            <mat-datepicker #deliveryPicker></mat-datepicker>
                          </mat-form-field>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>Production Line</mat-label>
                            <mat-select [(value)]="newWorkOrder.productionLine" name="productionLine" required>
                              <mat-option *ngFor="let line of availableLines" [value]="line">{{line}}</mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>Created By</mat-label>
                            <input matInput [(ngModel)]="newWorkOrder.createdBy" name="createdBy" required>
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>Checked By</mat-label>
                            <input matInput [(ngModel)]="newWorkOrder.checkedBy" name="checkedBy">
                          </mat-form-field>
                        </div>
                        <div class="col-md-3">
                          <mat-form-field class="full-width">
                            <mat-label>Plan Received Date</mat-label>
                            <input matInput [matDatepicker]="planPicker" [(ngModel)]="newWorkOrder.planReceivedDate" name="planReceivedDate" required>
                            <mat-datepicker-toggle matSuffix [for]="planPicker"></mat-datepicker-toggle>
                            <mat-datepicker #planPicker></mat-datepicker>
                          </mat-form-field>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-12">
                          <mat-form-field class="full-width">
                            <mat-label>Notes</mat-label>
                            <textarea matInput [(ngModel)]="newWorkOrder.notes" name="notes" rows="3"></textarea>
                          </mat-form-field>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-12">
                          <button mat-raised-button color="primary" (click)="addNewWorkOrder()" [disabled]="!isValidWorkOrder()">
                            <mat-icon>save</mat-icon> Save Work Order
                          </button>
                          <button mat-raised-button (click)="isAddingWorkOrder = false; resetForm()" class="ml-2">
                            <mat-icon>cancel</mat-icon> Cancel
                          </button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <!-- Work Orders Table -->
            <div class="row">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-header card-header-primary">
                    <h4 class="card-title">Work Orders - {{selectedFactory}} ({{filteredWorkOrders.length}} orders)</h4>
                    <div class="card-tools">
                      <button mat-raised-button color="accent" (click)="exportToCSV()">
                        <mat-icon>file_download</mat-icon> Export CSV
                      </button>
                    </div>
                  </div>
                  <div class="card-body table-responsive">
                    <table class="table table-hover">
                      <thead class="text-primary">
                        <tr>
                          <th>Year</th>
                          <th>Month</th>
                          <th>Order Number</th>
                          <th>Product Code</th>
                          <th>Production Order</th>
                          <th>Quantity</th>
                          <th>Customer</th>
                          <th>Delivery Date</th>
                          <th>Line</th>
                          <th>Status</th>
                          <th>Created By</th>
                          <th>Checked By</th>
                          <th>Plan Received</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let wo of filteredWorkOrders" 
                            [class]="getStatusClass(wo.status) + ' ' + getPriorityClass(wo.deliveryDate)">
                          <td>{{wo.year}}</td>
                          <td>{{wo.month}}</td>
                          <td><strong>{{wo.orderNumber}}</strong></td>
                          <td>{{wo.productCode}}</td>
                          <td>{{wo.productionOrder}}</td>
                          <td>{{wo.quantity | number}}</td>
                          <td>{{wo.customer}}</td>
                          <td>
                            <span [class]="getPriorityClass(wo.deliveryDate)">
                              {{wo.deliveryDate | date:'dd/MM/yyyy'}}
                            </span>
                          </td>
                          <td>
                            <span class="badge badge-info">{{wo.productionLine}}</span>
                          </td>
                          <td>
                            <mat-form-field class="status-select">
                              <mat-select [value]="wo.status" (selectionChange)="updateWorkOrderStatus(wo, $event.value)">
                                <mat-option value="pending">Pending</mat-option>
                                <mat-option value="in_progress">In Progress</mat-option>
                                <mat-option value="on_hold">On Hold</mat-option>
                                <mat-option value="completed">Completed</mat-option>
                                <mat-option value="cancelled">Cancelled</mat-option>
                                <mat-option value="quality_check">Quality Check</mat-option>
                              </mat-select>
                            </mat-form-field>
                          </td>
                          <td>{{wo.createdBy}}</td>
                          <td>{{wo.checkedBy || '-'}}</td>
                          <td>{{wo.planReceivedDate | date:'dd/MM/yyyy'}}</td>
                          <td>
                            <button mat-icon-button color="warn" (click)="deleteWorkOrder(wo)" 
                                    matTooltip="Delete Work Order">
                              <mat-icon>delete</mat-icon>
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                    
                    <div *ngIf="filteredWorkOrders.length === 0" class="no-data">
                      <p>No work orders found for the selected criteria.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Excel Import Dialog -->
            <div class="import-dialog-overlay" *ngIf="showImportDialog" (click)="closeImportDialog()">
              <div class="import-dialog" (click)="$event.stopPropagation()">
                <div class="import-dialog-header">
                  <h4>Import Work Orders from Excel</h4>
                  <button mat-icon-button (click)="closeImportDialog()">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
                
                <div class="import-dialog-content">
                  <!-- Step 1: Download Template -->
                  <div class="import-step">
                    <h5>Step 1: Download Template</h5>
                    <p>Download the Excel template with the correct format for {{selectedFactory}} factory:</p>
                    <button mat-raised-button color="primary" (click)="downloadTemplate()">
                      <mat-icon>download</mat-icon> Download Template
                    </button>
                  </div>

                  <!-- Step 2: Upload File -->
                  <div class="import-step">
                    <h5>Step 2: Upload Excel File</h5>
                    <p>Select your Excel file with work order data:</p>
                    
                    <div class="file-upload-area">
                      <input type="file" 
                             #fileInput 
                             accept=".xlsx,.xls" 
                             (change)="onFileSelected($event)"
                             style="display: none;">
                      
                      <button mat-raised-button 
                              color="accent" 
                              (click)="fileInput.click()" 
                              [disabled]="isImporting">
                        <mat-icon>cloud_upload</mat-icon> 
                        {{isImporting ? 'Importing...' : 'Choose Excel File'}}
                      </button>
                    </div>
                  </div>

                  <!-- Progress Bar -->
                  <div class="import-step" *ngIf="isImporting">
                    <h5>Importing...</h5>
                    <mat-progress-bar mode="determinate" [value]="importProgress"></mat-progress-bar>
                    <p class="progress-text">{{importProgress}}% completed</p>
                  </div>

                  <!-- Import Results -->
                  <div class="import-step" *ngIf="importResults">
                    <h5>Import Results</h5>
                    <div class="import-summary">
                      <div class="result-item success" *ngIf="importResults.success > 0">
                        <mat-icon>check_circle</mat-icon>
                        <span>Successfully imported: {{importResults.success}} work orders</span>
                      </div>
                      
                      <div class="result-item error" *ngIf="importResults.failed > 0">
                        <mat-icon>error</mat-icon>
                        <span>Failed to import: {{importResults.failed}} work orders</span>
                      </div>
                    </div>

                    <!-- Error Details -->
                    <div class="error-details" *ngIf="importResults.errors && importResults.errors.length > 0">
                      <h6>Error Details:</h6>
                      <div class="error-list">
                        <div class="error-item" *ngFor="let error of importResults.errors">
                          <strong>Row {{error.row}}:</strong> {{error.error}}
                        </div>
                      </div>
                    </div>

                    <div class="import-actions">
                      <button mat-raised-button color="primary" (click)="closeImportDialog()">
                        <mat-icon>check</mat-icon> Done
                      </button>
                    </div>
                  </div>

                  <!-- Instructions -->
                  <div class="import-instructions">
                    <h6>Excel Format Guidelines:</h6>
                    <ul>
                      <li>Use the provided template for correct column order</li>
                      <li>Year and Month columns must be numbers</li>
                      <li>Quantity must be a positive number</li>
                      <li>Dates should be in Excel date format or YYYY-MM-DD</li>
                      <li>Order Number can be left empty for auto-generation</li>
                      <li>Required fields: Product Code, Production Order, Quantity, Customer, Delivery Date, Production Line, Created By, Plan Received Date</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>
