<div class="workorder-container">

  <!-- Nút Edit on Google Sheet, căn trái phía trên -->
  <div class="edit-sheet-wrapper">
    <button class="edit-sheet-btn" (click)="openGoogleSheet()">
      <span style="display:flex;align-items:center;">
        <i class="material-icons" style="font-size:18px;margin-right:4px;">edit</i>
        Edit on Google Sheet
      </span>
    </button>
  </div>

  <!-- Tiêu đề bảng -->
  <h2 class="wo-title">Work Order Status</h2>

  <!-- Bộ lọc -->
  <div style="margin-bottom: 16px; text-align:center;">
    <label class="filter-label">Y:</label>
    <select [(ngModel)]="selectedYear" (change)="filterData()" style="margin-right:14px; min-width:72px;">
      <option value="">-- Tất cả --</option>
      <option *ngFor="let y of years" [value]="y">{{y}}</option>
    </select>
    <label class="filter-label">M:</label>
    <select [(ngModel)]="selectedMonth" (change)="filterData()" style="min-width:60px;">
      <option value="">-- Tất cả --</option>
      <option *ngFor="let m of months" [value]="m">{{m}}</option>
    </select>
  </div>

  <!-- Đăng nhập -->
  <div *ngIf="!isLoggedIn" class="login-box">
    <input placeholder="Account" [(ngModel)]="username" />
    <input placeholder="Password" type="password" [(ngModel)]="password" />
    <button (click)="login()">Login</button>
    <div *ngIf="loginError" style="color: red;">{{loginError}}</div>
  </div>

  <!-- Đã đăng nhập: Được chỉnh sửa -->
  <div *ngIf="isLoggedIn">
    <div style="overflow-x:auto; max-height: 66vh;">
      <table *ngIf="workOrders.length > 0" class="wo-table">
        <thead>
          <tr>
            <th *ngFor="let col of columns" class="header">{{col}}</th>
            <th class="actions-col header">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of workOrders; let i=index"
              [class.odd]="i%2===0"
              [class.even]="i%2===1">
            <td *ngFor="let col of columns">
              <ng-container *ngIf="editIndex === i; else viewOnly">
                <ng-container *ngIf="col === 'Date PD'; else editOther">
                  <input [(ngModel)]="workOrders[i][col]" class="wo-input"
                         (keydown.enter)="saveRow(i)" (blur)="saveRow(i)" />
                </ng-container>
                <ng-template #editOther>
                  <input [(ngModel)]="workOrders[i][col]" class="wo-input"
                         (keydown.enter)="saveRow(i)" (blur)="saveRow(i)" />
                </ng-template>
              </ng-container>
              <ng-template #viewOnly>
                <ng-container *ngIf="col === 'Date PD'; else normalCol">
                  {{ formatDatePD(row[col]) }}
                </ng-container>
                <ng-template #normalCol>
                  {{ row[col] }}
                </ng-template>
              </ng-template>
            </td>
            <td class="actions-col">
              <button *ngIf="editIndex !== i" (click)="editIndex = i">Edit</button>
              <button *ngIf="editIndex === i" (click)="saveRow(i)">Save</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Chưa đăng nhập: Chỉ xem -->
  <div *ngIf="!isLoggedIn && workOrders.length > 0">
    <div style="overflow-x:auto; max-height: 66vh;">
      <table class="wo-table">
        <thead>
          <tr>
            <th *ngFor="let col of columns" class="header">{{col}}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of workOrders; let i=index"
              [class.odd]="i%2===0"
              [class.even]="i%2===1">
            <td *ngFor="let col of columns">
              <ng-container *ngIf="col === 'Date PD'; else normalCell">
                {{ formatDatePD(row[col]) }}
              </ng-container>
              <ng-template #normalCell>
                {{ row[col] }}
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div style="margin-top:8px; color: #888;">Đăng nhập để chỉnh sửa dữ liệu!</div>
  </div>

  <div *ngIf="loading">Loading...</div>
  <div *ngIf="errorMsg">{{errorMsg}}</div>
</div>
