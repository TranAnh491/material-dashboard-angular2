<div class="main-content">
  <!-- Excel-like Container -->
  <div class="excel-container">
    <!-- Report Title -->
    <div class="excel-header">
      <h4>üõ°Ô∏è SAFETY INVENTORY</h4>
      <div class="scan-mode-indicator" *ngIf="isScanMode">
        <i class="material-icons">qr_code_scanner</i>
        <span>ƒêang scan cho {{scanFactory}}</span>
      </div>
    </div>
    
    <!-- Excel Actions -->
    <div class="excel-actions">
      <div class="action-controls-horizontal">
        <!-- More Button with Dropdown -->
        <div class="dropdown">
          <button class="more-btn" (click)="toggleDropdown($event)">
            <i class="material-icons">more_vert</i>
            More
          </button>
          <div class="dropdown-menu" [class.show]="isDropdownOpen">
            <a class="dropdown-item" href="javascript:void(0)" (click)="exportToExcel()">
              <i class="material-icons">file_download</i>
              Export to Excel
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="javascript:void(0)" (click)="downloadSampleTemplate()">
              <i class="material-icons">description</i>
              Download Template
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="javascript:void(0)" (click)="importSafetyLevels()">
              <i class="material-icons">file_upload</i>
              Import Safety Levels
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="javascript:void(0)" (click)="verifyImportedSafetyLevels()">
              <i class="material-icons">verified</i>
              Verify Import
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="javascript:void(0)" (click)="resetAllSafetyLevels()">
              <i class="material-icons">restore</i>
              Reset Safety Levels
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="javascript:void(0)" (click)="migrateOldData()">
              <i class="material-icons">sync</i>
              Migrate Old Data
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="javascript:void(0)" (click)="initializeSampleData()">
              <i class="material-icons">add_circle</i>
              Initialize Sample Data
            </a>
          </div>
        </div>
        
        <!-- Total Counter Box -->
        <div class="total-counter-box">
          <i class="material-icons">inventory_2</i>
          <span>T·ªïng: {{ filteredMaterials.length }} m√£</span>
        </div>
        
        <!-- Search Type Selector -->
        <div class="search-type-selector">
          <div class="dropdown">
            <button class="search-type-dropdown" 
                    type="button" 
                    data-toggle="dropdown" 
                    aria-haspopup="true" 
                    aria-expanded="false">
              <i class="material-icons">inventory</i>
              M√£
            </button>
            <div class="dropdown-menu">
              <a class="dropdown-item" href="javascript:void(0)" (click)="changeSearchType('material')">
                <i class="material-icons">inventory</i>
                M√£
              </a>
            </div>
          </div>
        </div>
        
        <!-- Search Box -->
        <div class="search-box">
          <input type="text"
                 [placeholder]="isLoading ? 'üîç ƒêang t·∫£i...' : 'Nh·∫≠p ƒë·ªÉ t√¨m ki·∫øm'"
                 [(ngModel)]="searchTerm"
                 (input)="onSearchInput($event)"
                 (keyup)="onSearchKeyUp($event)"
                 class="search-input"
                 [disabled]="isLoading">
          
          <!-- Clear search button -->
          <button class="clear-search-btn" 
                  *ngIf="searchTerm" 
                  (click)="clearSearch()" 
                  title="X√≥a t√¨m ki·∫øm">
            <i class="material-icons">clear</i>
          </button>
          
          <!-- Search warning -->
          <div class="search-warning" *ngIf="searchTerm && searchTerm.length < 3">
            <i class="material-icons">info</i>
            C·∫ßn √≠t nh·∫•t 3 k√Ω t·ª±
          </div>
        </div>
        
                 <!-- Action Buttons -->
         <div class="action-buttons">
           <!-- Scan Mode Buttons -->
           <div class="scan-buttons" *ngIf="!isScanMode">
             <button class="scan-btn scan-asm1" (click)="startScanMode('ASM1')" title="B·∫Øt ƒë·∫ßu scan cho ASM1">
               <i class="material-icons">qr_code_scanner</i>
               ASM1
             </button>
             <button class="scan-btn scan-asm2" (click)="startScanMode('ASM2')" title="B·∫Øt ƒë·∫ßu scan cho ASM2">
               <i class="material-icons">qr_code_scanner</i>
               ASM2
             </button>
           </div>
           
           <!-- Stop Scan Button -->
           <div class="scan-buttons" *ngIf="isScanMode">
             <button class="stop-scan-btn" (click)="stopScanMode()" title="D·ª´ng ch·∫ø ƒë·ªô scan">
               <i class="material-icons">stop</i>
               D·ª´ng Scan ({{scanFactory}})
             </button>
           </div>
           
           
            
            <button class="refresh-btn" (click)="refreshData()" title="L√†m m·ªõi d·ªØ li·ªáu Safety">
              <i class="material-icons">refresh</i>
              Refresh
            </button>
            
            <button class="consolidate-btn" (click)="consolidateDuplicateMaterials()" title="G·ªôp c√°c d√≤ng tr√πng l·∫∑p ƒë·ªÉ tr√°nh t·∫°o d√≤ng m·ªõi">
              <i class="material-icons">merge_type</i>
              G·ªôp D√≤ng Tr√πng
            </button>
            
            <button class="check-duplicates-btn" (click)="checkDuplicateMaterials()" title="Ki·ªÉm tra c√°c d√≤ng tr√πng l·∫∑p">
              <i class="material-icons">search</i>
              Ki·ªÉm Tra Tr√πng
            </button>
         </div>
         
         <!-- Import Progress Indicator -->
         <div class="import-progress" *ngIf="isImporting">
           <div class="progress-bar">
             <div class="progress-fill" [style.width.%]="importProgress"></div>
           </div>
           <span class="progress-text">ƒêang import: {{importProgress}}%</span>
         </div>
        
        <!-- Scan Status and Test Input -->
        <div class="scan-status" *ngIf="isScanMode">
                     <div class="scan-info">
             <i class="material-icons">qr_code_scanner</i>
             <span>ƒêang scan cho <strong>{{scanFactory}}</strong> - ƒê·ªãnh d·∫°ng tem: <code>Rxxxxxx yyyy</code> ho·∫∑c <code>Bxxxxxx yyyy</code></span>
           </div>
          
                                           <div class="scan-instructions">
              <p><strong>H∆∞·ªõng d·∫´n:</strong></p>
              <ul>
                <li>B·∫•m n√∫t <strong>ASM1</strong> ho·∫∑c <strong>ASM2</strong> ƒë·ªÉ b·∫Øt ƒë·∫ßu scan</li>
                <li>Scan tem c√≥ ƒë·ªãnh d·∫°ng: <code>RB018694 150</code> ho·∫∑c <code>R123456 200</code></li>
                <li>Trong ƒë√≥: <code>B018694</code> ho·∫∑c <code>R123456</code> l√† m√£ h√†ng (7 k√Ω t·ª±), <code>150</code> ho·∫∑c <code>200</code> l√† s·ªë l∆∞·ª£ng</li>
                <li>M√£ h√†ng b·∫Øt ƒë·∫ßu b·∫±ng <strong>R</strong> ho·∫∑c <strong>B</strong> + 6 s·ªë (t·ªïng 7 k√Ω t·ª±)</li>
                <li>S·ªë l∆∞·ª£ng s·∫Ω ƒë∆∞·ª£c c·ªông d·ªìn v√†o c·ªôt t∆∞∆°ng ·ª©ng (ASM1 ho·∫∑c ASM2) n·∫øu m√£ h√†ng ƒë√£ t·ªìn t·∫°i</li>
                <li><strong>T√™n h√†ng:</strong> Nh·∫≠p tay v√†o c·ªôt "T√™n h√†ng"</li>
                <li><strong>L∆∞·ª£ng Pallet:</strong> Nh·∫≠p tay s·ªë l∆∞·ª£ng tr√™n m·ªói pallet (ASM1 v√† ASM2 ri√™ng bi·ªát)</li>
                <li><strong>S·ªë Pallet:</strong> T·ª± ƒë·ªông t√≠nh = L∆∞·ª£ng √∑ L∆∞·ª£ng Pallet (l√†m tr√≤n l√™n)</li>
                <li><strong>T·ªïng Pallet:</strong> T·ªïng s·ªë pallet c·ªßa ASM1 + ASM2</li>
                <li>C·ªôt Safety hi·ªÉn th·ªã t·ªïng c·ªßa ASM1 v√† ASM2, c√≥ th·ªÉ ch·ªânh s·ª≠a b·∫±ng c√°ch click v√†o input</li>
                <li>C·ªôt T√¨nh Tr·∫°ng so s√°nh T·ªïng v·ªõi Safety Level</li>
              </ul>
            </div>
          
                     <!-- Test input for development -->
           <div class="test-scan-input">
             <input type="text" 
                    placeholder="Nh·∫≠p tem ƒë·ªÉ test (VD: RB018694 150 ho·∫∑c R123456 200)" 
                    class="test-input"
                    (keyup.enter)="processScannedData($event.target.value); $event.target.value = ''">
             <button class="test-scan-btn" 
                     (click)="testScan()">
               Test Scan
             </button>
             
             <!-- Quick test buttons for debugging -->
             <div class="quick-test-buttons">
               <button class="quick-test-btn" 
                       (click)="testScanWithValue('RB018694 150')"
                       title="Test scan B018694 with 150">
                 Test: B018694 150
               </button>
               <button class="quick-test-btn" 
                       (click)="testScanWithValue('R123456 200')"
                       title="Test scan R123456 with 200">
                 Test: R123456 200
               </button>
               <button class="quick-test-btn" 
                       (click)="testScanWithValue('RB018694 100')"
                       title="Test scan B018694 again with 100 (should add to existing)">
                 Test: B018694 100 (+)
               </button>
               <button class="quick-test-btn debug-btn" 
                       (click)="debugScanInfo()"
                       title="Debug scan information">
                 üêõ Debug Info
               </button>
             </div>
           </div>
        </div>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading-container" *ngIf="isLoading">
      <div class="loading-spinner">
        <i class="material-icons rotating">sync</i>
        <span>ƒêang t·∫£i d·ªØ li·ªáu Safety...</span>
      </div>
    </div>

    <!-- Table Container -->
    <div class="table-container" *ngIf="!isLoading">
             <!-- Table -->
       <table class="excel-table">
                   <thead>
            <tr>
              <th>Ng√†y Scan</th>
              <th>M√£ h√†ng</th>
              <th>T√™n h√†ng</th>
              <th>L∆∞·ª£ng ASM1</th>
              <th>L∆∞·ª£ng Pallet ASM1</th>
              <th>Pallet ASM1</th>
              <th>L∆∞·ª£ng ASM2</th>
              <th>L∆∞·ª£ng Pallet ASM2</th>
              <th>Pallet ASM2</th>
              <th>T·ªïng</th>
              <th>T·ªïng Pallet</th>
              <th>Safety</th>
              <th>T√¨nh Tr·∫°ng</th>
              <th>X√≥a</th>
            </tr>
          </thead>
                   <tbody>
            <tr *ngFor="let material of filteredMaterials; trackBy: trackByFn; let i = index">
              <td class="date-cell">
                {{formatDate(material.scanDate)}}
              </td>
              <td class="code-cell material-code-cell">
                {{material.materialCode}}
              </td>
              <td class="name-cell">
                <input type="text" 
                       class="name-input" 
                       [value]="material.materialName"
                       (change)="updateMaterialName(material, $event.target.value)"
                       placeholder="Nh·∫≠p t√™n h√†ng">
              </td>
              <td class="number-cell">
                {{formatNumberWithCommas(material.quantityASM1)}}
              </td>
              <td class="pallet-quantity-cell">
                <input type="number" 
                       class="pallet-quantity-input" 
                       [value]="material.palletQuantityASM1 === 0 ? '' : material.palletQuantityASM1"
                       (change)="updatePalletQuantityASM1(material, $event.target.value)"
                       placeholder="L∆∞·ª£ng/pallet"
                       min="0">
              </td>
              <td class="number-cell pallet-count-cell">
                {{formatNumberWithCommas(material.palletCountASM1)}}
              </td>
              <td class="number-cell">
                {{formatNumberWithCommas(material.quantityASM2)}}
              </td>
              <td class="pallet-quantity-cell">
                <input type="number" 
                       class="pallet-quantity-input" 
                       [value]="material.palletQuantityASM2 === 0 ? '' : material.palletQuantityASM2"
                       (change)="updatePalletQuantityASM2(material, $event.target.value)"
                       placeholder="L∆∞·ª£ng/pallet"
                       min="0"
                       step="0.01">
              </td>
              <td class="number-cell pallet-count-cell">
                {{formatNumberWithCommas(material.palletCountASM2)}}
              </td>
              <td class="number-cell total-cell">
                {{formatNumberWithCommas(material.totalQuantity)}}
              </td>
              <td class="number-cell total-pallet-cell">
                {{formatNumberWithCommas(material.totalPalletCount)}}
              </td>
              <td class="safety-cell">
                <input type="number" 
                       class="safety-input" 
                       [value]="material.safety === 0 ? '' : material.safety"
                       (change)="updateSafety(material, $event.target.value)"
                       placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng"
                       min="0"
                       step="0.01">
              </td>
              <td class="status-cell">
                <span class="badge" [class]="getStatusClass(material)">
                  {{ getStatusText(material) }}
                </span>
              </td>
              <td class="delete-cell">
                <button class="delete-btn" 
                        (click)="deleteMaterial(material)" 
                        title="X√≥a s·ªë l∆∞·ª£ng th·ª±c t·∫ø c·ªßa {{material.materialCode}} (gi·ªØ nguy√™n m√£ h√†ng v√† safety level)">
                  <i class="material-icons">delete</i>
                </button>
              </td>
            </tr>
          </tbody>
       </table>

      <!-- Empty State - Search First Approach -->
      <div class="empty-state" *ngIf="!searchTerm && filteredMaterials.length === 0 && !isLoading">
        <div class="empty-state-content">
          <i class="material-icons">search</i>
          <h3>üîç T√¨m ki·∫øm Safety Inventory</h3>
          <p>Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm materials trong Safety inventory</p>
          
                     <!-- Search Suggestions -->
           <div class="search-suggestions">
             <h5>üí° G·ª£i √Ω t√¨m ki·∫øm:</h5>
             <div class="suggestion-tags">
               <span class="suggestion-tag" (click)="searchTerm = 'B018694'; onSearchInput({target: {value: 'B018694'}})">B018694</span>
               <span class="suggestion-tag" (click)="searchTerm = 'R123456'; onSearchInput({target: {value: 'R123456'}})">R123456</span>
               <span class="suggestion-tag" (click)="searchTerm = 'Safety'; onSearchInput({target: {value: 'Safety'}})">Safety</span>
             </div>
           </div>
          
          <!-- Quick Stats -->
          <div class="quick-stats">
            <div class="stat-item">
              <i class="material-icons">factory</i>
              <span>ASM1 + ASM2</span>
            </div>
            <div class="stat-item">
              <i class="material-icons">inventory</i>
              <span>Real-time Search</span>
            </div>
            <div class="stat-item">
              <i class="material-icons">speed</i>
              <span>Fast Loading</span>
            </div>
          </div>
        </div>
      </div>

      <!-- No Search Results -->
      <div class="no-results" *ngIf="searchTerm && filteredMaterials.length === 0 && !isLoading">
        <div class="no-results-content">
          <i class="material-icons">search_off</i>
          <h4>üîç Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h4>
          <p>Kh√¥ng t√¨m th·∫•y materials n√†o cho "<strong>{{searchTerm}}</strong>" trong Safety inventory</p>
          
          <!-- Search Tips -->
          <div class="search-tips">
            <h6>üí° M·∫πo t√¨m ki·∫øm:</h6>
            <ul>
              <li>Ki·ªÉm tra ch√≠nh t·∫£</li>
              <li>Th·ª≠ t√¨m ki·∫øm v·ªõi √≠t k√Ω t·ª± h∆°n</li>
              <li>Th·ª≠ t√¨m ki·∫øm theo material code</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading-state" *ngIf="isLoading">
        <div class="loading-content">
          <i class="material-icons rotating">sync</i>
          <h4>üîç ƒêang t√¨m ki·∫øm...</h4>
          <p>T√¨m ki·∫øm "<strong>{{searchTerm}}</strong>" trong Safety inventory</p>
        </div>
      </div>
    </div>
  </div>
</div>
