<div class="settings-container">
  <!-- Admin Login -->
  <div *ngIf="!isAdminLoggedIn" class="login-section">
    <div class="login-box">
      <h2>Đăng nhập</h2>
      <form (ngSubmit)="adminLogin()">
        <div class="form-group">
          <label>Tên đăng nhập</label>
          <input type="text" [(ngModel)]="adminUsername" name="username" required>
      </div>
        <div class="form-group">
          <label>Mật khẩu</label>
          <input type="password" [(ngModel)]="adminPassword" name="password" required>
        </div>
        <div *ngIf="loginError" class="error">{{ loginError }}</div>
        <button type="submit" [disabled]="!adminUsername || !adminPassword">Đăng nhập</button>
        </form>
      </div>
    </div>

    <!-- Settings Dashboard -->
  <div *ngIf="isAdminLoggedIn" class="dashboard">
    <div class="header">
      <h1>Quản lý người dùng</h1>
      <button (click)="logout()">Đăng xuất</button>
          </div>
          
    <!-- Stats -->
    <div class="stats">
      <div class="stat-item">
        <div class="stat-number">{{ firebaseUsers.length }}</div>
        <div class="stat-label">Người dùng</div>
            </div>
      <div class="stat-item">
        <div class="stat-number">{{ getAdminUsersCount() }}</div>
        <div class="stat-label">Quản trị viên</div>
            </div>
          </div>
          
    <!-- Notifications -->
    <div *ngIf="newUserNotifications.length > 0" class="notifications">
      <div class="notifications-header">
        <h3>Tài khoản mới ({{ newUserNotifications.length }})</h3>
        <button (click)="markAllNotificationsAsReadPublic()">Đánh dấu đã đọc</button>
            </div>
      <div class="notifications-list">
        <div *ngFor="let notification of newUserNotifications" class="notification-item">
          <div class="notification-info">
            <strong>{{ notification.displayName || notification.userEmail }}</strong>
            <span>{{ notification.department }} - {{ notification.factory }}</span>
            <span class="time">{{ notification.createdAt | date:'dd/MM HH:mm' }}</span>
          </div>
          <button (click)="markNotificationAsRead(notification.id)">✓</button>
        </div>
            </div>
          </div>
          
    <!-- Users List -->
    <div class="users-section">
      <div class="section-header">
        <h3>Danh sách người dùng</h3>
        <div class="actions">
          <button (click)="refreshFirebaseUsers()">Làm mới</button>
        </div>
      </div>

      <div *ngIf="isLoadingFirebaseUsers" class="loading">Đang tải...</div>
      
      <div *ngIf="!isLoadingFirebaseUsers && firebaseUsers.length === 0" class="empty">
        Chưa có người dùng nào
      </div>

      <!-- Danh sách đã duyệt -->
      <div *ngIf="!isLoadingFirebaseUsers && getApprovedUsers().length > 0" class="users-list-section">
        <h4>Đã duyệt ({{ getApprovedUsers().length }})</h4>
        <div class="users-list">
          <div *ngFor="let user of getApprovedUsers()" class="user-item" (click)="openPermissionModal(user)">
            <div class="user-info">
              <div class="user-employee-id">{{ getEmployeeIdOnly(user) }}</div>
              <div class="user-name" [class.admin-name]="user.role === 'Admin'">{{ user.displayName || '-' }}</div>
              <div class="user-department">{{ user.department || '-' }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Danh sách chờ duyệt -->
      <div *ngIf="!isLoadingFirebaseUsers && getPendingUsers().length > 0" class="users-list-section pending-section">
        <h4>Chờ duyệt ({{ getPendingUsers().length }})</h4>
        <div class="users-list">
          <div *ngFor="let user of getPendingUsers()" class="user-item pending" (click)="openPermissionModal(user)">
            <div class="user-info">
              <div class="user-employee-id">{{ getEmployeeIdOnly(user) }}</div>
              <div class="user-name" [class.admin-name]="user.role === 'Admin'">{{ user.displayName || '-' }}</div>
              <div class="user-department">{{ user.department || '-' }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Permission Modal -->
    <div *ngIf="showPermissionModal && selectedUser" class="modal-overlay" (click)="closePermissionModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Quản lý quyền truy cập</h3>
          <button class="close-btn" (click)="closePermissionModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="user-detail">
            <div class="detail-row">
              <strong>Mã nhân viên:</strong> {{ getEmployeeIdOnly(selectedUser) }}
            </div>
            <div class="detail-row">
              <strong>Tên:</strong> {{ selectedUser.displayName || '-' }}
            </div>
            <div class="detail-row">
              <strong>Bộ phận:</strong> {{ selectedUser.department || '-' }}
            </div>
            <div class="detail-row">
              <strong>Password:</strong> {{ firebaseUserPasswords[selectedUser.uid] || '-' }}
              <button class="btn-change-password" (click)="toggleChangePasswordForm()" type="button">
                {{ showChangePasswordForm ? 'Hủy' : 'Đổi password' }}
              </button>
            </div>
            <div *ngIf="showChangePasswordForm" class="change-password-form">
              <div class="form-group">
                <label>Password mới:</label>
                <input 
                  type="password" 
                  [(ngModel)]="changePasswordValue" 
                  placeholder="Nhập password mới (tối thiểu 6 ký tự)"
                  class="password-input">
              </div>
              <button class="btn-save-password" (click)="changeUserPassword()" type="button">
                Lưu password mới
              </button>
            </div>
          </div>
          <div class="read-only-permission">
            <label class="read-only-checkbox">
              <input 
                type="checkbox" 
                [checked]="tempReadOnlyPermission"
                (change)="tempReadOnlyPermission = $event.target.checked">
              <span><strong>Chỉ xem</strong> - Nhân viên này chỉ được xem, không được sửa</span>
            </label>
          </div>
          <div class="tabs-permissions">
            <h4>Quyền truy cập các tab:</h4>
            <div class="tabs-grid">
              <div *ngFor="let tab of availableTabs" class="tab-permission-item">
                <label class="tab-checkbox">
                  <input 
                    type="checkbox" 
                    [checked]="tempTabPermissions[tab.key] || false"
                    (change)="toggleTabPermission(tab.key)">
                  <span>{{ tab.name }}</span>
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-delete" (click)="deleteUserFromModal()">Xóa</button>
          <button class="btn-cancel" (click)="closePermissionModal()">Hủy</button>
          <button class="btn-save" (click)="saveUserPermissions()">Lưu</button>
        </div>
      </div>
    </div>

    <!-- Old Users Table (Hidden for now) -->
    <div *ngIf="false" class="table-container">
      <table class="users-table">
          <thead>
            <tr>
              <th class="col-account">Tài khoản</th>
              <th class="col-role">Vai trò</th>
              <th class="col-department">Bộ phận</th>
              <th class="col-factory">Nhà máy</th>
              <th class="col-name sticky-name">Tên</th>
              <th class="col-checkbox">Chỉ xem</th>
              <th class="col-checkbox">Xóa</th>
              <th class="col-checkbox">Hoàn thành</th>
              <th class="col-lastlogin">Đăng nhập gần nhất</th>
              <th class="col-action">Thao tác</th>
              <th *ngFor="let tab of availableTabs" class="col-tab">{{ tab.name }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of getSortedFirebaseUsers()">
              <td class="col-account">{{ getEmployeeIdOnly(user) }}</td>
              <td class="col-role">
                    <select *ngIf="isEditingPermissions" 
                            [(ngModel)]="user.role" 
                        (change)="updateUserRole(user.uid, user.role)">
                      <option value="Admin">Admin</option>
                      <option value="Quản lý">Quản lý</option>
                      <option value="User">User</option>
                    </select>
                <span *ngIf="!isEditingPermissions">{{ user.role || 'User' }}</span>
                  </td>
              <td class="col-department">
                    <select *ngIf="isEditingPermissions" 
                            [(ngModel)]="user.department" 
                        (change)="updateUserDepartment(user.uid, user.department)">
                  <option value="">-</option>
                      <option value="WH">WH</option>
                      <option value="QA">QA</option>
                      <option value="ENG">ENG</option>
                      <option value="PLAN">PLAN</option>
                      <option value="PD">PD</option>
                      <option value="CS">CS</option>
                      <option value="ACC">ACC</option>
                    </select>
                <span *ngIf="!isEditingPermissions">{{ user.department || '-' }}</span>
                  </td>
              <td class="col-factory">
                    <select *ngIf="isEditingPermissions" 
                            [(ngModel)]="user.factory" 
                        (change)="updateUserFactory(user.uid, user.factory)">
                      <option value="ASM1">ASM1</option>
                      <option value="ASM2">ASM2</option>
                    </select>
                <span *ngIf="!isEditingPermissions">{{ user.factory || '-' }}</span>
                  </td>
              <td class="col-name sticky-name">{{ user.displayName || '-' }}</td>
              <td class="col-checkbox">
                <input type="checkbox"
                      [checked]="firebaseUserReadOnlyPermissions[user.uid] || false"
                       (change)="updateUserReadOnlyPermission(user.uid, $event.target.checked)"
                       [disabled]="!isEditingPermissions">
                  </td>
              <td class="col-checkbox">
                <input type="checkbox"
                      [checked]="firebaseUserPermissions[user.uid] || false"
                       (change)="updateUserPermission(user.uid, $event.target.checked)"
                       [disabled]="!isEditingPermissions">
                  </td>
              <td class="col-checkbox">
                <input type="checkbox"
                      [checked]="firebaseUserCompletePermissions[user.uid] || false"
                       (change)="updateUserCompletePermission(user.uid, $event.target.checked)"
                       [disabled]="!isEditingPermissions">
                  </td>
              <td class="col-lastlogin">{{ user.lastLoginAt ? (user.lastLoginAt | date:'dd/MM/yyyy HH:mm') : 'Chưa đăng nhập' }}</td>
              <td class="col-action">
                <button (click)="deleteFirebaseUser(user)">Xóa</button>
              </td>
              <td *ngFor="let tab of availableTabs" class="col-tab">
                <input type="checkbox"
                  [checked]="firebaseUserTabPermissions[user.uid]?.[tab.key] !== false"
                       (change)="updateUserTabPermission(user.uid, tab.key, $event.target.checked)"
                       [disabled]="!isEditingPermissions">
              </td>
            </tr>
          </tbody>
                </table>
              </div>
            </div>

    <!-- Employee Cleanup -->
    <div class="cleanup-section">
      <div class="section-header">
        <h3>Dọn dẹp mã nhân viên</h3>
        <div class="actions">
          <button (click)="compareEmployees()" [disabled]="isComparingEmployees">
            {{ isComparingEmployees ? 'Đang so sánh...' : 'So sánh' }}
          </button>
          <button (click)="exportComparisonReport()" [disabled]="!employeeComparisonResult">Xuất báo cáo</button>
        </div>
      </div>

      <div *ngIf="employeeComparisonResult" class="comparison-results">
        <div class="summary">
          <div>Settings: {{ employeeComparisonResult.totalSettings }}</div>
          <div>Firebase: {{ employeeComparisonResult.totalFirebase }}</div>
          <div>Hợp lệ: {{ employeeComparisonResult.validEmployees }}</div>
          <div>Dư thừa: {{ employeeComparisonResult.redundantEmployees.length }}</div>
          <div>Thiếu: {{ employeeComparisonResult.missingEmployees.length }}</div>
        </div>

        <div *ngIf="employeeComparisonResult.redundantEmployees.length > 0" class="redundant-list">
          <h4>Mã dư thừa ({{ employeeComparisonResult.redundantEmployees.length }})</h4>
          <div class="actions">
            <button (click)="selectAllRedundantEmployees()">Chọn tất cả</button>
            <button (click)="deselectAllRedundantEmployees()">Bỏ chọn</button>
            <button (click)="cleanupSelectedEmployees()" 
                      [disabled]="selectedRedundantEmployees.length === 0 || isCleaningUp">
              Xóa đã chọn ({{ selectedRedundantEmployees.length }})
              </button>
            <button (click)="cleanupAllRedundantEmployees()" [disabled]="isCleaningUp">Xóa tất cả</button>
          </div>
          <table class="cleanup-table">
              <thead>
                <tr>
                <th><input type="checkbox" 
                           [checked]="selectedRedundantEmployees.length === employeeComparisonResult.redundantEmployees.length"
                           (change)="selectedRedundantEmployees.length === employeeComparisonResult.redundantEmployees.length ? deselectAllRedundantEmployees() : selectAllRedundantEmployees()"></th>
                  <th>Mã nhân viên</th>
                  <th>Trạng thái</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let emp of employeeComparisonResult.redundantEmployees">
                  <td>
                    <input type="checkbox" 
                           [checked]="isRedundantEmployeeSelected(emp.employeeId)"
                           (change)="toggleRedundantEmployeeSelection(emp.employeeId)">
                  </td>
                <td><strong>{{ emp.employeeId }}</strong></td>
                <td>Dư thừa</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
