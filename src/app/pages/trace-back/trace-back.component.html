<div class="trace-back-container">
  <!-- Header -->
  <div class="header-section">
    <h2>üîç Trace Back - Truy v·∫øt nguy√™n li·ªáu</h2>
    <p class="subtitle">Qu√©t m√£ h√†ng ƒë·ªÉ xem l·ªãch s·ª≠ di chuy·ªÉn v√† x·ª≠ l√Ω</p>
  </div>

  <!-- Factory Selection -->
  <div class="factory-selection">
    <label>Ch·ªçn nh√† m√°y:</label>
    <div class="factory-buttons">
      <button 
        class="factory-btn" 
        [class.active]="selectedFactory === 'ASM1'"
        (click)="onFactoryChange('ASM1')">
        ASM1
      </button>
      <button 
        class="factory-btn" 
        [class.active]="selectedFactory === 'ASM2'"
        (click)="onFactoryChange('ASM2')">
        ASM2
      </button>
    </div>
  </div>

  <!-- Scanner Input -->
  <div class="scanner-section">
    <label for="scanInput">Qu√©t m√£ h√†ng:</label>
    <div class="scan-input-wrapper">
      <input 
        type="text" 
        id="scanInput"
        class="scan-input"
        [(ngModel)]="scanInput"
        (keydown)="onScanInput($event)"
        (input)="onScanInputChange()"
        placeholder="Qu√©t QR code ho·∫∑c nh·∫≠p m√£ h√†ng..."
        [disabled]="isLoading">
      <button 
        class="clear-btn" 
        (click)="clearTrace()"
        *ngIf="traceRows.length > 0">
        <i class="material-icons">clear</i>
      </button>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div class="loading-indicator" *ngIf="isLoading">
    <i class="material-icons">hourglass_empty</i>
    <span>ƒêang t·∫£i d·ªØ li·ªáu...</span>
  </div>

  <!-- Material Info - Inbound Information -->
  <div class="material-info" *ngIf="inboundInfo && !isLoading">
    <h3>üì¶ Th√¥ng tin l√∫c nh·∫≠p</h3>
    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">M√£ h√†ng:</span>
        <span class="info-value">{{ inboundInfo.materialCode }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">PO:</span>
        <span class="info-value">{{ inboundInfo.poNumber }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">IMD:</span>
        <span class="info-value">{{ inboundInfo.imd }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">S·ªë l∆∞·ª£ng:</span>
        <span class="info-value">{{ inboundInfo.quantity | number }}</span>
      </div>
      <div class="info-item" *ngIf="inboundInfo.employeeIds && inboundInfo.employeeIds.length > 0">
        <span class="info-label">M√£ nh√¢n vi√™n:</span>
        <span class="info-value">{{ inboundInfo.employeeIds.join(', ') }}</span>
      </div>
      <div class="info-item" *ngIf="inboundInfo.rollsOrBags > 0">
        <span class="info-label">S·ªë cu·ªôn:</span>
        <span class="info-value">{{ inboundInfo.rollsOrBags | number }}</span>
      </div>
      <div class="info-item" *ngIf="inboundInfo.batchNumber">
        <span class="info-label">L√¥ h√†ng nh·∫≠p:</span>
        <span class="info-value">{{ inboundInfo.batchNumber }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Ng√†y nh·∫≠p:</span>
        <span class="info-value">{{ formatDate(inboundInfo.importDate) }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Ch·ªù QC pass:</span>
        <span class="info-value" [class.waiting]="inboundInfo.qcWaitTime === 'Ch∆∞a QC'">{{ inboundInfo.qcWaitTime }}</span>
      </div>
    </div>
  </div>
  
  <!-- Material Code Only (if no inbound info) -->
  <div class="material-info" *ngIf="materialCode && !inboundInfo && !isLoading">
    <h3>{{ materialName || materialCode }}</h3>
    <p class="material-code">M√£ h√†ng: {{ materialCode }}</p>
  </div>

  <!-- Trace Table -->
  <div class="trace-table-container" *ngIf="traceRows.length > 0 && !isLoading">
    <h3>üìã D√≤ng th·ªùi gian</h3>
    
    <div class="table-wrapper">
      <table class="trace-table">
        <thead>
          <tr>
            <th *ngIf="getAvailableColumns().includes('date')">Ng√†y</th>
            <th *ngIf="getAvailableColumns().includes('type')">Lo·∫°i</th>
            <th *ngIf="getAvailableColumns().includes('materialCode')">M√£ h√†ng</th>
            <th *ngIf="getAvailableColumns().includes('poNumber')">PO</th>
            <th *ngIf="getAvailableColumns().includes('imd')">IMD</th>
            <th *ngIf="getAvailableColumns().includes('batch')">Batch</th>
            <th *ngIf="getAvailableColumns().includes('quantityIn')">L∆∞·ª£ng nh·∫≠p</th>
            <th *ngIf="getAvailableColumns().includes('quantityOut')">L∆∞·ª£ng xu·∫•t</th>
            <th *ngIf="getAvailableColumns().includes('productionOrder')">L·ªánh s·∫£n xu·∫•t</th>
            <th *ngIf="getAvailableColumns().includes('stock')">T·ªìn kho</th>
            <th *ngIf="getAvailableColumns().includes('qc')">QC</th>
            <th *ngIf="getAvailableColumns().includes('employee')">Ng∆∞·ªùi th·ª±c hi·ªán</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of traceRows" 
              [class.inbound-row]="row.type === 'inbound'" 
              [class.outbound-row]="row.type === 'outbound'" 
              [class.qc-row]="row.type === 'qc'"
              [class.stock-row]="row.type === 'inventory'">
            <td *ngIf="getAvailableColumns().includes('date')">{{ formatDate(row.date) }}</td>
            <td *ngIf="getAvailableColumns().includes('type')">
              <span class="type-badge" 
                    [class.inbound]="row.type === 'inbound'" 
                    [class.outbound]="row.type === 'outbound'" 
                    [class.qc]="row.type === 'qc'"
                    [class.stock]="row.type === 'inventory'">
                {{ getEventTypeLabel(row.type) }}
              </span>
            </td>
            <td *ngIf="getAvailableColumns().includes('materialCode')">{{ row.materialCode }}</td>
            <td *ngIf="getAvailableColumns().includes('poNumber')">{{ row.poNumber || '-' }}</td>
            <td *ngIf="getAvailableColumns().includes('imd')">{{ row.imd || '-' }}</td>
            <td *ngIf="getAvailableColumns().includes('batch')">{{ row.batch || '-' }}</td>
            <td *ngIf="getAvailableColumns().includes('quantityIn')" class="number-cell">
              <span *ngIf="row.quantityIn !== undefined">{{ row.quantityIn | number }}</span>
              <span *ngIf="row.quantityIn === undefined">-</span>
            </td>
            <td *ngIf="getAvailableColumns().includes('quantityOut')" class="number-cell">
              <span *ngIf="row.quantityOut !== undefined">{{ row.quantityOut | number }}</span>
              <span *ngIf="row.quantityOut === undefined">-</span>
            </td>
            <td *ngIf="getAvailableColumns().includes('productionOrder')">{{ row.productionOrder || '-' }}</td>
            <td *ngIf="getAvailableColumns().includes('stock')" class="number-cell">
              <span *ngIf="row.stock !== undefined">{{ row.stock | number }}</span>
              <span *ngIf="row.stock === undefined">-</span>
            </td>
            <td *ngIf="getAvailableColumns().includes('qc')">
              <span *ngIf="row.type === 'qc'">{{ row.qc || '-' }}</span>
              <span *ngIf="row.type !== 'qc'">-</span>
            </td>
            <td *ngIf="getAvailableColumns().includes('employee')">{{ row.employee || '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- No Data Message -->
  <div class="no-data" *ngIf="traceRows.length === 0 && materialCode && !isLoading">
    <i class="material-icons">info</i>
    <p>Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho m√£ h√†ng: {{ materialCode }}</p>
  </div>

  <!-- Initial Message -->
  <div class="initial-message" *ngIf="traceRows.length === 0 && !materialCode && !isLoading">
    <i class="material-icons">qr_code_scanner</i>
    <p>Vui l√≤ng qu√©t m√£ h√†ng ƒë·ªÉ xem l·ªãch s·ª≠ truy v·∫øt</p>
  </div>
</div>
