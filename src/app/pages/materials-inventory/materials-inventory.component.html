<div class="main-content">
  <!-- Excel-like Container -->
  <div class="excel-container">
    <!-- Report Title -->
    <div class="excel-header">
      <h4>üì¶ INVENTORY</h4>
    </div>
    <!-- Excel Actions -->
    <div class="excel-actions">
      <div class="action-controls">
        <div class="dropdown">
          <button class="custom-btn dropdown-toggle" type="button" (click)="toggleDropdown($event)">
            <i class="material-icons">more_vert</i>
            More
          </button>
          <div class="dropdown-menu" [class.show]="isDropdownOpen">
            <a class="dropdown-item" href="javascript:void(0)" (click)="importCatalog()">
              <i class="material-icons">upload_file</i>
              Import File Danh m·ª•c
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="downloadCatalogTemplate()">
              <i class="material-icons">download</i>
              T·∫£i Template Danh m·ª•c
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="importCurrentStock()">
              <i class="material-icons">upload_file</i>
              Import T·ªìn kho hi·ªán t·∫°i
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="downloadStockTemplate()">
              <i class="material-icons">download</i>
              T·∫£i Template T·ªìn kho
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="javascript:void(0)" (click)="downloadFIFOReport()">
              <i class="material-icons">warning</i>
              T·∫£i b√°o c√°o FIFO
            </a>
          </div>
        </div>
        
        <button class="custom-btn btn-success" (click)="refreshInventory()">
          <i class="material-icons">refresh</i>
          Refresh
        </button>
        
        <button class="custom-btn btn-warning" (click)="completeInventory()">
          <i class="material-icons">check_circle</i>
          Ho√†n th√†nh
        </button>
        
        <div class="search-box">
          <input type="text" 
                 placeholder="T√¨m ki·∫øm theo m√£, v·ªã tr√≠, t√™n, s·ªë l∆∞·ª£ng..." 
                 [(ngModel)]="searchTerm"
                 (input)="onSearchChange($event)"
                 class="custom-input">
        </div>
        <div class="iqc-counter">
          <span class="iqc-label">IQC:</span>
          <span class="iqc-count">{{getIQCCount()}}</span>
        </div>
        <div class="negative-counter">
          <span class="negative-label">√Çm:</span>
          <span class="negative-count">{{getNegativeStockCount()}}</span>
        </div>
      </div>
    </div>

    <!-- Excel-like Body -->
    <div class="excel-body">
      <table class="excel-table">
        <thead>
          <tr>
            <th class="row-header">#</th>
            <th>Ng√†y nh·∫≠p</th>
            <th>M√£ h√†ng</th>
            <th>Qu√©t</th>
            <th>T√™n h√†ng</th>
            <th>ƒê∆°n v·ªã</th>
            <th class="po-column">S·ªë P.O</th>
            <th>L∆∞·ª£ng Nh·∫≠p</th>
            <th>Xu·∫•t</th>
            <th>T·ªìn kho</th>
            <th>V·ªã tr√≠</th>
            <th>Change</th>
            <th>Lo·∫°i h√¨nh</th>
            <th>HSD</th>
            <th>KK</th>
            <th>Ghi ch√∫</th>
            <th>S·ªë ƒë∆°n v·ªã</th>
            <th>L∆∞u √Ω</th>
            <th>Tr·∫°ng th√°i</th>
            <th>X√≥a</th>
            <th>QR Code</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let material of filteredInventory; let i = index" 
              [class.duplicate-row]="material.isDuplicate"
              [class.iqc-row]="isIQCLocation(material.location)">
            <td class="row-header">{{i + 1}}</td>
            <td class="date-cell" [class.duplicate-cell]="material.isDuplicate">{{material.receivedDate | date:'dd/MM/yyyy'}}</td>
            <td class="code-cell material-code-cell" 
                [class.duplicate-cell]="material.isDuplicate"
                [class.duplicate-code]="isDuplicatePO(material)"
                [class.normal-code]="!isDuplicatePO(material)"
                [class.negative-stock]="hasNegativeStock(material)">{{material.materialCode}}</td>
            <td class="scan-cell">
              <button class="scan-qr-btn" 
                      (click)="scanQRCode(material)"
                      title="Qu√©t QR code ƒë·ªÉ xu·∫•t h√†ng">
                <i class="material-icons">qr_code</i>
                Scan
              </button>
            </td>
            <td class="material-name-cell" [class.duplicate-cell]="material.isDuplicate" 
                [title]="material.materialName || 'N/A'">{{material.materialName || 'N/A'}}</td>
            <td [class.duplicate-cell]="material.isDuplicate">{{material.unit}}</td>
            <td class="po-cell" [class.duplicate-cell]="material.isDuplicate">{{material.poNumber}}</td>
            <td class="number-cell" [class.duplicate-cell]="material.isDuplicate">{{formatNumber(material.quantity)}}</td>
            <td class="number-cell">
              <input type="number" 
                     class="editable-cell" 
                     [(ngModel)]="material.exported" 
                     (change)="updateExported(material)" 
                     min="0"
                     step="0.1"
                     [disabled]="!canExport">
            </td>
            <td class="number-cell" [class.duplicate-cell]="material.isDuplicate" 
                [class.negative-stock-cell]="calculateCurrentStock(material) < 0"
                [title]="'L∆∞·ª£ng nh·∫≠p: ' + (material.quantity || 0) + ' - Xu·∫•t: ' + (material.exported || 0) + ' = ' + calculateCurrentStock(material)">
              {{formatNumber(calculateCurrentStock(material))}}
            </td>
            <td class="location-cell" [class.iqc-location]="isIQCLocation(material.location)">
              <input type="text" 
                     class="editable-cell location-input" 
                     [(ngModel)]="material.location" 
                     (change)="updateLocation(material)"
                     (blur)="onLocationChange(material)">
            </td>
            <td class="change-cell">
              <button class="scan-change-btn" 
                      (click)="scanLocationChange(material)"
                      title="Scan QR ƒë·ªÉ thay ƒë·ªïi v·ªã tr√≠">
                <i class="material-icons">qr_code_scanner</i>
                Scan
              </button>
            </td>
            <td>
              <input type="text" class="editable-cell" [(ngModel)]="material.type" (change)="updateType(material)">
            </td>
            <td class="date-cell" [class.duplicate-cell]="material.isDuplicate">
              <div *ngIf="canEditHSD; else readOnlyHSD">
                <input type="date" 
                       class="editable-date-input" 
                       [value]="material.expiryDate | date:'yyyy-MM-dd'"
                       (change)="onHSDChange($event, material)"
                       title="Ch·ªânh s·ª≠a HSD">
              </div>
              <ng-template #readOnlyHSD>
                <span [title]="canEditHSD ? '' : 'B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a HSD'">
                  {{material.expiryDate ? (material.expiryDate | date:'dd/MM/yyyy') : ''}}
                </span>
              </ng-template>
            </td>
            <td class="status-cell">
              <mat-checkbox [checked]="material.qualityCheck" 
                           (change)="updateQualityCheck(material, $event)"
                           title="Ch·ªânh s·ª≠a tr·∫°ng th√°i KK">
              </mat-checkbox>
            </td>
            <td>
              <input type="text" class="editable-cell" [(ngModel)]="material.notes" (change)="updateNotes(material)">
            </td>
            <td class="number-cell" [class.duplicate-cell]="material.isDuplicate">
              <input type="number" 
                     class="editable-cell" 
                     [(ngModel)]="material.rollsOrBags" 
                     (change)="updateRollsOrBags(material)" 
                     min="0"
                     step="1">
            </td>
            <td>
              <input type="text" class="editable-cell" [(ngModel)]="material.remarks" (change)="updateRemarks(material)">
            </td>
            <td class="status-cell">
              <span class="badge" 
                    [class.badge-import]="material.importStatus === 'Import'"
                    [class.badge-success]="!material.importStatus || material.importStatus !== 'Import'">
                {{material.importStatus === 'Import' ? 'Import' : 'Inbound'}}
              </span>
            </td>
            <td class="status-cell">
              <button mat-icon-button color="warn" 
                      (click)="deleteInventoryItem(material)" 
                      [disabled]="!canDelete"
                      matTooltip="X√≥a item n√†y kh·ªèi Inventory">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
            <td class="qr-cell" *ngIf="material.importStatus === 'Import'">
              <button class="print-qr-btn" 
                      (click)="printQRCode(material)"
                      title="In tem QR code">
                <i class="material-icons">print</i>
                Print
              </button>
            </td>
            <td class="qr-cell" *ngIf="!material.importStatus || material.importStatus !== 'Import'">
              <button class="print-qr-btn disabled" 
                      title="Ch·ªâ c√≥ th·ªÉ in QR cho m√£ h√†ng Import">
                <i class="material-icons">print</i>
                Print
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- No Data Message -->
      <div class="no-data" *ngIf="filteredInventory.length === 0">
        <i class="material-icons">inventory</i>
        <h5>No Inventory Items</h5>
        <p>No materials have been marked as received in Inbound Materials tab</p>
      </div>
    </div>
  </div>

  <!-- QR Scanner Modal -->
  <div class="qr-scanner-modal" *ngIf="isScanning">
    <div class="modal-overlay" (click)="stopScanning()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h5>
          <i class="material-icons">qr_code_scanner</i>
          Qu√©t QR Code
        </h5>
        <button class="close-btn" (click)="stopScanning()">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="scanner-container">
          <div id="qr-reader"></div>
          <div class="scanner-overlay">
            <div class="scanner-frame"></div>
            <p class="scanner-hint">ƒê·∫∑t QR code v√†o khung h√¨nh</p>
          </div>
        </div>
        
        <div class="scanner-info" *ngIf="currentScanningMaterial">
          <p><strong>M√£ h√†ng:</strong> {{currentScanningMaterial.materialCode}}</p>
          <p><strong>PO:</strong> {{currentScanningMaterial.poNumber}}</p>
          <p><strong>T·ªìn kho:</strong> {{currentScanningMaterial.stock || currentScanningMaterial.quantity}}</p>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="stopScanning()">
          <i class="material-icons">cancel</i>
          H·ªßy
        </button>
      </div>
    </div>
  </div>

  <!-- Location Change Scanner Modal -->
  <div class="qr-scanner-modal" *ngIf="isScanningLocationChange">
    <div class="modal-overlay" (click)="stopLocationScanning()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h5>
          <i class="material-icons">location_on</i>
          Qu√©t QR V·ªã Tr√≠ M·ªõi
        </h5>
        <button class="close-btn" (click)="stopLocationScanning()">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="scanner-container">
          <div id="qr-reader-location"></div>
          <div class="scanner-overlay">
            <div class="scanner-frame"></div>
            <p class="scanner-hint">Qu√©t QR code v·ªã tr√≠ m·ªõi</p>
          </div>
        </div>
        
        <div class="scanner-info" *ngIf="currentLocationChangeMaterial">
          <p><strong>M√£ h√†ng:</strong> {{currentLocationChangeMaterial.materialCode}}</p>
          <p><strong>V·ªã tr√≠ hi·ªán t·∫°i:</strong> {{currentLocationChangeMaterial.location}}</p>
          <p><strong>PO:</strong> {{currentLocationChangeMaterial.poNumber}}</p>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="stopLocationScanning()">
          <i class="material-icons">cancel</i>
          H·ªßy
        </button>
      </div>
    </div>
  </div>
</div>
