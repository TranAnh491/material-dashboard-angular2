<div class="main-content">
  <div class="excel-container">
    <div class="excel-header">
      <h4>üì§ OUTBOUND ASM1</h4>
    </div>
    <!-- Excel-like Actions -->
    <div class="excel-actions">
      <div class="action-controls-horizontal">
                 <!-- Scanner Input for Batch Mode -->
         <div class="scanner-input-group">
           <input type="text" 
                  #scannerInput
                  [(ngModel)]="scannerBuffer"
                  (keydown)="onScannerKeydown($event)"
                  (blur)="onScannerInputBlur()"
                  placeholder="Qu√©t barcode/QR code cho batch scan..."
                  class="scanner-input"
                  [class.active]="isScannerInputActive">
         </div>

        <!-- Batch Scanning Mode Controls -->
        <div class="batch-scanning-controls" *ngIf="!isBatchScanningMode">
          <button class="batch-start-btn" 
                  (click)="startBatchScanningMode()"
                  title="B·∫Øt ƒë·∫ßu ch·∫ø ƒë·ªô scan batch">
            <i class="material-icons">playlist_add</i>
            Batch Scan
          </button>
        </div>

        <!-- Batch Scanning Mode Active -->
        <div class="batch-scanning-active" *ngIf="isBatchScanningMode">
          <div class="batch-info">
            <div class="batch-field">
              <label>L·ªánh s·∫£n xu·∫•t:</label>
              <span class="batch-value" [class.scanned]="isProductionOrderScanned">
                {{ batchProductionOrder || 'Ch∆∞a scan (KZLSX...)' }}
              </span>
            </div>
            <div class="batch-field">
              <label>M√£ nh√¢n vi√™n:</label>
              <div class="employee-scan-controls">
                <input type="text" 
                       [(ngModel)]="batchEmployeeId"
                       (keydown)="onEmployeeIdKeydown($event)"
                       placeholder="Ch∆∞a scan (ASP...)"
                       class="employee-input"
                       [class.scanned]="isEmployeeIdScanned"
                       [disabled]="isEmployeeIdScanned"
                       (focus)="onEmployeeInputFocus($event)">
                <button class="scan-employee-btn" 
                        (click)="focusEmployeeInput()"
                        [disabled]="isEmployeeIdScanned"
                        title="Focus v√†o √¥ nh·∫≠p m√£ nh√¢n vi√™n ƒë·ªÉ scan">
                  <i class="material-icons">input</i>
                  Scan
                </button>
              </div>
              <div class="scan-note" *ngIf="!isEmployeeIdScanned">
                <small>‚ö†Ô∏è Ph·∫£i scan m√£ nh√¢n vi√™n b·∫±ng m√°y scan tr∆∞·ªõc khi scan m√£ h√†ng</small>
              </div>
            </div>
            <div class="batch-field">
              <label>M√£ h√†ng ƒë√£ scan:</label>
              <span class="batch-count" [class.ready]="batchMaterials.length > 0">
                {{ batchMaterials.length }} / <span class="expected-count">?</span>
              </span>
            </div>
            <div class="batch-field" *ngIf="batchMaterials.length > 0">
              <label>M√£ h√†ng g·∫ßn nh·∫•t:</label>
              <span class="batch-value">
                {{ batchMaterials[batchMaterials.length - 1]?.materialCode || '' }}
              </span>
            </div>
            <div class="batch-status" *ngIf="batchMaterials.length > 0">
              <label>Tr·∫°ng th√°i:</label>
              <span class="status-indicator" [class.pending]="!isBatchCompleted" [class.completed]="isBatchCompleted">
                <span *ngIf="!isBatchCompleted">‚è≥ ƒêang scan... ({{ batchMaterials.length }} m√£ h√†ng)</span>
                <span *ngIf="isBatchCompleted">‚úÖ ƒê√£ ho√†n th√†nh ({{ batchMaterials.length }} m√£ h√†ng)</span>
              </span>
            </div>
            
            <!-- Tick x√°c nh·∫≠n ƒë√£ nh·∫≠n to√†n b·ªô l√¥ h√†ng -->
            <div class="batch-confirmation" *ngIf="batchMaterials.length > 0 && !isBatchCompleted">
              <label class="confirmation-label">
                <input type="checkbox" 
                       [(ngModel)]="isBatchFullyReceived" 
                       (change)="onBatchConfirmationChange()"
                       class="confirmation-checkbox">
                <span class="confirmation-text">
                  ‚úÖ ƒê√£ nh·∫≠n to√†n b·ªô l√¥ h√†ng ({{ batchMaterials.length }} m√£ h√†ng)
                </span>
              </label>
              <small class="confirmation-note">
                Tick v√†o √¥ n√†y ƒë·ªÉ x√°c nh·∫≠n ƒë√£ scan ƒë·ªß t·∫•t c·∫£ m√£ h√†ng trong l√¥
              </small>
            </div>
            
            <!-- Danh s√°ch m√£ h√†ng ƒë√£ scan -->
            <div class="batch-materials-list" *ngIf="batchMaterials.length > 0">
              <label>Danh s√°ch m√£ h√†ng:</label>
              <div class="materials-grid">
                <div class="material-item" *ngFor="let material of batchMaterials; let i = index">
                  <span class="material-number">{{ i + 1 }}</span>
                  <span class="material-code">{{ material.materialCode }}</span>
                  <span class="material-po">{{ material.poNumber }}</span>
                  <span class="material-qty">{{ material.quantity }}</span>
                </div>
              </div>
            </div>
          </div>
          <div class="batch-actions">
            <button class="batch-save-btn" 
                    (click)="saveBatchToOutbound()"
                    [disabled]="!isProductionOrderScanned || !isEmployeeIdScanned || batchMaterials.length === 0 || isBatchCompleted"
                    [title]="isBatchCompleted ? 'Batch ƒë√£ ho√†n th√†nh' : 'Ho√†n th√†nh batch scanning - L∆∞u t·∫•t c·∫£ m√£ h√†ng ƒë√£ scan'">
              <i class="material-icons">{{ isBatchCompleted ? 'check_circle' : 'check_circle' }}</i>
              <span *ngIf="!isBatchCompleted">Ho√†n th√†nh Batch ({{ batchMaterials.length }})</span>
              <span *ngIf="isBatchCompleted">ƒê√£ ho√†n th√†nh ({{ batchMaterials.length }})</span>
            </button>
            <button class="batch-cancel-btn" 
                    (click)="stopBatchScanningMode()"
                    title="H·ªßy batch scanning">
              <i class="material-icons">cancel</i>
              H·ªßy
            </button>
          </div>
        </div>
        
        <!-- More Dropdown -->
        <div class="dropdown" #dropdown>
          <button class="more-btn" type="button" (click)="toggleDropdown()">
            <i class="material-icons">more_vert</i>
            More
          </button>
          <div class="dropdown-menu" [class.show]="isDropdownOpen">
            <a class="dropdown-item" href="javascript:void(0)" (click)="exportToExcel(); closeDropdown()">
              <i class="material-icons">download</i>
              Export Excel
            </a>
            
            <a class="dropdown-item" href="javascript:void(0)" (click)="addMaterial(); closeDropdown()">
              <i class="material-icons">add</i>
              Th√™m Material
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="downloadReport(); closeDropdown()">
              <i class="material-icons">description</i>
              T·∫£i b√°o c√°o
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="cleanupData(); closeDropdown()">
              <i class="material-icons">cleaning_services</i>
              L√†m s·∫°ch d·ªØ li·ªáu
            </a>
          </div>
        </div>
        
                <!-- Refresh Button -->
        <button class="refresh-btn" (click)="loadMaterials()">
          <i class="material-icons">refresh</i>
          Refresh
        </button>

        <!-- Date Range Selector -->
        <div class="date-range-selector">
          <input type="date" 
                 [(ngModel)]="startDate" 
                 (change)="onDateRangeChange()"
                 class="date-input"
                 title="T·ª´ ng√†y">
          <span class="date-separator">‚Üí</span>
          <input type="date" 
                 [(ngModel)]="endDate" 
                 (change)="onDateRangeChange()"
                 class="date-input"
                 title="ƒê·∫øn ng√†y">
        </div>

        <!-- Factory Badge -->
        <span class="factory-badge asm1-badge">ASM1</span>
      </div>
    </div>
    <div class="loading-container" *ngIf="isLoading">
      <div class="loading-spinner">
        <i class="material-icons spinning">refresh</i>
        <span>ƒêang t·∫£i d·ªØ li·ªáu ASM1...</span>
      </div>
    </div>
    <div class="error-message" *ngIf="errorMessage">
      <i class="material-icons">error</i>
      {{errorMessage}}
    </div>
    <div class="excel-body" *ngIf="!isLoading">
      <table class="excel-table">
        <thead>
          <tr>
            <th>Factory</th>
            <th>#</th>
            <th>M√£ h√†ng</th>
            <th>S·ªë PO</th>
            <th>Xu·∫•t</th>
                         <th>Th·ªùi gian b·∫Øt ƒë·∫ßu</th>
             <th>Th·ªùi gian th·ª±c hi·ªán</th>
            <th>M√£ nh√¢n vi√™n</th>
            <th>L·ªánh s·∫£n xu·∫•t</th>
            <th>X√≥a</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let material of getPaginatedMaterials(); let i = index">
            <td class="factory-cell factory-asm1">ASM1</td>
            <td class="row-header">{{(currentPage - 1) * itemsPerPage + i + 1}}</td>
            <td class="code-cell">
              <input type="text" class="editable-input" [(ngModel)]="material.materialCode" (change)="updateMaterial(material)">
            </td>
            <td class="po-cell">
              <input type="text" class="editable-input" [(ngModel)]="material.poNumber" (change)="updateMaterial(material)">
            </td>
            <td class="number-cell">
              <input type="number" class="editable-input" [(ngModel)]="material.exportQuantity" (change)="updateMaterial(material)">
            </td>
                         <td class="date-cell">
               <input type="datetime-local" class="date-input" [value]="material.exportDate ? material.exportDate.toISOString().slice(0, 16) : ''" (change)="onExportDateChange($event, material)">
             </td>
             <td class="duration-cell">
               <span class="duration-display">{{ calculateDuration(material) }}</span>
             </td>
            <td class="employee-cell">
              <input type="text" class="editable-input" [(ngModel)]="material.employeeId" (change)="updateMaterial(material)" placeholder="ASP1234">
            </td>
            <td class="production-order-cell">
              <input type="text" class="editable-input" [(ngModel)]="material.productionOrder" (change)="updateMaterial(material)" placeholder="KZLSX12345678">
            </td>
            <td class="action-cell">
              <button class="action-btn delete-btn" (click)="deleteMaterial(material)">
                <i class="material-icons">delete</i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="pagination-container" *ngIf="totalPages > 1">
      <div class="pagination-info">Trang {{currentPage}} / {{totalPages}} - T·ªïng: {{filteredMaterials.length}} materials</div>
      <div class="pagination-controls">
        <button class="page-btn" (click)="previousPage()" [disabled]="currentPage <= 1">
          <i class="material-icons">chevron_left</i>
        </button>
        <button class="page-btn" *ngFor="let page of [].constructor(totalPages); let i = index" [class.active]="currentPage === i + 1" (click)="goToPage(i + 1)">{{i + 1}}</button>
        <button class="page-btn" (click)="nextPage()" [disabled]="currentPage >= totalPages">
          <i class="material-icons">chevron_right</i>
        </button>
      </div>
    </div>
  </div>

  <!-- QR Scanner Modal - Removed since we auto-export now -->
  <!-- <div class="qr-scanner-modal" *ngIf="isCameraScanning || lastScannedData"> -->
  
  <!-- QR Scanner Modal for Employee ID -->
  <div class="qr-scanner-modal" *ngIf="isCameraScanning">
    <div class="modal-content">
      <div class="modal-header">
        <h5>
          <i class="material-icons">qr_code_scanner</i>
          Scan M√£ Nh√¢n Vi√™n
        </h5>
        <button class="close-btn" (click)="stopScanning()">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="scanner-container">
          <div id="qr-reader"></div>
          <div class="scanner-overlay">
            <div class="scanner-frame"></div>
            <div class="scanner-hint">
              ƒê·∫∑t m√£ nh√¢n vi√™n v√†o khung ƒë·ªÉ scan
            </div>
          </div>
        </div>
        
        <div class="scanner-info">
          <h6>H∆∞·ªõng d·∫´n scan m√£ nh√¢n vi√™n:</h6>
          <p><strong>Format:</strong> ASP + 4 ch·ªØ s·ªë (v√≠ d·ª•: ASP1234)</p>
          <p><strong>L∆∞u √Ω:</strong> Ch·ªâ scan m√£ nh√¢n vi√™n, kh√¥ng scan m√£ h√†ng</p>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="stopScanning()">
          <i class="material-icons">close</i>
          ƒê√≥ng
        </button>
      </div>
    </div>
  </div>
</div>
