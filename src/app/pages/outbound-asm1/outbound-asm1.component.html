<div class="main-content">
  <div class="excel-container">
    <div class="excel-header">
      <h4>üì§ OUTBOUND ASM1</h4>
    </div>
    <!-- Excel-like Actions -->
    <div class="excel-actions">
      <div class="action-controls-horizontal">
        <!-- Mobile Scanner Method Selection -->
        <div class="mobile-scanner-selection" *ngIf="isMobile">
          <div class="scanner-method-buttons">
            <button class="method-btn" 
                    [class.active]="selectedScanMethod === 'camera'"
                    (click)="selectScanMethod('camera')"
                    title="S·ª≠ d·ª•ng Camera ƒë·ªÉ qu√©t QR">
              <i class="material-icons">camera_alt</i>
              <span>Camera</span>
            </button>
            <button class="method-btn" 
                    [class.active]="selectedScanMethod === 'scanner'"
                    (click)="selectScanMethod('scanner')"
                    title="S·ª≠ d·ª•ng Scanner v·∫≠t l√Ω">
              <i class="material-icons">qr_code_scanner</i>
              <span>Scanner</span>
            </button>
            <button class="start-btn-mobile" 
                    [disabled]="!selectedScanMethod"
                    (click)="selectedScanMethod === 'scanner' ? startBatchScanningMode() : startCameraScanning()"
                    title="B·∫Øt ƒë·∫ßu ch·∫ø ƒë·ªô scan">
              <i class="material-icons">play_arrow</i>
              <span>Start</span>
            </button>
          </div>
        </div>

        <!-- Scanner Input for Batch Mode - Always Active for Setup Modal -->
        <div class="scanner-input-group" [class.mobile-hidden]="selectedScanMethod === 'camera'">
          <input type="text" 
                 #scannerInput
                 [(ngModel)]="scannerBuffer"
                 (keydown)="onScannerKeydown($event)"
                 (blur)="onScannerInputBlur()"
                 placeholder="Qu√©t barcode/QR code..."
                 class="scanner-input"
                 [class.active]="isScannerInputActive || showScanningSetupModal"
                 autocomplete="off">
        </div>

        <!-- LSX Search Box - Desktop and Mobile -->
        <div class="lsx-search-box" *ngIf="!isBatchScanningMode">
          <input type="text" 
                 class="lsx-search-input"
                 [(ngModel)]="searchProductionOrder"
                 (keyup.enter)="searchByProductionOrder()"
                 [placeholder]="isMobile ? 'Nh·∫≠p LSX (vd: KZLSX1125/0040)' : 'Nh·∫≠p LSX ƒë·ªÉ xem (v√≠ d·ª•: KZLSX1125/0040)'"
                 title="Nh·∫≠p l·ªánh s·∫£n xu·∫•t v√† nh·∫•n Enter">
          <button class="search-btn" 
                  (click)="searchByProductionOrder()"
                  [disabled]="!searchProductionOrder || !searchProductionOrder.trim()"
                  title="T√¨m ki·∫øm LSX">
            <i class="material-icons">search</i>
          </button>
          <button class="clear-search-btn" 
                  *ngIf="selectedProductionOrder"
                  (click)="clearProductionOrderFilter()"
                  title="X√≥a v√† ·∫©n d·ªØ li·ªáu">
            <i class="material-icons">clear</i>
          </button>
        </div>

        <!-- Simple Start/Stop Controls -->
        <div class="scan-controls" *ngIf="!isBatchScanningMode && !isMobile">
          <button class="start-btn" 
                  (click)="startBatchScanningMode()"
                  title="B·∫Øt ƒë·∫ßu ch·∫ø ƒë·ªô scan">
            <i class="material-icons">play_arrow</i>
            Start
          </button>
        </div>

        <!-- Desktop Scanning Controls -->
        <div class="scan-controls-desktop" *ngIf="isBatchScanningMode && !isMobile">
          <div class="scan-status-desktop">
            <div class="status-item-desktop" [class.scanned]="isProductionOrderScanned">
              <i class="material-icons">{{ isProductionOrderScanned ? 'check_circle' : 'description' }}</i>
              <span>LSX: {{ batchProductionOrder || 'Ch∆∞a scan' }}</span>
            </div>
            <div class="status-item-desktop" [class.scanned]="isEmployeeIdScanned">
              <i class="material-icons">{{ isEmployeeIdScanned ? 'check_circle' : 'person' }}</i>
              <span>Nh√¢n vi√™n: {{ batchEmployeeId || 'Ch∆∞a scan' }}</span>
            </div>
          </div>
          
          <div class="scan-buttons-desktop">
            <button class="review-btn-desktop" 
                    (click)="showScanReview()"
                    title="Xem danh s√°ch ƒë√£ scan"
                    *ngIf="pendingScanData.length > 0 && !showScanReviewModal">
              <i class="material-icons">list</i>
              Review ({{ pendingScanData.length }})
            </button>
            <button class="done-btn-desktop" 
                    (click)="stopBatchScanningMode()"
                    title="Ho√†n th√†nh v√† l∆∞u t·∫•t c·∫£">
              <i class="material-icons">done</i>
              Done ({{ pendingScanData.length }})
            </button>
          </div>
        </div>

        <!-- Mobile Controls Only - Status info removed (using desktop status) -->
        <div class="scan-status-mobile" *ngIf="isBatchScanningMode">
          <div class="status-row">
            <button class="review-btn-mobile" 
                    (click)="showScanReview()"
                    title="Xem danh s√°ch ƒë√£ scan"
                    *ngIf="pendingScanData.length > 0 && !showScanReviewModal">
              <i class="material-icons">list</i>
              <span>Review ({{ pendingScanData.length }})</span>
            </button>
            <button class="done-btn-mobile" 
                    (click)="stopBatchScanningMode()"
                    title="D·ª´ng ch·∫ø ƒë·ªô scan v√† l∆∞u t·∫•t c·∫£">
              <i class="material-icons">done</i>
              <span>Done ({{ pendingScanData.length }})</span>
            </button>
            <button class="stop-camera-btn-mobile" 
                    (click)="stopCameraScanning()"
                    title="T·∫Øt camera"
                    *ngIf="isMobile && selectedScanMethod === 'camera'">
              <i class="material-icons">videocam_off</i>
              <span>T·∫Øt Camera</span>
            </button>
          </div>
          
          <!-- üîß S·ª¨A L·ªñI: Th√™m d√≤ng ch·ªØ h∆∞·ªõng d·∫´n khi ƒë√£ scan ƒë·ªß LSX v√† m√£ nh√¢n vi√™n -->
          <div class="scan-instruction" *ngIf="isProductionOrderScanned && isEmployeeIdScanned">
            <i class="material-icons">info</i>
            <span>ƒê∆∞·ª£c ph√©p scan xu·∫•t kho sau khi scan xong l·ªánh s·∫£n xu·∫•t v√† m√£ nh√¢n vi√™n</span>
            
            <!-- Camera scanning controls for materials -->
            <div class="material-scan-controls" *ngIf="selectedScanMethod === 'camera'">
              <button class="camera-scan-btn" 
                      (click)="startMaterialCameraScanning()"
                      title="M·ªü camera ƒë·ªÉ qu√©t m√£ h√†ng">
                <i class="material-icons">camera_alt</i>
                <span>Qu√©t M√£ H√†ng</span>
              </button>
              
              <button class="review-btn" 
                      (click)="showScanReview()"
                      title="Xem danh s√°ch ƒë√£ qu√©t"
                      *ngIf="pendingScanData.length > 0">
                <i class="material-icons">list</i>
                <span>Xem Danh S√°ch ({{ pendingScanData.length }})</span>
              </button>
              
              <button class="save-btn" 
                      (click)="saveScannedData()"
                      title="L∆∞u d·ªØ li·ªáu v√†o outbound"
                      *ngIf="pendingScanData.length > 0">
                <i class="material-icons">save</i>
                <span>L∆∞u ({{ pendingScanData.length }})</span>
              </button>
              
              <button class="stop-camera-btn" 
                      (click)="stopCameraScanning()"
                      title="T·∫Øt camera">
                <i class="material-icons">videocam_off</i>
                <span>T·∫Øt Camera</span>
              </button>
              
              <button class="reset-btn" 
                      (click)="resetScanningData()"
                      title="B·∫Øt ƒë·∫ßu l·∫°i t·ª´ ƒë·∫ßu">
                <i class="material-icons">refresh</i>
                <span>B·∫Øt ƒê·∫ßu L·∫°i</span>
              </button>
              
            </div>
          </div>
        </div>
        
        <!-- More Dropdown -->
        <div class="dropdown" #dropdown [class.mobile-hidden]="isMobile">
          <button class="more-btn" type="button" (click)="toggleDropdown()">
            <i class="material-icons">more_vert</i>
            More
          </button>
          <div class="dropdown-menu" [class.show]="isDropdownOpen">
            <a class="dropdown-item" href="javascript:void(0)" (click)="exportToExcel(); closeDropdown()">
              <i class="material-icons">download</i>
              Export T·∫•t C·∫£ D·ªØ Li·ªáu
            </a>
            
            <a class="dropdown-item" href="javascript:void(0)" (click)="addMaterial(); closeDropdown()">
              <i class="material-icons">add</i>
              Th√™m Material
            </a>
            
            <a class="dropdown-item" href="javascript:void(0)" (click)="downloadMonthlyHistory(); closeDropdown()">
              <i class="material-icons">calendar_month</i>
              T·∫£i D·ªØ Li·ªáu Theo Th√°ng
            </a>
            
            <a class="dropdown-item" href="javascript:void(0)" (click)="cleanupData(); closeDropdown()">
              <i class="material-icons">cleaning_services</i>
              L√†m s·∫°ch d·ªØ li·ªáu
            </a>
          </div>
        </div>
        
        
        <!-- Refresh Button -->
        <button class="refresh-btn" (click)="loadMaterials()" [class.mobile-hidden]="isMobile">
          <i class="material-icons">refresh</i>
          Refresh
        </button>

        <!-- Date Range Selector -->
        <div class="date-range-selector" [class.mobile-hidden]="isMobile">
          <input type="date" 
                 [(ngModel)]="startDate" 
                 (change)="onDateRangeChange()"
                 class="date-input"
                 title="T·ª´ ng√†y">
          <span class="date-separator">‚Üí</span>
          <input type="date" 
                 [(ngModel)]="endDate" 
                 (change)="onDateRangeChange()"
                 class="date-input"
                 title="ƒê·∫øn ng√†y">
          
          <!-- Toggle for hiding previous day's scan history -->
          <div class="history-toggle">
            <label class="toggle-label">
              <input type="checkbox" 
                     [(ngModel)]="hidePreviousDayHistory"
                     (change)="toggleHidePreviousDayHistory()"
                     class="toggle-checkbox">
              <span class="toggle-text">
                <i class="material-icons">{{ hidePreviousDayHistory ? 'visibility_off' : 'visibility' }}</i>
                {{ hidePreviousDayHistory ? '·∫®n l·ªãch s·ª≠ c≈©' : 'Hi·ªán t·∫•t c·∫£' }}
              </span>
            </label>
          </div>
          
          <!-- Reset to today button -->
          <button class="today-btn" 
                  (click)="resetToToday()"
                  title="Reset v·ªÅ ng√†y h√¥m nay">
            <i class="material-icons">today</i>
            H√¥m nay
          </button>
        </div>

        <!-- Factory Badge - üîß S·ª¨A L·ªñI: ·∫®n box ASM1 -->
        <!-- <span class="factory-badge asm1-badge">ASM1</span> -->
        
        <!-- Negative stock counter -->
        <!-- REMOVED: Negative stock counter - Kh√¥ng c·∫ßn t√≠nh stock ƒë·ªÉ scan nhanh -->
      </div>
    </div>
    <div class="loading-container" *ngIf="isLoading">
      <div class="loading-spinner">
        <i class="material-icons spinning">refresh</i>
        <span>ƒêang t·∫£i d·ªØ li·ªáu ASM1...</span>
      </div>
    </div>
    <div class="error-message" *ngIf="errorMessage">
      <i class="material-icons">error</i>
      {{errorMessage}}
    </div>
    <div class="excel-body" *ngIf="!isLoading">
      <!-- Desktop Table - Full Columns -->
      <table class="excel-table desktop-table" *ngIf="!isMobile">
        <thead>
          <tr>
            <th class="col-factory">Factory</th>
            <th class="col-index">#</th>
            <th class="col-date">Ng√†y xu·∫•t</th>
            <th class="col-material">M√£ h√†ng</th>
            <th class="col-po">S·ªë PO</th>
            <th class="col-batch">IMD</th>
            <th class="col-quantity">Xu·∫•t</th>
            <th class="col-employee">M√£ nh√¢n vi√™n</th>
            <th class="col-production">L·ªánh s·∫£n xu·∫•t</th>
            <th class="col-delete">X√≥a</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let material of getPaginatedMaterials(); let i = index">
            <td class="factory-cell readonly-cell">
              {{material.factory || 'ASM1'}}
            </td>
            <td class="index-cell readonly-cell">
              {{i + 1}}
            </td>
            <td class="date-cell readonly-cell">
              {{material.createdAt | date:'dd/MM/yyyy HH:mm'}}
            </td>
            <td class="code-cell readonly-cell">
              {{material.materialCode}}
            </td>
            <td class="po-cell readonly-cell">
              {{material.poNumber}}
            </td>
            <td class="batch-cell readonly-cell">
              {{material.importDate || 'N/A'}}
            </td>
            <td class="number-cell readonly-cell">
              {{material.exportQuantity}}
            </td>
            <td class="employee-cell readonly-cell">
              {{getDisplayEmployeeId(material.employeeId)}}
            </td>
            <td class="production-order-cell readonly-cell">
              {{material.productionOrder || 'N/A'}}
            </td>
            <td class="delete-cell">
              <button class="delete-btn" (click)="deleteMaterial(material)" title="X√≥a">
                <i class="material-icons">delete</i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Mobile Table - 6 Columns -->
      <table class="excel-table mobile-optimized" *ngIf="isMobile">
        <thead>
          <tr>
            <th class="col-material">M√£ h√†ng</th>
            <th class="col-po">S·ªë PO</th>
            <th class="col-batch">IMD</th>
            <th class="col-quantity">Xu·∫•t</th>
            <th class="col-employee">M√£ nh√¢n vi√™n</th>
            <th class="col-production">L·ªánh s·∫£n xu·∫•t</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let material of getPaginatedMaterials(); let i = index">
            <td class="code-cell readonly-cell">
              {{material.materialCode}}
            </td>
            <td class="po-cell readonly-cell">
              {{material.poNumber}}
            </td>
            <td class="batch-cell readonly-cell">
              {{material.importDate || 'N/A'}}
            </td>
            <td class="number-cell readonly-cell">
              {{material.exportQuantity}}
            </td>
            <td class="employee-cell readonly-cell">
              {{getDisplayEmployeeId(material.employeeId)}}
            </td>
            <td class="production-order-cell readonly-cell">
              {{material.productionOrder || 'N/A'}}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="pagination-container" *ngIf="totalPages > 1">
      <div class="pagination-info">Trang {{currentPage}} / {{totalPages}} - T·ªïng: {{filteredMaterials.length}} materials</div>
      <div class="pagination-controls">
        <button class="page-btn" (click)="previousPage()" [disabled]="currentPage <= 1">
          <i class="material-icons">chevron_left</i>
        </button>
        <button class="page-btn" *ngFor="let page of [].constructor(totalPages); let i = index" [class.active]="currentPage === i + 1" (click)="goToPage(i + 1)">{{i + 1}}</button>
        <button class="page-btn" (click)="nextPage()" [disabled]="currentPage >= totalPages">
          <i class="material-icons">chevron_right</i>
        </button>
      </div>
    </div>
  </div>

  <!-- QR Scanner Modal is now handled by QRScannerModalComponent -->

  <!-- Professional Scanning Setup Modal -->
  <div class="professional-scanning-modal" *ngIf="showScanningSetupModal">
    <div class="modal-overlay" (click)="closeScanningSetupModal()"></div>
    <div class="modal-content large-modal">
      <div class="modal-header">
        <h3>Qu√©t Xu·∫•t Kho - RM1 Outbound</h3>
        <button class="close-btn" (click)="closeScanningSetupModal()">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <div class="modal-body">
        <!-- Step 1: Scan LSX -->
        <div class="scan-step" *ngIf="scanningSetupStep === 'lsx'">
          <div class="step-header">
            <div class="step-number">1</div>
            <div class="step-title">
              <h4>Qu√©t L·ªánh S·∫£n Xu·∫•t (LSX)</h4>
              <p>Vui l√≤ng qu√©t m√£ l·ªánh s·∫£n xu·∫•t ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
            </div>
          </div>
          
          <div class="scan-input-section">
            <div class="scan-instruction-text">
              <i class="material-icons">qr_code_scanner</i>
              <p>Vui l√≤ng qu√©t m√£ l·ªánh s·∫£n xu·∫•t (LSX)</p>
              <small>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông chuy·ªÉn sang b∆∞·ªõc ti·∫øp theo sau khi qu√©t</small>
            </div>
          </div>
        </div>
        
        <!-- Step 2: Scan Employee ID -->
        <div class="scan-step" *ngIf="scanningSetupStep === 'employee'">
          <div class="step-header">
            <div class="step-number">2</div>
            <div class="step-title">
              <h4>Qu√©t M√£ Nh√¢n Vi√™n</h4>
              <p>Vui l√≤ng qu√©t m√£ nh√¢n vi√™n th·ª±c hi·ªán</p>
            </div>
          </div>
          
          <!-- LSX already scanned info -->
          <div class="scan-complete-info">
            <i class="material-icons success-icon">check_circle</i>
            <p>‚úÖ ƒê√£ qu√©t LSX: <strong>{{ batchProductionOrder }}</strong></p>
          </div>
          
          <div class="scan-input-section">
            <div class="scan-instruction-text">
              <i class="material-icons">qr_code_scanner</i>
              <p>Vui l√≤ng qu√©t m√£ nh√¢n vi√™n</p>
              <small>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông b·∫Øt ƒë·∫ßu scan h√†ng sau khi qu√©t m√£ nh√¢n vi√™n</small>
            </div>
          </div>
        </div>
        
        <!-- Pending Scan Data Section -->
        <div class="pending-data-section" *ngIf="pendingScanData.length > 0">
          <h4>Danh S√°ch ƒê√£ Scan ({{ pendingScanData.length }})</h4>
          <div class="scan-list">
            <div class="scan-item" *ngFor="let item of pendingScanData; let i = index">
              <div class="scan-item-header">
                <span class="scan-index">#{{ i + 1 }}</span>
                <span class="scan-time">{{ item.scanTime | date:'HH:mm:ss' }}</span>
              </div>
              <div class="scan-item-details">
                <div class="scan-detail">
                  <strong>M√£ h√†ng:</strong> {{ item.materialCode }}
                </div>
                <div class="scan-detail">
                  <strong>PO:</strong> {{ item.poNumber }}
                </div>
                <div class="scan-detail">
                  <strong>S·ªë l∆∞·ª£ng:</strong> {{ item.quantity }} KG
                </div>
                <div class="scan-detail" *ngIf="item.importDate">
                  <strong>IMD:</strong> {{ item.importDate }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="cancel-btn" (click)="closeScanningSetupModal()">
          <i class="material-icons">cancel</i>
          H·ªßy
        </button>
        <button class="confirm-btn" 
                *ngIf="pendingScanData.length > 0" 
                (click)="confirmAndSave()">
          <i class="material-icons">save</i>
          L∆∞u ({{ pendingScanData.length }})
        </button>
      </div>
    </div>
  </div>

  <!-- Scan Review Modal -->
  <div class="scan-review-modal" *ngIf="showScanReviewModal" (click)="closeScanReview()">
    <div class="scan-review-content" (click)="$event.stopPropagation()">
      <div class="scan-review-header">
        <h3>Danh S√°ch ƒê√£ Scan ({{ pendingScanData.length }})</h3>
        <button class="close-btn" (click)="closeScanReview()">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <!-- Removed duplicate LSX and Employee info - already shown in main status -->
      
      <div class="scan-review-list">
        <div class="scan-review-item" *ngFor="let item of pendingScanData; let i = index">
          <div class="scan-item-header">
            <span class="scan-index">#{{ i + 1 }}</span>
            <span class="scan-time">{{ item.scanTime | date:'HH:mm:ss' }}</span>
          </div>
          <div class="scan-item-details">
            <div class="scan-detail">
              <strong>M√£ h√†ng:</strong> {{ item.materialCode }}
            </div>
            <div class="scan-detail">
              <strong>PO:</strong> {{ item.poNumber }}
            </div>
            <div class="scan-detail">
              <strong>S·ªë l∆∞·ª£ng:</strong> {{ item.quantity }} KG
            </div>
            <div class="scan-detail" *ngIf="item.importDate">
              <strong>IMD:</strong> {{ item.importDate }}
            </div>
          </div>
        </div>
      </div>
      
      <div class="scan-review-footer">
        <button class="cancel-btn" (click)="closeScanReview()">
          <i class="material-icons">close</i>
          ƒê√≥ng
        </button>
        <button class="confirm-btn" (click)="confirmAndSave()">
          <i class="material-icons">save</i>
          X√°c Nh·∫≠n & L∆∞u
        </button>
      </div>
    </div>
  </div>
</div>
