<div class="main-content">
  <!-- Excel-like Container -->
  <div class="excel-container">
    <!-- Report Title -->
    <div class="excel-header">
      <h4>üì¶ INVENTORY ASM2</h4>
      <!-- Consolidation Status Message -->
      <div class="consolidation-message" *ngIf="showConsolidationMessage" [class.success]="consolidationMessage.includes('‚úÖ')" [class.info]="consolidationMessage.includes('‚ÑπÔ∏è')">
        <i class="material-icons">{{consolidationMessage.includes('‚úÖ') ? 'check_circle' : 'info'}}</i>
        <span>{{ consolidationMessage }}</span>
        <button class="close-message" (click)="showConsolidationMessage = false">
          <i class="material-icons">close</i>
        </button>
      </div>
      <!-- Catalog Loading Indicator -->
      <div class="catalog-status" *ngIf="isCatalogLoading">
        <i class="material-icons rotating">sync</i>
        <span>ƒêang t·∫£i danh m·ª•c h√†ng h√≥a...</span>
      </div>
    </div>
    
    <!-- Excel Actions -->
    <div class="excel-actions">
      <div class="action-controls-horizontal">
        <!-- More Button with Dropdown -->
        <div class="dropdown">
          <button class="more-btn" (click)="toggleDropdown($event)">
            <i class="material-icons">more_vert</i>
            More
          </button>
          <div class="dropdown-menu" [class.show]="isDropdownOpen">
            <a class="dropdown-item" href="javascript:void(0)" (click)="importCatalog()">
              <i class="material-icons">file_upload</i>
              Update Standard Packing
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="downloadCatalogTemplate()">
              <i class="material-icons">description</i>
              Download Standard Packing Template
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="importCurrentStock()">
              <i class="material-icons">file_upload</i>
              Import Current Stock
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item text-danger" href="javascript:void(0)" (click)="deleteAllASM2Data()">
              <i class="material-icons">delete_forever</i>
              üóëÔ∏è Delete All ASM2 Data
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="downloadStockTemplate()">
              <i class="material-icons">download</i>
              T·∫£i Template T·ªìn kho
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="exportToExcel()">
              <i class="material-icons">file_download</i>
              Export to Excel
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="javascript:void(0)" (click)="downloadFIFOReportASM2()">
              <i class="material-icons">warning</i>
              FIFO Report ASM2
            </a>
          </div>
        </div>
        
        <!-- Total Counter Box -->
        <div class="total-counter-box">
          <i class="material-icons">inventory_2</i>
          <span>T·ªïng: {{ filteredInventory.length }} m√£</span>
        </div>
        
        <!-- Search Type Selector -->
        <div class="search-type-selector">
          <div class="dropdown">
            <button class="search-type-dropdown" 
                    type="button" 
                    data-toggle="dropdown" 
                    aria-haspopup="true" 
                    aria-expanded="false">
              <i class="material-icons">{{searchType === 'material' ? 'inventory' : searchType === 'po' ? 'receipt' : 'place'}}</i>
              {{searchType === 'material' ? 'M√£' : searchType === 'po' ? 'PO' : 'V·ªã tr√≠'}}
            </button>
            <div class="dropdown-menu">
              <a class="dropdown-item" href="javascript:void(0)" (click)="changeSearchType('material')">
                <i class="material-icons">inventory</i>
                M√£
              </a>
              <a class="dropdown-item" href="javascript:void(0)" (click)="changeSearchType('po')">
                <i class="material-icons">receipt</i>
                PO
              </a>
              <a class="dropdown-item" href="javascript:void(0)" (click)="changeSearchType('location')">
                <i class="material-icons">place</i>
                V·ªã tr√≠
              </a>
            </div>
          </div>
        </div>
        
        <!-- Search Type Selector -->
        <div class="search-type-selector">
          <div class="dropdown">
            <button class="search-type-dropdown" 
                    type="button" 
                    data-toggle="dropdown" 
                    aria-haspopup="true" 
                    aria-expanded="false">
              <i class="material-icons">{{searchType === 'material' ? 'inventory' : searchType === 'po' ? 'receipt' : 'place'}}</i>
              {{searchType === 'material' ? 'M√£' : searchType === 'po' ? 'PO' : 'V·ªã tr√≠'}}
            </button>
            <div class="dropdown-menu">
              <a class="dropdown-item" href="javascript:void(0)" (click)="changeSearchType('material')">
                <i class="material-icons">inventory</i>
                M√£
              </a>
              <a class="dropdown-item" href="javascript:void(0)" (click)="changeSearchType('po')">
                <i class="material-icons">receipt</i>
                PO
              </a>
              <a class="dropdown-item" href="javascript:void(0)" (click)="changeSearchType('location')">
                <i class="material-icons">place</i>
                V·ªã tr√≠
              </a>
            </div>
          </div>
        </div>
        
        <!-- Search Box -->
        <div class="search-box">
          <input type="text"
                 [placeholder]="isLoading ? 'üîç ƒêang t·∫£i...' : 'Nh·∫≠p ƒë·ªÉ t√¨m ki·∫øm'"
                 [(ngModel)]="searchTerm"
                 (input)="onSearchInput($event)"
                 (keyup)="onSearchKeyUp($event)"
                 class="search-input"
                 [disabled]="isLoading">
          
          <!-- Clear search button -->
          <button class="clear-search-btn" 
                  *ngIf="searchTerm" 
                  (click)="clearSearch()" 
                  title="X√≥a t√¨m ki·∫øm">
            <i class="material-icons">clear</i>
          </button>
          
          <!-- Search warning -->
          <div class="search-warning" *ngIf="searchTerm && searchTerm.length < 3">
            <i class="material-icons">info</i>
            C·∫ßn √≠t nh·∫•t 3 k√Ω t·ª±
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
          <button class="refresh-btn" (click)="refreshInventory()" title="L√†m m·ªõi d·ªØ li·ªáu ASM2">
            <i class="material-icons">refresh</i>
            Refresh
          </button>
          <button class="sync-btn" (click)="syncFromInbound()" title="ƒê·ªìng b·ªô t·ª´ Inbound ASM2">
            <i class="material-icons">sync</i>
            Sync
          </button>
          <button class="reset-btn" (click)="resetZeroStock()" title="X√≥a h√†ng c√≥ t·ªìn kho = 0">
            <i class="material-icons">restart_alt</i>
            Reset
          </button>
          <button class="consolidate-btn" (click)="consolidateAllInventory()" title="G·ªôp d√≤ng tr√πng l·∫∑p theo Material+PO">
            <i class="material-icons">merge_type</i>
            G·ªôp d√≤ng
          </button>
        </div>
        
        <!-- Catalog Ready Icon -->
        <div class="catalog-ready-icon" *ngIf="!isCatalogLoading && catalogLoaded">
          <i class="material-icons">check_circle</i>
        </div>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading-container" *ngIf="isLoading">
      <div class="loading-spinner">
        <i class="material-icons rotating">sync</i>
        <span>ƒêang t·∫£i d·ªØ li·ªáu ASM2...</span>
      </div>
    </div>



    <!-- Table Container -->
    <div class="table-container" *ngIf="!isLoading">
      <!-- Table -->
      <table class="excel-table">
        <thead>
          <tr>
            <th>Factory</th>
            <th>STT</th>

            <th>M√£ h√†ng</th>
            <th>PO</th>
                            <th>Batch</th>
            <th>T·ªìn ƒë·∫ßu</th>
            <th>NK</th>
            <th title="S·ªë l∆∞·ª£ng ƒë√£ xu·∫•t t·ª´ RM2 outbound (t·ª± ƒë·ªông c·∫≠p nh·∫≠t)">ƒê√£ xu·∫•t</th>
            <th title="S·ªë l∆∞·ª£ng c·∫ßn xu·∫•t (nh·∫≠p tay)">XT</th>
            <th title="T·ªìn kho = T·ªìn ƒë·∫ßu + NK - ƒê√£ xu·∫•t - XT">T·ªìn kho</th>
            <th>V·ªã tr√≠</th>
            <th>Change</th>
            <th>Lo·∫°i H√¨nh</th>

            <th>Rolls/Bags</th>
            <th>L∆∞u √Ω</th>
            <th>Standard Packing</th>
            <th>Tr·∫°ng th√°i</th>
            <th>X√≥a</th>
            <th>QR</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let material of filteredInventory; trackBy: trackByFn; let i = index" 
              [class.duplicate-row]="material.isDuplicate"
              [class.iqc-row]="isIQCLocation(material.location)">
            <td class="factory-cell factory-asm2">
              ASM2
            </td>
            <td class="row-header">{{i + 1}}</td>
            <td class="code-cell material-code-cell" 
                [class.duplicate-cell]="material.isDuplicate"
                [class.duplicate-code]="material.isDuplicate"
                [class.normal-code]="!material.isDuplicate">
              {{material.materialCode}}
            </td>
            <td class="po-cell" [class.duplicate-cell]="material.isDuplicate">{{material.poNumber}}</td>
            <td class="date-cell" [class.duplicate-cell]="material.isDuplicate">
              {{material.importDate ? material.importDate.toLocaleDateString('en-GB').split('/').join('') : 'N/A'}}
            </td>
            <td class="number-cell" [class.duplicate-cell]="material.isDuplicate">
              <input type="number" 
                     class="opening-stock-input" 
                     [ngModel]="material.openingStock || ''"
                     (ngModelChange)="material.openingStock = $event === '' ? null : +$event" 
                     (change)="updateOpeningStock(material)" 
                     min="0" 
                     step="0.1" 
                     [placeholder]="material.openingStock ? '' : 'Nh·∫≠p t·ªìn ƒë·∫ßu'">
            </td>
            <td class="number-cell" [class.duplicate-cell]="material.isDuplicate">{{formatNumber(material.quantity)}}</td>
            <!-- C·ªôt "ƒê√£ xu·∫•t" - C√≥ th·ªÉ edit khi m·ªü kh√≥a -->
            <td class="number-cell" 
                [class.readonly-cell]="!isExportColumnUnlocked"
                [class.editable-export-cell]="isExportColumnUnlocked"
                [title]="isExportColumnUnlocked ? 'Click ƒë·ªÉ s·ª≠a s·ªë l∆∞·ª£ng ƒë√£ xu·∫•t' : 'S·ªë l∆∞·ª£ng ƒë√£ xu·∫•t t·ª´ RM2 outbound: ' + (material.exported || 0) + '\nT·ª± ƒë·ªông c·∫≠p nh·∫≠t v√† l∆∞u tr·ªØ vƒ©nh vi·ªÖn\nK·ªÉ c·∫£ khi x√≥a d√≤ng xu·∫•t ·ªü outbound c≈©ng kh√¥ng ·∫£nh h∆∞·ªüng'">
              <ng-container *ngIf="!isExportColumnUnlocked">
                {{formatNumber(material.exported || 0)}}
              </ng-container>
              <ng-container *ngIf="isExportColumnUnlocked">
                <input type="number" 
                       class="editable-input" 
                       [ngModel]="material.exported || 0"
                       (ngModelChange)="material.exported = $event === '' ? 0 : +$event"
                       (change)="updateExportedAmount(material)"
                       min="0" 
                       step="0.1"
                       placeholder="0">
              </ng-container>
            </td>
                        <!-- C·ªôt "XT" - S·ªë l∆∞·ª£ng c·∫ßn xu·∫•t (nh·∫≠p tay) -->
            <td class="number-cell xt-column">
              <input type="number" 
                     class="editable-cell" 
                     [(ngModel)]="material.xt" 
                     (change)="updateXT(material)" 
                     min="0" 
                     step="0.1" 
                     placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng XT">
            </td>
            <td class="number-cell" [class.duplicate-cell]="material.isDuplicate" 
                [class.negative-stock-cell]="calculateCurrentStock(material) < 0"
                [title]="'L∆∞·ª£ng nh·∫≠p: ' + (material.quantity || 0) + ' - Xu·∫•t: ' + (material.exported || 0) + ' - XT: ' + (material.xt || 0) + ' = ' + calculateCurrentStock(material)">
              {{formatNumber(calculateCurrentStock(material))}}
            </td>
            <td class="location-cell" [class.iqc-location]="isIQCLocation(material.location)">
              <input type="text" 
                     class="editable-cell location-input" 
                     [(ngModel)]="material.location" 
                     (change)="updateLocation(material)"
                     (blur)="onLocationChange(material)">
            </td>
            <td class="change-cell">
              <button class="scan-change-btn" 
                      (click)="scanLocationQR(material)"
                      title="Scan QR ƒë·ªÉ thay ƒë·ªïi v·ªã tr√≠">
                <i class="material-icons">qr_code_scanner</i>
                Scan
              </button>
            </td>
            <td>
              <input type="text" class="editable-cell" [(ngModel)]="material.type" (change)="updateType(material)">
            </td>

            <td class="rolls-bags-cell">
              <input type="number" 
                     class="editable-input" 
                     [(ngModel)]="material.rollsOrBags" 
                     (change)="updateMaterial(material)" 
                     min="0" 
                     placeholder="Rolls/Bags">
            </td>
            <td class="notes-cell">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.remarks" 
                     (change)="updateRemarks(material)"
                     placeholder="Nh·∫≠p l∆∞u √Ω..."
                     title="L∆∞u √Ω t·ª´ inbound">
            </td>
            <td class="standard-packing-cell">
              <span class="standard-packing-value">{{ getStandardPacking(material.materialCode) }}</span>
            </td>
            <td class="status-cell">
              <span class="badge" 
                    [class]="getStatusClass(material)">
                {{ getStatusText(material) }}
              </span>
            </td>
            <td class="delete-cell">
              <button class="delete-btn" 
                      *ngIf="canDelete"
                      (click)="deleteInventoryItem(material)"
                      title="X√≥a item n√†y kh·ªèi ASM2 Inventory">
                <i class="material-icons">delete</i>
              </button>
            </td>
            <td class="qr-cell">
              <button class="qr-btn" 
                      (click)="printQRCode(material)"
                      [disabled]="!isRollsOrBagsValid(material)"
                      [title]="!isRollsOrBagsValid(material) ? 'Kh√¥ng th·ªÉ in QR - thi·∫øu Rolls/Bags' : 'T·∫°o QR code'">
                <i class="material-icons">qr_code</i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Empty State - Search First Approach -->
      <div class="empty-state" *ngIf="!searchTerm && filteredInventory.length === 0 && !isLoading">
        <div class="empty-state-content">
          <i class="material-icons">search</i>
          <h3>üîç T√¨m ki·∫øm ASM2 Inventory</h3>
          <p>Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm materials trong ASM2 inventory</p>
          
          <!-- Search Suggestions -->
          <div class="search-suggestions">
            <h5>üí° G·ª£i √Ω t√¨m ki·∫øm:</h5>
            <div class="suggestion-tags">
              <span class="suggestion-tag" (click)="searchTerm = 'B018694'; onSearchInput({target: {value: 'B018694'}})">B018694</span>
              <span class="suggestion-tag" (click)="searchTerm = 'PO123'; onSearchInput({target: {value: 'PO123'}})">PO123</span>
              <span class="suggestion-tag" (click)="searchTerm = 'Location A'; onSearchInput({target: {value: 'Location A'}})">Location A</span>
            </div>
          </div>
          
          <!-- Quick Stats -->
          <div class="quick-stats">
            <div class="stat-item">
              <i class="material-icons">factory</i>
              <span>ASM2 Factory</span>
            </div>
            <div class="stat-item">
              <i class="material-icons">inventory</i>
              <span>Real-time Search</span>
            </div>
            <div class="stat-item">
              <i class="material-icons">speed</i>
              <span>Fast Loading</span>
            </div>
          </div>
        </div>
      </div>

      <!-- No Search Results -->
      <div class="no-results" *ngIf="searchTerm && filteredInventory.length === 0 && !isLoading">
        <div class="no-results-content">
          <i class="material-icons">search_off</i>
          <h4>üîç Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h4>
          <p>Kh√¥ng t√¨m th·∫•y materials n√†o cho "<strong>{{searchTerm}}</strong>" trong ASM2</p>
          
          <!-- Search Tips -->
          <div class="search-tips">
            <h6>üí° M·∫πo t√¨m ki·∫øm:</h6>
            <ul>
              <li>Ki·ªÉm tra ch√≠nh t·∫£</li>
              <li>Th·ª≠ t√¨m ki·∫øm v·ªõi √≠t k√Ω t·ª± h∆°n</li>
              <li>Ki·ªÉm tra factory filter (ASM2)</li>
              <li>Th·ª≠ t√¨m ki·∫øm theo PO number</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading-state" *ngIf="isLoading">
        <div class="loading-content">
          <i class="material-icons rotating">sync</i>
          <h4>üîç ƒêang t√¨m ki·∫øm...</h4>
          <p>T√¨m ki·∫øm "<strong>{{searchTerm}}</strong>" trong ASM2 inventory</p>
        </div>
      </div>
    </div>
  </div>
</div>
