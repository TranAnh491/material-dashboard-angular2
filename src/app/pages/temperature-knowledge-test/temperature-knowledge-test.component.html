<div class="temperature-test-container">
  <!-- Employee Information Form -->
  <div class="container" *ngIf="currentView === 'employee-form'">
    <div class="header">
      <h1>B√ÄI KI·ªÇM TRA QUY TR√åNH</h1>
      <h2>GHI NH·∫¨N NHI·ªÜT ƒê·ªò, ƒê·ªò ·∫®M V√Ä L∆ØU TR·ªÆ S·∫¢N PH·∫®M</h2>
    </div>

    <div class="employee-form-section">
      <h3>üìù Th√¥ng tin ng∆∞·ªùi l√†m b√†i:</h3>
      <form class="employee-form">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>M√£ s·ªë nh√¢n vi√™n</mat-label>
          <input matInput [(ngModel)]="employeeInfo.employeeId" name="employeeId" required 
                 placeholder="Nh·∫≠p m√£ s·ªë nh√¢n vi√™n">
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>H·ªç v√† t√™n</mat-label>
          <input matInput [(ngModel)]="employeeInfo.employeeName" name="employeeName" required 
                 placeholder="Nh·∫≠p h·ªç v√† t√™n ƒë·∫ßy ƒë·ªß">
        </mat-form-field>

        <div class="form-actions">
          <button mat-raised-button color="primary" 
                  (click)="startPreview()" 
                  [disabled]="!isEmployeeFormValid()">
            <mat-icon>visibility</mat-icon>
            Xem th√¥ng tin b√†i ki·ªÉm tra
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Preview Section -->
  <div class="container" *ngIf="currentView === 'preview'">
    <div class="header">
      <h1>{{ testData.title.split(' ')[0] + ' ' + testData.title.split(' ')[1] + ' ' + testData.title.split(' ')[2] }}</h1>
      <h2>{{ testData.title.split(' ').slice(3).join(' ') }}</h2>
    </div>

    <div class="employee-info-display">
      <p><strong>Ng∆∞·ªùi l√†m b√†i:</strong> {{ employeeInfo.employeeName }} ({{ employeeInfo.employeeId }})</p>
    </div>

    <div class="company-info">
      <p><strong>M√£ t√†i li·ªáu:</strong> {{ testData.documentCode }}</p>
      <p><strong>Ng√†y ban h√†nh:</strong> {{ testData.issueDate }}</p>
    </div>

    <div class="test-info">
      <h3>üìã Th√¥ng tin b√†i ki·ªÉm tra:</h3>
      <ul>
        <li><strong>T·ªïng s·ªë c√¢u h·ªèi:</strong> {{ testData.totalQuestions }} c√¢u</li>
        <li><strong>Th·ªùi gian l√†m b√†i:</strong> {{ testData.timeLimit }} ph√∫t</li>
        <li><strong>ƒêi·ªÉm ƒë·∫°t:</strong> {{ testData.passingScore }}% ({{ (testData.totalQuestions * testData.passingScore / 100) | number:'1.0-0' }}/{{ testData.totalQuestions }} c√¢u ƒë√∫ng)</li>
        <li><strong>D·∫°ng c√¢u h·ªèi:</strong> Tr·∫Øc nghi·ªám, ƒê√∫ng/Sai, ƒêi·ªÅn t·ª´</li>
      </ul>
    </div>

    <div class="action-section">
      <button mat-raised-button color="primary" (click)="startTest()" class="start-test-btn">
        <mat-icon>play_arrow</mat-icon>
        B·∫Øt ƒë·∫ßu l√†m b√†i
      </button>
      <button mat-stroked-button (click)="currentView = 'employee-form'" class="back-btn">
        <mat-icon>arrow_back</mat-icon>
        Quay l·∫°i
      </button>
    </div>

    <div class="download-section">
      <h3>üì• T·∫£i xu·ªëng t√†i li·ªáu tham kh·∫£o:</h3>
      <button mat-raised-button color="accent" class="download-btn" (click)="downloadExcel()" [disabled]="isLoading">
        <mat-icon>file_download</mat-icon>
        üìä T·∫£i xu·ªëng Excel
      </button>
    </div>
  </div>

  <!-- Test Interface -->
  <div class="container test-container" *ngIf="currentView === 'test'">
    <div class="test-header">
      <div class="test-progress">
        <h2>{{ getCurrentSection()?.title }}</h2>
        <p>C√¢u {{ getQuestionNumber() }}/{{ testData.totalQuestions }}</p>
        <mat-progress-bar mode="determinate" [value]="(getQuestionNumber() / testData.totalQuestions) * 100"></mat-progress-bar>
      </div>
      <div class="employee-info">
        <p><strong>{{ employeeInfo.employeeName }}</strong> ({{ employeeInfo.employeeId }})</p>
      </div>
    </div>



    <div class="question-section" *ngIf="getCurrentQuestion() as question">
      <div class="question-type-badge">
        {{ question.type === 'multiple-choice' ? 'TR·∫ÆC NGHI·ªÜM' : question.type === 'true-false' ? 'ƒê√öNG/SAI' : 'ƒêI·ªÄN T·ª™' }}
      </div>
      
      <div class="question-text">
        <h3>C√¢u {{ getQuestionNumber() }}: {{ question.question }}</h3>
      </div>

      <!-- Multiple Choice Questions -->
      <div class="answer-options" *ngIf="question.type === 'multiple-choice'">
        <mat-radio-group [value]="getSelectedAnswer()" (change)="selectAnswer($event.value)">
          <mat-radio-button 
            *ngFor="let option of question.options; let i = index" 
            [value]="getOptionLabel(i)"
            class="answer-option">
            {{ getOptionLabel(i) }}. {{ option }}
          </mat-radio-button>
        </mat-radio-group>
      </div>

      <!-- True/False Questions -->
      <div class="answer-options" *ngIf="question.type === 'true-false'">
        <mat-radio-group [value]="getSelectedAnswer()" (change)="selectAnswer($event.value)">
          <mat-radio-button value="true" class="answer-option">
            ‚úì ƒê√öNG
          </mat-radio-button>
          <mat-radio-button value="false" class="answer-option">
            ‚úó SAI
          </mat-radio-button>
        </mat-radio-group>
      </div>

      <!-- Fill in the blank Questions -->
      <div class="answer-options" *ngIf="question.type === 'fill-blank'">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>ƒêi·ªÅn c√¢u tr·∫£ l·ªùi</mat-label>
          <textarea matInput [value]="getSelectedAnswer() || ''" 
                    (input)="selectAnswer($any($event.target).value)"
                    rows="3" 
                    placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..."></textarea>
        </mat-form-field>
      </div>
    </div>



    <div class="test-navigation">
      <button mat-stroked-button 
              (click)="previousQuestion()" 
              [disabled]="currentSectionIndex === 0 && currentQuestionIndex === 0">
        <mat-icon>arrow_back</mat-icon>
        C√¢u tr∆∞·ªõc
      </button>
      
      <button mat-raised-button color="primary" 
              (click)="nextQuestion()" 
              [disabled]="!canGoNext()">
        <mat-icon>{{ isLastQuestion() ? 'check' : 'arrow_forward' }}</mat-icon>
        {{ isLastQuestion() ? 'Ho√†n th√†nh' : 'C√¢u ti·∫øp theo' }}
      </button>
    </div>
  </div>

  <!-- Result Display -->
  <div class="container result-container" *ngIf="currentView === 'result' && testResult">
    <div class="result-header">
      <h1>K·∫æT QU·∫¢ B√ÄI KI·ªÇM TRA</h1>
      <div class="result-badge" [class.passed]="testResult.passed" [class.failed]="!testResult.passed">
        {{ testResult.passed ? 'ƒê·∫†T' : 'KH√îNG ƒê·∫†T' }}
      </div>
    </div>

    <div class="result-summary">
      <div class="result-info">
        <p><strong>Ng∆∞·ªùi l√†m b√†i:</strong> {{ testResult.employeeInfo.employeeName }}</p>
        <p><strong>M√£ nh√¢n vi√™n:</strong> {{ testResult.employeeInfo.employeeId }}</p>
        <p><strong>Th·ªùi gian ho√†n th√†nh:</strong> {{ formatTime(testResult.completedAt) }} - {{ formatDate(testResult.completedAt) }}</p>
      </div>

      <div class="score-display">
        <div class="score-circle" [class.passed]="testResult.passed" [class.failed]="!testResult.passed">
          <span class="score-percentage">{{ testResult.percentage }}%</span>
          <span class="score-fraction">{{ testResult.score }}/{{ testResult.testData.totalQuestions }}</span>
        </div>
      </div>
    </div>

    <!-- Signature Section -->
    <div class="signature-section" *ngIf="signatureRequired">
      <div class="signature-prompt">
        <h3>‚úçÔ∏è Ch·ªØ k√Ω x√°c nh·∫≠n</h3>
        <p>Vui l√≤ng k√Ω t√™n ƒë·ªÉ x√°c nh·∫≠n k·∫øt qu·∫£ b√†i ki·ªÉm tra v√† l∆∞u v√†o h·ªá th·ªëng.</p>
        <p style="font-size: 14px; color: #e67e22; font-weight: 500;">
          <mat-icon style="font-size: 16px; vertical-align: middle;">info</mat-icon>
          Sau khi k√Ω (ho·∫∑c b·ªè qua), k·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o Firebase v√† b·∫°n c√≥ th·ªÉ t·∫£i PDF.
        </p>
        
        <div class="signature-pad-container" *ngIf="showSignature">
          <div class="signature-canvas-wrapper">
            <canvas #signatureCanvas 
                    width="400" 
                    height="200" 
                    style="border: 2px solid #ddd; border-radius: 8px; background: white;">
            </canvas>
          </div>
          
          <div class="signature-controls">
            <button mat-stroked-button (click)="clearSignature()" class="clear-btn">
              <mat-icon>clear</mat-icon>
              X√≥a ch·ªØ k√Ω
            </button>
            <button mat-raised-button color="primary" (click)="saveSignature()" 
                    [disabled]="isSignatureEmpty()" class="save-signature-btn">
              <mat-icon>check</mat-icon>
              L∆∞u ch·ªØ k√Ω
            </button>
          </div>
        </div>

        <div class="signature-actions" *ngIf="!showSignature">
          <button mat-raised-button color="accent" (click)="showSignaturePad()" class="sign-btn">
            <mat-icon>edit</mat-icon>
            K√Ω t√™n
          </button>
          <button mat-stroked-button color="primary" (click)="skipSignature()" class="skip-btn">
            <mat-icon>skip_next</mat-icon>
            B·ªè qua ch·ªØ k√Ω
          </button>
        </div>
      </div>
    </div>

    <div class="result-actions" *ngIf="!signatureRequired">
      <button mat-raised-button color="primary" (click)="downloadResultFile()">
        <mat-icon>picture_as_pdf</mat-icon>
        üìÑ T·∫£i k·∫øt qu·∫£ PDF
      </button>
      <button mat-stroked-button (click)="restartTest()">
        <mat-icon>refresh</mat-icon>
        L√†m l·∫°i
      </button>
    </div>

    <div class="detailed-results">
      <h3>Chi ti·∫øt c√¢u tr·∫£ l·ªùi:</h3>
      <div class="section-results" *ngFor="let section of testData.sections; let sectionIndex = index">
        <h4>{{ section.title }}</h4>
        <div class="question-results">
          <div *ngFor="let question of section.questions; let questionIndex = index" 
               class="question-result"
               [class.correct]="getAnswerResult(sectionIndex, questionIndex)?.isCorrect"
               [class.incorrect]="!getAnswerResult(sectionIndex, questionIndex)?.isCorrect">
            <div class="question-number">C√¢u {{ getDetailedQuestionNumber(sectionIndex, questionIndex) }}</div>
            <div class="question-status">
              <mat-icon>{{ getAnswerResult(sectionIndex, questionIndex)?.isCorrect ? 'check_circle' : 'cancel' }}</mat-icon>
            </div>
            <div class="question-details">
              <p class="question-text">{{ question.question }}</p>
              <p class="selected-answer">ƒê√°p √°n ch·ªçn: {{ getAnswerResult(sectionIndex, questionIndex)?.selectedAnswer || 'Kh√¥ng tr·∫£ l·ªùi' }}</p>
              <p class="correct-answer">ƒê√°p √°n ƒë√∫ng: {{ question.correctAnswer }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" [class.show]="isLoading">
    <div class="spinner-container">
      <mat-spinner></mat-spinner>
      <p>{{ currentView === 'result' ? 'ƒêang x·ª≠ l√Ω k·∫øt qu·∫£...' : 'ƒêang t·∫°o file...' }}</p>
    </div>
  </div>

  <!-- Success Notification -->
  <div class="notification" [class.show]="showNotification">
    <div class="notification-content">
      <mat-icon class="notification-icon">check_circle</mat-icon>
      <span class="notification-text">File ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng th√†nh c√¥ng!</span>
    </div>
  </div>
</div> 