<div class="stock-check-wrapper">
  <!-- Factory Selection Screen - Show when no factory selected -->
  <div class="factory-selection-screen" *ngIf="!selectedFactory">
    <div class="selection-header">
      <h1><i class="material-icons">inventory</i> STOCK CHECK</h1>
      <p class="subtitle">Chọn nhà máy để bắt đầu kiểm kê</p>
    </div>
    
    <div class="factory-cards">
      <button 
        type="button"
        class="factory-card asm1-card"
        (click)="selectFactory('ASM1')">
        <div class="card-icon">
          <i class="material-icons">factory</i>
        </div>
        <div class="card-title">ASM1</div>
        <div class="card-subtitle">Nhà máy 1</div>
        <div class="card-arrow">
          <i class="material-icons">arrow_forward</i>
        </div>
      </button>
      
      <button 
        type="button"
        class="factory-card asm2-card"
        (click)="selectFactory('ASM2')">
        <div class="card-icon">
          <i class="material-icons">factory</i>
        </div>
        <div class="card-title">ASM2</div>
        <div class="card-subtitle">Nhà máy 2</div>
        <div class="card-arrow">
          <i class="material-icons">arrow_forward</i>
        </div>
      </button>
    </div>
  </div>

  <!-- Stock Check Interface - Show when factory selected -->
  <div class="stock-check-container" *ngIf="selectedFactory">
    <!-- Top Bar - Title on top, buttons below -->
    <div class="top-bar">
      <h2 class="factory-title">
        <i class="material-icons">factory</i>
        {{ selectedFactory }} - KIỂM KÊ
        <span class="employee-id-display" *ngIf="currentEmployeeId">
          <i class="material-icons">badge</i>
          ID: {{ currentEmployeeId }}
        </span>
      </h2>
      
      <div class="top-bar-actions">
        <button class="back-btn" (click)="backToSelection()" title="Quay lại chọn nhà máy">
          <i class="material-icons">arrow_back</i>
          <span>QUAY LẠI</span>
        </button>
        
        <button class="logout-btn" *ngIf="currentEmployeeId" (click)="logoutEmployee()" title="Đăng xuất">
          <i class="material-icons">logout</i>
          <span>ĐĂNG XUẤT</span>
        </button>
        
        <button class="reset-btn" (click)="openResetModal()" title="Reset stock check">
          <i class="material-icons">refresh</i>
          <span>RESET</span>
        </button>
        
        <button class="history-btn" (click)="loadArchiveHistory()" title="Xem lịch sử kiểm kê">
          <i class="material-icons">history</i>
          <span>LỊCH SỬ</span>
        </button>
        
        <button class="inventory-btn" (click)="startInventoryCheck()">
          <i class="material-icons">qr_code_scanner</i>
          KIỂM KÊ
        </button>
        
        <button class="report-btn" (click)="exportStockCheckReport()">
          <i class="material-icons">download</i>
          REPORT
        </button>
        
        <div class="search-box">
          <i class="material-icons">search</i>
          <input 
            type="text" 
            class="search-input"
            [(ngModel)]="searchInput"
            (input)="onSearchInput()"
            (keyup.enter)="onSearchInput()"
            (keyup)="searchInput = searchInput.toUpperCase()"
            placeholder="Tìm kiếm mã hàng, PO, IMD...">
          <button 
            class="clear-search-btn" 
            *ngIf="searchInput"
            (click)="clearSearch()"
            title="Xóa tìm kiếm">
            <i class="material-icons">close</i>
          </button>
        </div>
      </div>
    </div>

  <!-- Data Table -->
  <div class="data-section">
    <!-- Counter Boxes -->
    <div class="counter-boxes">
      <div class="counter-box total-box clickable" 
           [class.active]="filterMode === 'all'"
           (click)="setFilterMode('all')"
           title="Click để hiển thị tất cả">
        <div class="counter-icon">
          <i class="material-icons">inventory_2</i>
        </div>
        <div class="counter-info">
          <div class="counter-label">TỔNG MÃ</div>
          <div class="counter-value">{{ totalMaterials }}</div>
        </div>
      </div>

      <div class="counter-box checked-box clickable" 
           [class.active]="filterMode === 'checked'"
           (click)="setFilterMode('checked')"
           title="Click để hiển thị mã đã kiểm tra">
        <div class="counter-icon">
          <i class="material-icons">check_circle</i>
        </div>
        <div class="counter-info">
          <div class="counter-label">ĐÃ KIỂM TRA</div>
          <div class="counter-value">{{ checkedMaterials }}</div>
        </div>
      </div>

      <div class="counter-box unchecked-box clickable" 
           [class.active]="filterMode === 'unchecked'"
           (click)="setFilterMode('unchecked')"
           title="Click để hiển thị mã chưa kiểm tra">
        <div class="counter-icon">
          <i class="material-icons">pending</i>
        </div>
        <div class="counter-info">
          <div class="counter-label">CHƯA KIỂM TRA</div>
          <div class="counter-value">{{ uncheckedMaterials }}</div>
        </div>
      </div>

      <div class="counter-box outside-stock-box clickable" 
           [class.active]="filterMode === 'outside'"
           (click)="setFilterMode('outside')"
           title="Click để hiển thị mã ngoài tồn kho">
        <div class="counter-icon">
          <i class="material-icons">warning</i>
        </div>
        <div class="counter-info">
          <div class="counter-label">MÃ NGOÀI TỒN KHO</div>
          <div class="counter-value">{{ outsideStockMaterials }}</div>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div class="loading" *ngIf="isLoading">
      <i class="material-icons rotating">sync</i>
      <span>Loading data...</span>
    </div>

    <!-- Table -->
    <div class="table-container" *ngIf="!isLoading">
      <table class="stock-table">
        <thead>
          <tr>
            <th>STT</th>
            <th>MÃ HÀNG</th>
            <th>PO</th>
            <th>IMD</th>
            <th>TỒN KHO</th>
            <th>VỊ TRÍ</th>
            <th>STANDARD PACKING</th>
            <th>STOCK CHECK</th>
            <th>QTY CHECK</th>
            <th>SO SÁNH STOCK</th>
            <th>ID CHECK</th>
            <th>DATE CHECK</th>
            <th>LỊCH SỬ</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let material of displayedMaterials">
            <td>{{ material.stt }}</td>
            <td>{{ material.materialCode }}</td>
            <td>{{ material.poNumber }}</td>
            <td>{{ material.imd }}</td>
            <td>{{ material.stock }}</td>
            <td>{{ material.location }}</td>
            <td>{{ material.standardPacking || '-' }}</td>
            <td class="check-cell clickable" 
                (click)="showMaterialDetail(material)"
                [title]="material.stockCheck ? 'Click để xem chi tiết' : 'Chưa được check'">
              <span *ngIf="material.stockCheck" class="check-icon">✓</span>
              <span *ngIf="!material.stockCheck" style="color: #999;">-</span>
            </td>
            <td class="qty-cell">
              <span *ngIf="material.qtyCheck !== null">{{ material.qtyCheck }}</span>
              <span *ngIf="material.qtyCheck === null" style="color: #999;">-</span>
            </td>
            <td class="compare-cell" [class.positive]="(material.stock - (material.qtyCheck || 0)) > 0" 
                [class.negative]="(material.stock - (material.qtyCheck || 0)) < 0"
                [class.equal]="material.stock === (material.qtyCheck || 0)">
              <span *ngIf="material.qtyCheck !== null">
                {{ material.stock - (material.qtyCheck || 0) }}
                <span class="compare-label">
                  ({{ material.stock }} - {{ material.qtyCheck }})
                </span>
              </span>
              <span *ngIf="material.qtyCheck === null" style="color: #999;">-</span>
            </td>
            <td class="id-cell">
              <span *ngIf="material.idCheck">{{ material.idCheck }}</span>
              <span *ngIf="!material.idCheck" style="color: #999;">-</span>
            </td>
            <td>
              <span *ngIf="material.dateCheck">
                {{ material.dateCheck | date:'dd/MM/yyyy HH:mm' }}
              </span>
              <span *ngIf="!material.dateCheck" style="color: #999;">-</span>
            </td>
            <td class="history-cell clickable" (click)="showMaterialHistory(material)" title="Click để xem lịch sử kiểm kê">
              <i class="material-icons">history</i>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="!isLoading && displayedMaterials.length > 0">
      <button 
        class="page-btn" 
        (click)="previousPage()" 
        [disabled]="currentPage === 1">
        <i class="material-icons">chevron_left</i>
        Previous
      </button>
      <span class="page-info">
        Page {{ currentPage }} of {{ totalPages }} | Showing {{ displayedMaterials.length }} of {{ filteredMaterials.length }} items
      </span>
      <button 
        class="page-btn" 
        (click)="nextPage()" 
        [disabled]="currentPage === totalPages">
        Next
        <i class="material-icons">chevron_right</i>
      </button>
    </div>

    <!-- No Data -->
    <div class="no-data" *ngIf="!isLoading && displayedMaterials.length === 0">
      <i class="material-icons">inbox</i>
      <p *ngIf="filterMode === 'all'">No data available</p>
      <p *ngIf="filterMode === 'checked'">Chưa có mã nào được kiểm tra</p>
      <p *ngIf="filterMode === 'unchecked'">Tất cả mã đã được kiểm tra</p>
    </div>
  </div>

  <!-- Employee Scan Modal (after factory selection) -->
  <div class="scan-modal" *ngIf="showEmployeeScanModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>
          <i class="material-icons">badge</i>
          SCAN MÃ NHÂN VIÊN
        </h3>
      </div>
      
      <div class="scan-message">
        <p><strong>Vui lòng scan mã nhân viên</strong></p>
        <p>Format: <strong>ASP + 4 số</strong> (ví dụ: ASP1234)</p>
      </div>
      
      <div class="scan-input-container">
        <input 
          id="employee-scan-input"
          type="text" 
          class="scan-input"
          [(ngModel)]="employeeScanInput"
          (keyup.enter)="onEmployeeScanEnter()"
          placeholder="Scan mã nhân viên (ASP + 4 số)..."
          autocomplete="off"
          autofocus>
        <button class="scan-submit-btn" (click)="onEmployeeScanEnter()">
          <i class="material-icons">send</i>
        </button>
      </div>
      
      <div class="modal-actions">
        <button class="cancel-btn" (click)="backToSelection()">
          <i class="material-icons">close</i>
          Hủy
        </button>
      </div>
    </div>
  </div>

  <!-- Scan Modal (for material scanning) -->
  <div class="scan-modal" *ngIf="showScanModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Kiểm Kê - {{ selectedFactory }}</h3>
        <button class="close-btn" (click)="closeScanModal()">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <div class="scan-message">
        {{ scanMessage }}
      </div>
      
      <div class="scan-input-container">
        <input 
          id="scan-input"
          type="text" 
          class="scan-input"
          [(ngModel)]="scanInput"
          (keyup.enter)="onScanInputEnter()"
          (input)="onScanInputChange()"
          [placeholder]="scanStep === 'employee' ? 'Nhập hoặc scan mã nhân viên...' : 'Scan mã hàng hóa...'"
          autocomplete="off"
          autofocus>
        <button class="scan-submit-btn" (click)="onScanInputEnter()">
          <i class="material-icons">send</i>
        </button>
      </div>

      <!-- Scan History -->
      <div class="scan-history" *ngIf="scanHistory.length > 0">
        <div class="history-title">Lịch sử scan:</div>
        <div class="history-item" *ngFor="let item of scanHistory">
          {{ item }}
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="cancel-btn" (click)="closeScanModal()">
          Đóng
        </button>
      </div>
    </div>
  </div>

  <!-- Reset Modal -->
  <div class="reset-modal" *ngIf="showResetModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>
          <i class="material-icons">refresh</i>
          RESET STOCK CHECK
        </h3>
        <button class="close-btn" (click)="closeResetModal()">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="reset-warning">
          <i class="material-icons">warning</i>
          <p><strong>⚠️ CẢNH BÁO:</strong></p>
          <p>Hành động này sẽ xóa TẤT CẢ dữ liệu kiểm kê cho <strong>{{ selectedFactory }}</strong>.</p>
          <p><strong>✅ Dữ liệu sẽ được lưu vào lịch sử trước khi xóa</strong> để có thể xem lại sau.</p>
          <p>Bạn có chắc muốn tiếp tục?</p>
        </div>
        
        <div class="password-input-container">
          <label>Nhập mật khẩu để xác nhận:</label>
          <input 
            id="reset-password-input"
            type="password" 
            class="password-input"
            [(ngModel)]="resetPassword"
            (keyup.enter)="resetStockCheck()"
            placeholder="Nhập mật khẩu..."
            autocomplete="off"
            autofocus>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="cancel-btn" (click)="closeResetModal()" [disabled]="isResetting">
          Hủy
        </button>
        <button class="reset-confirm-btn" (click)="resetStockCheck()" [disabled]="isResetting">
          <i class="material-icons" *ngIf="!isResetting">refresh</i>
          <i class="material-icons rotating" *ngIf="isResetting">sync</i>
          <span>{{ isResetting ? 'Đang reset...' : 'XÁC NHẬN RESET' }}</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Archive History Modal -->
  <div class="archive-history-modal" *ngIf="showArchiveHistoryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>
          <i class="material-icons">history</i>
          LỊCH SỬ KIỂM KÊ (ARCHIVE)
        </h3>
        <button class="close-btn" (click)="closeArchiveHistoryModal()">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="loading-spinner" *ngIf="isLoadingArchiveHistory">
          <i class="material-icons">hourglass_empty</i>
          <p>Đang tải...</p>
        </div>
        
        <div class="archive-list" *ngIf="!isLoadingArchiveHistory">
          <div class="archive-empty" *ngIf="archiveHistoryList.length === 0">
            <i class="material-icons">inbox</i>
            <p>Chưa có lịch sử kiểm kê được lưu</p>
            <p class="hint">Lịch sử sẽ được lưu tự động khi bạn bấm RESET</p>
          </div>
          
          <div class="archive-item" *ngFor="let archive of archiveHistoryList; let i = index">
            <div class="archive-info">
              <div class="archive-header">
                <span class="archive-index">#{{ i + 1 }}</span>
                <span class="archive-date">
                  <i class="material-icons">schedule</i>
                  {{ formatDate(archive.resetAt) }}
                </span>
              </div>
              <div class="archive-details">
                <div class="detail-item">
                  <i class="material-icons">person</i>
                  <span>Reset bởi: {{ archive.resetBy }}</span>
                </div>
                <div class="detail-item">
                  <i class="material-icons">inventory</i>
                  <span>Tổng số records: {{ archive.totalRecords }}</span>
                </div>
              </div>
            </div>
            <button class="download-btn" (click)="viewArchiveDetail(archive.id)" title="Tải về Excel">
              <i class="material-icons">download</i>
              Tải về
            </button>
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="cancel-btn" (click)="closeArchiveHistoryModal()">
          Đóng
        </button>
      </div>
    </div>
  </div>

  <!-- History Modal (for History column) -->
  <div class="history-modal" *ngIf="showHistoryModal && selectedMaterialForHistory">
    <div class="modal-content">
      <div class="modal-header">
        <h3>
          <i class="material-icons">history</i>
          LỊCH SỬ KIỂM KÊ: {{ selectedMaterialForHistory.materialCode }}
        </h3>
        <button class="close-btn" (click)="closeHistoryModal()">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="material-info-section">
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Mã hàng:</span>
              <span class="info-value">{{ selectedMaterialForHistory.materialCode }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">PO:</span>
              <span class="info-value">{{ selectedMaterialForHistory.poNumber }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">IMD:</span>
              <span class="info-value">{{ selectedMaterialForHistory.imd }}</span>
            </div>
          </div>
        </div>
        
        <div class="history-section">
          <h4>Lịch sử kiểm kê (1 năm gần nhất)</h4>
          <div class="loading-spinner" *ngIf="isLoadingHistory">
            <i class="material-icons">hourglass_empty</i>
            <p>Đang tải...</p>
          </div>
          <div class="history-list" *ngIf="!isLoadingHistory && materialHistoryList.length > 0">
            <div class="history-item" *ngFor="let history of materialHistoryList">
              <div class="history-icon">
                <i class="material-icons">check_circle</i>
              </div>
              <div class="history-content">
                <div class="history-row">
                  <span class="history-label">ID kiểm:</span>
                  <span class="history-value">{{ history.idCheck }}</span>
                </div>
                <div class="history-row">
                  <span class="history-label">Ngày giờ kiểm:</span>
                  <span class="history-value">{{ history.dateCheck | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
                <div class="history-row">
                  <span class="history-label">Qty check:</span>
                  <span class="history-value">{{ history.qtyCheck }}</span>
                </div>
                <div class="history-row">
                  <span class="history-label">Qty tồn kho:</span>
                  <span class="history-value">{{ history.stock || '-' }}</span>
                </div>
              </div>
            </div>
          </div>
          <div class="no-history" *ngIf="!isLoadingHistory && materialHistoryList.length === 0">
            <i class="material-icons">info</i>
            <p>Chưa có lịch sử kiểm kê</p>
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="cancel-btn" (click)="closeHistoryModal()">
          Đóng
        </button>
      </div>
    </div>
  </div>

  <!-- Material Detail Modal -->
  <div class="material-detail-modal" *ngIf="showMaterialDetailModal && selectedMaterialDetail">
    <div class="modal-content">
      <div class="modal-header">
        <h3>
          <i class="material-icons">info</i>
          Chi tiết mã hàng: {{ selectedMaterialDetail.materialCode }}
        </h3>
        <button class="close-btn" (click)="closeMaterialDetailModal()">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <div class="modal-body">
        <!-- Material Info -->
        <div class="material-info-section">
          <h4>Thông tin mã hàng</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Mã hàng:</span>
              <span class="info-value">{{ selectedMaterialDetail.materialCode }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">PO:</span>
              <span class="info-value">{{ selectedMaterialDetail.poNumber }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">IMD:</span>
              <span class="info-value">{{ selectedMaterialDetail.imd }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Tồn kho:</span>
              <span class="info-value">{{ selectedMaterialDetail.stock }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Vị trí:</span>
              <span class="info-value">{{ selectedMaterialDetail.location || '-' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Trạng thái:</span>
              <span class="info-value" [class.checked]="selectedMaterialDetail.stockCheck === '✓'">
                {{ selectedMaterialDetail.stockCheck === '✓' ? 'Đã check' : 'Chưa check' }}
              </span>
            </div>
          </div>
        </div>

        <!-- Check History -->
        <div class="check-history-section">
          <h4>Lịch sử check</h4>
          <div class="history-list" *ngIf="materialCheckHistory.length > 0">
            <div class="history-item" *ngFor="let history of materialCheckHistory" 
                 [class.archive-item]="history.source === 'archive'">
              <div class="history-icon">
                <i class="material-icons" [class.archive-icon]="history.source === 'archive'">
                  {{ history.source === 'archive' ? 'archive' : 'check_circle' }}
                </i>
              </div>
              <div class="history-content">
                <div class="history-row">
                  <span class="history-label">ID kiểm:</span>
                  <span class="history-value">{{ history.idCheck }}</span>
                  <span class="archive-badge" *ngIf="history.source === 'archive'">
                    <i class="material-icons">history</i>
                    Lịch sử (Reset: {{ history.resetDate | date:'dd/MM/yyyy HH:mm' }})
                  </span>
                </div>
                <div class="history-row">
                  <span class="history-label">Ngày giờ kiểm:</span>
                  <span class="history-value">{{ history.dateCheck | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
                <div class="history-row">
                  <span class="history-label">Qty check:</span>
                  <span class="history-value">{{ history.qtyCheck }}</span>
                </div>
                <div class="history-row">
                  <span class="history-label">Qty tồn kho:</span>
                  <span class="history-value">{{ history.stock !== undefined && history.stock !== null ? history.stock : '-' }}</span>
                </div>
              </div>
            </div>
          </div>
          <div class="no-history" *ngIf="materialCheckHistory.length === 0">
            <i class="material-icons">info</i>
            <p>Chưa có lịch sử check</p>
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="cancel-btn" (click)="closeMaterialDetailModal()">
          Đóng
        </button>
      </div>
    </div>
  </div>
</div>
</div>
