<div class="finished-goods-test-container">
  <!-- Employee Information Form -->
  <div class="container" *ngIf="currentView === 'employee-form'">
    <div class="document-header">
      <div class="header-left">
        <div class="logo-section">
          <img src="assets/img/logo.png" alt="AIRSPEED Logo" class="company-logo">
        </div>
      </div>
      
      <div class="header-center">
        <div class="company-name">AIRSPEED MANUFACTURING VI·ªÜT NAM</div>
        <div class="document-title">B√ÅO C√ÅO TH·ª∞C H√ÄNH ƒê√ÄO T·∫†O N·ªòI B·ªò</div>
      </div>
    </div>

    <div class="header">
      <h1>H∆Ø·ªöNG D·∫™N XU·∫§T NH·∫¨P KHO TH√ÄNH PH·∫®M</h1>
    </div>

    <div class="employee-form-section">
      <h3>üìù Th√¥ng tin ng∆∞·ªùi l√†m b√†i:</h3>
      <form class="employee-form">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>M√£ s·ªë nh√¢n vi√™n</mat-label>
          <input matInput [(ngModel)]="employeeInfo.employeeId" name="employeeId" required 
                 placeholder="V√≠ d·ª•: ASP0106" class="uppercase-input"
                 (input)="onEmployeeIdInput($event)">
          <mat-hint>ƒê·ªãnh d·∫°ng: ASP + 4 ch·ªØ s·ªë (v√≠ d·ª•: ASP0106)</mat-hint>
          <mat-error *ngIf="employeeInfo.employeeId && !isValidEmployeeId(employeeInfo.employeeId)">
            M√£ s·ªë nh√¢n vi√™n ph·∫£i c√≥ ƒë·ªãnh d·∫°ng ASP + 4 ch·ªØ s·ªë (v√≠ d·ª•: ASP0106)
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>H·ªç v√† t√™n</mat-label>
          <input matInput [(ngModel)]="employeeInfo.employeeName" name="employeeName" required 
                 placeholder="V√≠ d·ª•: Tr·∫ßn Tu·∫•n Anh" class="uppercase-input"
                 (input)="onEmployeeNameInput($event)">
          <mat-hint>Vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu c·ªßa m·ªói t·ª´ (v√≠ d·ª•: Tr·∫ßn Tu·∫•n Anh)</mat-hint>
          <mat-error *ngIf="employeeInfo.employeeName && !isValidEmployeeName(employeeInfo.employeeName)">
            H·ªç v√† t√™n ph·∫£i c√≥ √≠t nh·∫•t 2 t·ª´ (h·ªç v√† t√™n)
          </mat-error>
        </mat-form-field>

        <div class="form-actions">
          <button mat-raised-button color="primary" 
                  (click)="startPreview()" 
                  [disabled]="!isEmployeeFormValid()">
            <mat-icon>visibility</mat-icon>
            Xem th√¥ng tin b√†i ki·ªÉm tra
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Preview Section -->
  <div class="container" *ngIf="currentView === 'preview'">
    <div class="header">
      <h1>{{ testData.title.split(' ')[0] + ' ' + testData.title.split(' ')[1] + ' ' + testData.title.split(' ')[2] }}</h1>
      <h2>{{ testData.title.split(' ').slice(3).join(' ') }}</h2>
    </div>

    <div class="employee-info-display">
      <p><strong>Ng∆∞·ªùi l√†m b√†i:</strong> {{ getFormattedEmployeeName() }} ({{ employeeInfo.employeeId }})</p>
    </div>

    <div class="test-info">
      <h3>üìã Th√¥ng tin b√†i ki·ªÉm tra:</h3>
      <ul>
        <li><strong>Th·ªùi gian l√†m b√†i:</strong> {{ testData.timeLimit }} ph√∫t</li>
        <li><strong>ƒêi·ªÉm ƒë·∫°t:</strong> {{ testData.passingScore }}%</li>
        <li><strong>D·∫°ng c√¢u h·ªèi:</strong> Tr·∫Øc nghi·ªám</li>
      </ul>
    </div>

    <div class="action-section">
      <button mat-raised-button color="primary" (click)="startTest()" class="start-test-btn">
        <mat-icon>play_arrow</mat-icon>
        B·∫Øt ƒë·∫ßu l√†m b√†i
      </button>
      <button mat-stroked-button (click)="currentView = 'employee-form'" class="back-btn">
        <mat-icon>arrow_back</mat-icon>
        Quay l·∫°i
      </button>
    </div>

    <div class="download-section">
      <h3>üì• T·∫£i xu·ªëng t√†i li·ªáu tham kh·∫£o:</h3>
      <button mat-raised-button color="accent" class="download-btn" (click)="downloadWHWI0005Document('Part B')" [disabled]="isLoading">
        <mat-icon>file_download</mat-icon>
        üìÑ T·∫£i xu·ªëng WH-WI0005 Part B
      </button>
    </div>
  </div>

  <!-- Test Interface -->
  <div class="container test-container" *ngIf="currentView === 'test'">
    <div class="test-header">
      <div class="test-progress">
        <h2>{{ getCurrentSection()?.title }}</h2>
        <p>C√¢u {{ getQuestionNumber() }}/{{ testData.totalQuestions }}</p>
        <mat-progress-bar mode="determinate" [value]="(getQuestionNumber() / testData.totalQuestions) * 100"></mat-progress-bar>
      </div>
      <div class="employee-info">
        <p><strong>{{ getFormattedEmployeeName() }}</strong> ({{ employeeInfo.employeeId }})</p>
      </div>
    </div>

    <div class="question-section" *ngIf="getCurrentQuestion() as question">
      <div class="question-type-badge">
        {{ question.type === 'multiple-choice' ? 'TR·∫ÆC NGHI·ªÜM' : question.type === 'true-false' ? 'ƒê√öNG/SAI' : 'ƒêI·ªÄN T·ª™' }}
      </div>
      
      <div class="question-text">
        <h3>C√¢u {{ getQuestionNumber() }}: {{ question.question }}</h3>
      </div>

      <!-- Multiple Choice Questions -->
      <div class="answer-options" *ngIf="question.type === 'multiple-choice'">
        <mat-radio-group [value]="getSelectedAnswer()" (change)="selectAnswer($event.value)">
          <mat-radio-button 
            *ngFor="let option of question.options; let i = index" 
            [value]="getOptionLabel(i)"
            class="answer-option">
            {{ getOptionLabel(i) }}. {{ option }}
          </mat-radio-button>
        </mat-radio-group>
      </div>

      <!-- True/False Questions -->
      <div class="answer-options" *ngIf="question.type === 'true-false'">
        <mat-radio-group [value]="getSelectedAnswer()" (change)="selectAnswer($event.value)">
          <mat-radio-button value="true" class="answer-option">
            ‚úì ƒê√öNG
          </mat-radio-button>
          <mat-radio-button value="false" class="answer-option">
            ‚úó SAI
          </mat-radio-button>
        </mat-radio-group>
      </div>

      <!-- Fill in the blank Questions -->
      <div class="answer-options" *ngIf="question.type === 'fill-blank'">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>ƒêi·ªÅn c√¢u tr·∫£ l·ªùi</mat-label>
          <textarea matInput [value]="getSelectedAnswer() || ''" 
                    (input)="selectAnswer($any($event.target).value)"
                    rows="3" 
                    placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..."></textarea>
        </mat-form-field>
      </div>
    </div>

    <div class="test-navigation">
      <button mat-stroked-button 
              (click)="previousQuestion()" 
              [disabled]="currentSectionIndex === 0 && currentQuestionIndex === 0">
        <mat-icon>arrow_back</mat-icon>
        C√¢u tr∆∞·ªõc
      </button>
      
      <button mat-raised-button color="primary" 
              (click)="nextQuestion()" 
              [disabled]="!canGoNext()">
        <mat-icon>{{ isLastQuestion() ? 'check' : 'arrow_forward' }}</mat-icon>
        {{ isLastQuestion() ? 'Ho√†n th√†nh' : 'C√¢u ti·∫øp theo' }}
      </button>
    </div>
  </div>

  <!-- Results Section -->
  <div class="container result-container" *ngIf="currentView === 'result' && testResult">
    <div class="header">
      <h1>K·∫æT QU·∫¢ B√ÄI KI·ªÇM TRA</h1>
      <h2>{{ testData.title }}</h2>
    </div>

    <div class="result-summary">
      <div class="employee-info">
        <p><strong>Ng∆∞·ªùi l√†m b√†i:</strong> {{ testResult.employeeInfo.employeeName }} ({{ testResult.employeeInfo.employeeId }})</p>
        <p><strong>Ng√†y ho√†n th√†nh:</strong> {{ testResult.completedAt | date:'dd/MM/yyyy HH:mm' }}</p>
      </div>

      <div class="score-section">
        <div class="score-circle" [class.passed]="testResult.passed" [class.failed]="!testResult.passed">
          <div class="score-number">{{ testResult.percentage.toFixed(1) }}%</div>
          <div class="score-label">{{ testResult.passed ? 'ƒê·∫†T' : 'KH√îNG ƒê·∫†T' }}</div>
        </div>
        
        <div class="score-details">
          <p><strong>S·ªë c√¢u ƒë√∫ng:</strong> {{ testResult.score }}/{{ testData.totalQuestions }}</p>
          <p><strong>ƒêi·ªÉm ƒë·∫°t y√™u c·∫ßu:</strong> {{ testData.passingScore }}%</p>
          <p><strong>Th·ªùi gian l√†m b√†i:</strong> {{ testData.timeLimit }} ph√∫t</p>
        </div>
      </div>
    </div>

    <!-- Signature Section -->
    <div class="signature-section" *ngIf="showSignature">
      <div class="signature-header" [class.required]="signatureRequired">
        <h3>‚úçÔ∏è Ch·ªØ k√Ω x√°c nh·∫≠n:</h3>
        <div class="signature-status" *ngIf="signatureRequired">
          <mat-icon>warning</mat-icon>
          <span>B·∫Øt bu·ªôc ph·∫£i k√Ω ƒë·ªÉ ho√†n th√†nh b√†i ki·ªÉm tra</span>
        </div>
      </div>
      <div class="signature-container">
        <canvas #signatureCanvas class="signature-canvas"></canvas>
        <div class="signature-actions">
          <button mat-stroked-button (click)="clearSignature()" class="clear-btn">
            <mat-icon>clear</mat-icon>
            X√≥a ch·ªØ k√Ω
          </button>
          <button mat-raised-button color="primary" (click)="saveSignature()" [disabled]="isSignatureEmpty()">
            <mat-icon>save</mat-icon>
            L∆∞u ch·ªØ k√Ω v√† ho√†n th√†nh
          </button>
          <button mat-stroked-button (click)="skipSignature()" [disabled]="signatureRequired">
            <mat-icon>skip_next</mat-icon>
            B·ªè qua
          </button>
        </div>
      </div>
      <div class="signature-info">
        <p><small>Vui l√≤ng k√Ω t√™n ƒë·ªÉ x√°c nh·∫≠n k·∫øt qu·∫£ b√†i ki·ªÉm tra</small></p>
        <p *ngIf="signatureRequired" class="required-notice">
          <mat-icon>info</mat-icon>
          <strong>Ch·ªØ k√Ω l√† b·∫Øt bu·ªôc ƒë·ªÉ l∆∞u k·∫øt qu·∫£ b√†i ki·ªÉm tra!</strong>
        </p>
      </div>
    </div>

    <div class="result-actions">
      <button mat-raised-button color="primary" (click)="downloadResultFile()" [disabled]="isLoading">
        <mat-icon>download</mat-icon>
        T·∫£i k·∫øt qu·∫£ PDF
      </button>
      <button mat-raised-button color="accent" (click)="downloadExcel()" [disabled]="isLoading">
        <mat-icon>table_chart</mat-icon>
        T·∫£i Excel
      </button>
      <button mat-raised-button color="accent" (click)="downloadAnswerKey()" [disabled]="isLoading">
        <mat-icon>key</mat-icon>
        T·∫£i ƒë√°p √°n
      </button>
      <button mat-raised-button color="accent" (click)="downloadSampleForm()" [disabled]="isLoading">
        <mat-icon>description</mat-icon>
        T·∫£i form m·∫´u
      </button>
      <button mat-raised-button color="success" (click)="completeTest()" [disabled]="signatureRequired">
        <mat-icon>check_circle</mat-icon>
        Ho√†n th√†nh
      </button>
      <button mat-raised-button color="warn" (click)="restartTest()">
        <mat-icon>refresh</mat-icon>
        L√†m l·∫°i b√†i ki·ªÉm tra
      </button>
    </div>

    <div class="detailed-results">
      <h3>Chi ti·∫øt c√¢u tr·∫£ l·ªùi:</h3>
      <div class="section-results" *ngFor="let section of testData.sections; let sectionIndex = index">
        <h4>{{ section.title }}</h4>
        <div class="question-results">
          <div *ngFor="let question of section.questions; let questionIndex = index" 
               class="question-result"
               [class.correct]="getAnswerResult(sectionIndex, questionIndex)?.isCorrect"
               [class.incorrect]="!getAnswerResult(sectionIndex, questionIndex)?.isCorrect">
            <div class="question-number">C√¢u {{ getDetailedQuestionNumber(sectionIndex, questionIndex) }}</div>
            <div class="question-status">
              <mat-icon>{{ getAnswerResult(sectionIndex, questionIndex)?.isCorrect ? 'check_circle' : 'cancel' }}</mat-icon>
            </div>
            <div class="question-details">
              <p class="question-text">{{ question.question }}</p>
              <p class="selected-answer">ƒê√°p √°n ch·ªçn: {{ getAnswerResult(sectionIndex, questionIndex)?.selectedAnswer || 'Kh√¥ng tr·∫£ l·ªùi' }}</p>
              <p class="correct-answer">ƒê√°p √°n ƒë√∫ng: {{ question.correctAnswer }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> 