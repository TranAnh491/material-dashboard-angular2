<div class="main-content">
  <!-- Excel-like Container -->
  <div class="excel-container">
    <!-- Excel-like Header -->
    <div class="excel-header">
      <h4>�� INBOUND ASM1</h4>
      
      <!-- Batch Filter Indicator -->
      <div class="batch-filter-indicator" *ngIf="currentBatchNumber && currentBatchNumber.trim() !== ''">
        <div class="filter-badge">
          <i class="material-icons">filter_list</i>
          <span>Đang lọc theo lô hàng: <strong>{{ currentBatchNumber }}</strong></span>
          <button class="clear-filter-btn" (click)="clearBatchFilter()" title="Xóa bộ lọc lô hàng">
            <i class="material-icons">close</i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Excel-like Actions -->
    <div class="excel-actions">
      <div class="action-controls-horizontal">
        <!-- Start Batch Processing Button -->
        <div class="start-batch-container">
          <button class="start-batch-btn" 
                  [class.active]="isBatchActive"
                  (click)="openBatchModal()"
                  [disabled]="isBatchActive">
            <i class="material-icons">{{ isBatchActive ? 'pause' : 'play_arrow' }}</i>
            {{ isBatchActive ? 'Đang kiểm: ' + currentBatchNumber : 'Start' }}
          </button>
          
          <!-- Scan Options - Ẩn vì không cần thiết trong bước "Đang kiểm" -->
          <!-- <div class="scan-options" *ngIf="isBatchActive">
            <button class="scan-option-btn scanner-btn" 
                    (click)="startScannerMode()"
                    title="Sử dụng máy scan vật lý">
              <i class="material-icons">scanner</i>
              Scan máy scan
            </button>
            <button class="scan-option-btn camera-btn" 
                    (click)="startCameraMode()"
                    title="Sử dụng camera điện thoại">
              <i class="material-icons">qr_code_scanner</i>
              Quét QR code
            </button>
          </div> -->
          
          <div class="batch-info" *ngIf="isBatchActive">
            <span class="batch-number">{{ currentBatchNumber }}</span>
            <span class="employee-ids">{{ currentEmployeeIds.join(', ') }}</span>
            <span class="batch-timer" *ngIf="batchStartTime">{{ getBatchDuration() }} phút</span>
          </div>
        </div>
        
        <!-- More Button with Dropdown -->
        <div class="dropdown">
          <button class="more-btn" (click)="toggleDropdown()">
            <i class="material-icons">more_vert</i>
            More
          </button>
          <div class="dropdown-menu" [class.show]="showDropdown">
            <a class="dropdown-item" href="javascript:void(0)" (click)="exportToExcel()">
              <i class="material-icons">file_download</i>
              Export to Excel
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="downloadTemplate()">
              <i class="material-icons">description</i>
              Download Template
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="importFile()">
              <i class="material-icons">file_upload</i>
              Import File
            </a>
            <a class="dropdown-item" href="javascript:void(0)" (click)="downloadInboundReport()">
              <i class="material-icons">assessment</i>
              Download Report
            </a>
            
            <a class="dropdown-item delete-all-item" href="javascript:void(0)" (click)="deleteAllMaterials()">
              <i class="material-icons">delete_sweep</i>
              Xóa tất cả
            </a>
            
            <!-- Auto-hide Received Materials Toggle -->
            <div class="dropdown-item toggle-item">
              <label class="toggle-label">
                <input type="checkbox" 
                       [(ngModel)]="hideReceivedAfterNextDay" 
                       (change)="applyFilters()"
                       class="toggle-checkbox">
                <span class="toggle-text">Ẩn mã đã nhận qua ngày hôm sau</span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Total Materials Counter -->
        <div class="total-counter-box">
          <span>Tổng: {{filteredMaterials.length}} materials</span>
        </div>
        
        <!-- Search Box -->
        <div class="search-box">
          <input type="text" 
                 [placeholder]="getSearchPlaceholder()"
                 [(ngModel)]="searchTerm"
                 (input)="onSearchInput($event)"
                 class="search-input">
        </div>
        
        <!-- Filter Buttons -->
        <div class="filter-buttons">
          <!-- Search Type Filter -->
          <div class="filter-group">
            <select class="filter-select" 
                    [(ngModel)]="searchType" 
                    (change)="changeSearchType($event.target.value)">
              <option value="materialCode">Mã Hàng</option>
              <option value="batchNumber">Lô Hàng</option>
            </select>
          </div>
          
          <!-- Status Filter -->
          <div class="filter-group">
            <select class="filter-select" 
                    [(ngModel)]="statusFilter" 
                    (change)="changeStatusFilter($event.target.value)">
              <option value="pending">Chưa</option>
              <option value="completed">Hoàn Thành</option>
            </select>
          </div>
          

        </div>
        
        <!-- Date Range Selector -->
        <div class="date-range-selector">
          <input type="date" 
                 [(ngModel)]="startDate" 
                 (change)="applyFilters()"
                 class="date-input"
                 title="Từ ngày">
          <span class="date-separator">→</span>
          <input type="date" 
                 [(ngModel)]="endDate" 
                 (change)="applyFilters()"
                 class="date-input"
                 title="Đến ngày">
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
          <button class="clear-btn" (click)="clearFilters()">
            <i class="material-icons">clear</i>
            Reset
          </button>
          
          <!-- Refresh Button -->
          <button class="refresh-btn" (click)="loadMaterials()">
            <i class="material-icons">refresh</i>
            Refresh
          </button>
        </div>
        
        <!-- Ẩn Factory Badge vì không có chức năng -->
        <!-- <span class="factory-badge asm1-badge">ASM1</span> -->
      </div>
    </div>
    
    <!-- Loading State -->
    <div class="loading-container" *ngIf="isLoading">
      <div class="loading-spinner">
        <i class="material-icons spinning">refresh</i>
        <span>Đang tải dữ liệu ASM1...</span>
      </div>
    </div>
    
    <!-- Error Message -->
    <div class="error-message" *ngIf="errorMessage">
      <i class="material-icons">error</i>
      {{errorMessage}}
    </div>
    
    <!-- Excel-like Body -->
    <div class="excel-body" *ngIf="!isLoading">
      <table class="excel-table">
        <thead>
          <tr>
            <th class="factory-cell">FACTORY</th>
            <th class="row-header">#</th>
            <th class="date-cell">NGÀY NHẬP</th>
            <th class="batch-cell">LÔ HÀNG/ DNNK</th>
            <th class="code-cell">MÃ HÀNG</th>
            <th class="po-cell">SỐ P.O</th>
            <th class="number-cell">LƯỢNG NHẬP</th>
            <th class="location-cell">VỊ TRÍ</th>
            <th class="type-cell">LOẠI HÌNH</th>
            <th class="date-cell">HSD</th>
            <th class="status-cell">KK</th>
            <th class="status-cell">ĐÃ NHẬN</th>
            <th class="number-cell">LƯỢNG ĐƠN VỊ</th>
            <th class="supplier-cell">NHÀ CUNG CẤP</th>
            <th class="remarks-cell">LƯU Ý</th>
            <th class="status-cell">TRẠNG THÁI</th>
            <!-- Ẩn 2 cột MSNV và THỜI GIAN -->
            <!-- <th class="employee-cell">MSNV</th> -->
            <!-- <th class="time-cell">THỜI GIAN</th> -->
            <th class="action-cell">HOÀN THÀNH</th>
            <th class="action-cell">XÓA</th>
            <th class="action-cell">QR</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let material of filteredMaterials; let i = index" 
              [class.received-row]="material.isReceived"
              [class.completed-row]="material.isCompleted">
            <td class="factory-cell factory-asm1">
              ASM1
            </td>
            <td class="row-header">{{i + 1}}</td>
            <td class="date-cell">{{formatDate(material.importDate)}}</td>
            <td class="batch-cell">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.batchNumber" 
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Không thể sửa - đã trong Inventory' : 'Sửa lô hàng'">
            </td>
            <td class="code-cell" 
                [class.material-code-printed]="material.hasQRGenerated"
                [class.material-received]="material.isReceived">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.materialCode" 
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Không thể sửa - đã trong Inventory' : 'Sửa mã hàng'">
            </td>
            <td class="po-cell">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.poNumber" 
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Không thể sửa - đã trong Inventory' : 'Sửa số PO'">
            </td>
            <td class="number-cell">
              <input type="number" 
                     class="editable-input" 
                     [(ngModel)]="material.quantity" 
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Không thể sửa - đã trong Inventory' : 'Sửa số lượng'">
            </td>
            <td class="location-cell">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.location" 
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Không thể sửa - đã trong Inventory' : 'Sửa vị trí'"
                     placeholder="Vị trí">
            </td>
            <td class="type-cell">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.type" 
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Không thể sửa - đã trong Inventory' : 'Sửa loại hình'"
                     placeholder="Loại">
            </td>
            <td class="date-cell">
              <input type="date" 
                     class="date-input" 
                     [value]="material.expiryDate ? material.expiryDate.toISOString().split('T')[0] : ''"
                     (change)="onExpiryDateChange($event, material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Không thể sửa - đã trong Inventory' : 'Sửa hạn sử dụng'">
            </td>
                         <td class="status-cell">
               <input type="checkbox" 
                      [checked]="material.qualityCheck" 
                      (change)="onQualityCheckChange($event, material)"
                      [disabled]="!canEditMaterials || material.isReceived || !canEditInBatch(material)"
                      [title]="getQualityCheckTitle(material)">
             </td>
             <td class="status-cell">
               <input type="checkbox" 
                      [checked]="material.isReceived" 
                      (change)="onReceivedChange($event, material)"
                      [disabled]="material.isReceived || !canEditMaterials || !canEditInBatch(material)"
                      [title]="getReceivedTitle(material)">
             </td>
            <td class="number-cell">
              <input type="number" 
                     class="editable-input" 
                     [(ngModel)]="material.rollsOrBags" 
                     (change)="updateMaterial(material)"
                     min="0"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Không thể sửa - đã trong Inventory' : 'Sửa lượng đơn vị'">
            </td>
            <td class="supplier-cell">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.supplier" 
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Không thể sửa - đã trong Inventory' : 'Sửa nhà cung cấp'"
                     placeholder="Nhà cung cấp">
            </td>
            <td class="remarks-cell">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.remarks" 
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Không thể sửa - đã trong Inventory' : 'Sửa lưu ý'"
                     placeholder="Lưu ý">
            </td>
                         <td class="status-cell">
               <span class="status-badge" [ngClass]="getStatusBadgeClass(material)">
                 {{getStatusText(material)}}
               </span>
             </td>
             <!-- Ẩn 2 cột MSNV và THỜI GIAN -->
             <!-- <td class="employee-cell">
               <span class="employee-display">{{ getEmployeeDisplay(material) }}</span>
             </td>
             <td class="time-cell">
               <span class="time-display">{{ getTimeDisplay(material) }}</span>
             </td> -->
             <td class="status-cell">
               <button class="action-btn complete-btn" 
                       (click)="material.isCompleted = true; updateMaterial(material)" 
                       [disabled]="material.isCompleted || !canEditMaterials || !canEditInBatch(material)"
                       [title]="getCompleteButtonTitle(material)">
                 <i class="material-icons">check_circle</i>
               </button>
             </td>
            <td class="status-cell">
              <button class="action-btn delete-btn" 
                      (click)="deleteMaterial(material)" 
                      [disabled]="!canDeleteMaterials" 
                      [title]="material.isReceived ? 'Xóa khỏi Inbound (không ảnh hưởng Inventory)' : 'Xóa material'">
                <i class="material-icons">delete</i>
              </button>
            </td>
                         <td class="qr-cell">
               <button class="print-qr-btn" 
                       (click)="printQRCode(material)" 
                       [disabled]="!canGenerateQR || !material.rollsOrBags || material.rollsOrBags <= 0"
                       [title]="!material.rollsOrBags || material.rollsOrBags <= 0 ? 'Vui lòng nhập lượng đơn vị trước' : 'In tem QR code'">
                 <i class="material-icons">print</i>
                 Print
               </button>
             </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- File Upload (Hidden) -->
<input type="file" 
       #fileInput 
       accept=".xlsx,.xls,.csv" 
       style="display: none" 
       (change)="onFileSelect($event)">

<!-- Batch Start Modal -->
<div class="modal-overlay" *ngIf="showBatchModal" (click)="closeBatchModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>🚀 Bắt đầu kiểm lô hàng</h3>
      <button class="close-btn" (click)="closeBatchModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <!-- Thay scanner bằng input trực tiếp -->
      <div class="scanner-section" *ngIf="isBatchScanningMode">
        <div class="employee-input-section">
          <label for="employeeCodeInput">Nhập mã nhân viên:</label>
          <input 
            type="text" 
            id="employeeCodeInput"
            [(ngModel)]="employeeCode"
            placeholder="Nhập mã nhân viên..."
            class="employee-input uppercase-input"
            [disabled]="isEmployeeCodeSaved"
            (input)="onEmployeeCodeInput($event)"
            (keyup)="onEmployeeCodeKeyup($event)">
          
          <button 
            class="save-btn" 
            (click)="saveEmployeeCode()"
            [disabled]="!employeeCode || isEmployeeCodeSaved">
            <i class="material-icons">save</i>
            Save
          </button>
        </div>

        <!-- Hiển thị trạng thái mã nhân viên -->
        <div class="employee-status" *ngIf="isEmployeeCodeSaved">
          <i class="material-icons success">check_circle</i>
          <span>Mã nhân viên: {{ employeeCode }}</span>
        </div>

        <!-- Dropdown chọn lô hàng/DNNK -->
        <div class="batch-selection-section" *ngIf="isEmployeeCodeSaved">
          <label for="batchSelect">Chọn mã lô hàng/DNNK:</label>
          
          <!-- Debug info -->
          <div class="debug-info" style="font-size: 12px; color: #666; margin-bottom: 8px;">
            <span>Debug: {{ availableBatches.length }} batches available</span>
            <br>
            <span>Factory: {{ selectedFactory }}</span>
            <br>
            <span>Total in collection: {{ availableBatches.length }}</span>
          </div>
          
          <select 
            id="batchSelect"
            [(ngModel)]="selectedBatch"
            class="batch-select"
            (change)="onBatchSelectionChange()">
            <option value="">-- Chọn lô hàng/DNNK --</option>
            <option 
              *ngFor="let batch of availableBatches" 
              [value]="batch.batchNumber">
              {{ batch.batchNumber }}
            </option>
          </select>
          
          <!-- Show if no batches available -->
          <div *ngIf="availableBatches.length === 0" style="color: #f44336; font-size: 12px; margin-top: 4px;">
            ⚠️ Không có lô hàng nào khả dụng
          </div>
        </div>

        <!-- Nút bắt đầu kiểm tra -->
        <div class="start-inspection-section" *ngIf="selectedBatch">
          <button 
            class="start-inspection-btn" 
            (click)="startInspection()">
            <i class="material-icons">play_arrow</i>
            Bắt đầu kiểm tra
          </button>
        </div>

        <!-- Nút dừng -->
        <button class="done-btn" (click)="stopBatchScanningMode()" title="Dừng chế độ scan">
          <i class="material-icons">stop</i>
          Dừng
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Scanner Input for Physical Scanner Mode -->
<div class="scanner-input-overlay" *ngIf="isScannerInputActive">
  <div class="scanner-input-container">
    <div class="scanner-input-header">
      <h5><i class="material-icons">scanner</i> Chế độ máy scan</h5>
      <button class="close-scanner-btn" (click)="stopScannerMode()">
        <i class="material-icons">close</i>
      </button>
    </div>
    <div class="scanner-input-body">
      <input type="text" 
             #scannerInput
             [(ngModel)]="scannerBuffer"
             (keydown)="onScannerKeydown($event)"
             (blur)="onScannerInputBlur()"
             placeholder="Quét barcode/QR code bằng máy scan..."
             class="scanner-input-field"
             autofocus>
      <div class="scanner-instructions">
        <p><i class="material-icons">info</i> Sử dụng máy scan để quét mã hàng</p>
        <p><i class="material-icons">keyboard</i> Hoặc nhập trực tiếp từ bàn phím</p>
      </div>
    </div>
  </div>
</div>

<!-- Camera QR Scanner Modal -->
<div class="camera-modal" *ngIf="isCameraModeActive">
  <div class="camera-modal-content">
    <div class="camera-modal-header">
      <h5><i class="material-icons">qr_code_scanner</i> Quét QR code bằng camera</h5>
      <button class="close-camera-btn" (click)="stopCameraMode()">
        <i class="material-icons">close</i>
      </button>
    </div>
    <div class="camera-modal-body">
      <div class="camera-container">
        <div id="qr-reader"></div>
        <div class="camera-overlay">
          <div class="camera-frame"></div>
          <div class="camera-hint">Đặt mã QR vào khung để quét</div>
        </div>
      </div>
      <div class="camera-instructions">
        <p><i class="material-icons">info</i> Sử dụng camera điện thoại để quét mã QR</p>
        <p><i class="material-icons">smartphone</i> Đảm bảo camera có quyền truy cập</p>
      </div>
    </div>
  </div>
</div>
