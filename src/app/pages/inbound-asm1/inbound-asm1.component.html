<div class="main-content">
  <!-- Excel-like Container -->
  <div class="excel-container">
    <!-- Excel-like Header -->
    <div class="excel-header">
      <h4><i class="material-icons">inbox</i> INBOUND ASM1</h4>
      
      <!-- Batch Filter Indicator -->
      <div class="batch-filter-indicator" *ngIf="currentBatchNumber && currentBatchNumber.trim() !== ''">
        <div class="filter-badge">
          <i class="material-icons">filter_list</i>
          <span>ƒêang l·ªçc theo l√¥ h√†ng: <strong>{{ currentBatchNumber }}</strong></span>
          <button class="clear-filter-btn" (click)="clearBatchFilter()" title="X√≥a b·ªô l·ªçc l√¥ h√†ng">
            <i class="material-icons">close</i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Excel-like Actions -->
    <div class="excel-actions">
      <div class="action-controls-horizontal">
        <!-- Start Batch Processing Button -->
        <div class="start-batch-container">
          <button class="start-batch-btn" 
                  [class.active]="isBatchActive"
                  (click)="openBatchModal()"
                  [disabled]="isBatchActive">
            <i class="material-icons">{{ isBatchActive ? 'pause' : 'play_arrow' }}</i>
            {{ isBatchActive ? 'ƒêang ki·ªÉm: ' + currentBatchNumber : 'Start' }}
          </button>
          
          <!-- Scan Options - ·∫®n v√¨ kh√¥ng c·∫ßn thi·∫øt trong b∆∞·ªõc "ƒêang ki·ªÉm" -->
          <!-- <div class="scan-options" *ngIf="isBatchActive">
            <button class="scan-option-btn scanner-btn" 
                    (click)="startScannerMode()"
                    title="S·ª≠ d·ª•ng m√°y scan v·∫≠t l√Ω">
              <i class="material-icons">scanner</i>
              Scan m√°y scan
            </button>
            <button class="scan-option-btn camera-btn" 
                    (click)="startCameraMode()"
                    title="S·ª≠ d·ª•ng camera ƒëi·ªán tho·∫°i">
              <i class="material-icons">qr_code_scanner</i>
              Qu√©t QR code
            </button>
          </div> -->
          
          <div class="batch-info" *ngIf="isBatchActive">
            <span class="batch-number">{{ currentBatchNumber }}</span>
            <span class="employee-ids">{{ currentEmployeeIds.join(', ') }}</span>
            <span class="batch-timer" *ngIf="batchStartTime">{{ getBatchDuration() }} ph√∫t</span>
          </div>
        </div>
        
        <!-- Nh·∫≠n h√†ng tr·∫£ Button -->
        <button class="return-goods-btn" (click)="openReturnGoodsModal()">
          <i class="material-icons">assignment_return</i>
          Nh·∫≠n h√†ng tr·∫£
        </button>
        
        <!-- In to√†n b·ªô QR Button -->
        <button class="print-all-qr-btn" 
                (click)="printAllQRCodes()"
                [disabled]="!canGenerateQR || getPrintableMaterialsCount() === 0"
                [title]="getPrintableMaterialsCount() === 0 ? 'Kh√¥ng c√≥ material n√†o c√≥ th·ªÉ in QR' : 'In t·∫•t c·∫£ QR codes trong danh s√°ch'">
          <i class="material-icons">print</i>
          In to√†n b·ªô
        </button>
        
        <!-- Filter Buttons: H√†ng Tr·∫£ / H√†ng Nh·∫≠p -->
        <div class="batch-type-filters">
          <label class="filter-checkbox-label">
            <input type="checkbox" 
                   [(ngModel)]="filterReturnGoods" 
                   (change)="onBatchTypeFilterChange()"
                   class="filter-checkbox">
            <span class="filter-checkbox-text">H√†ng Tr·∫£</span>
          </label>
          <label class="filter-checkbox-label">
            <input type="checkbox" 
                   [(ngModel)]="filterNormalGoods" 
                   (change)="onBatchTypeFilterChange()"
                   class="filter-checkbox">
            <span class="filter-checkbox-text">H√†ng Nh·∫≠p</span>
          </label>
        </div>
        
        <!-- Return Goods Counter Box -->
        <div class="return-goods-counter-box">
          <i class="material-icons">assignment_return</i>
          <span class="counter-label">H√†ng tr·∫£ ch·ªù nh·∫≠p:</span>
          <span class="counter-value">{{ pendingReturnGoodsCount }}</span>
        </div>
        
        <!-- More Button - Opens Popup -->
        <button class="more-btn" (click)="openMorePopup()">
          <i class="material-icons">more_vert</i>
          More
        </button>
        
        <!-- Total Materials Counter -->
        <div class="total-counter-box">
          <span>T·ªïng: {{filteredMaterials.length}} materials</span>
        </div>
        
        <!-- Search Box -->
        <div class="search-box">
          <input type="text" 
                 [placeholder]="getSearchPlaceholder()"
                 [(ngModel)]="searchTerm"
                 (input)="onSearchInput($event)"
                 class="search-input">
        </div>
        
        <!-- Filter Buttons -->
        <div class="filter-buttons">
          <!-- Search Type Filter -->
          <div class="filter-group">
            <select class="filter-select" 
                    [(ngModel)]="searchType" 
                    (change)="changeSearchType($event.target.value)">
              <option value="materialCode">M√£ H√†ng</option>
              <option value="batchNumber">L√¥ H√†ng</option>
              <option value="location">V·ªã Tr√≠</option>
            </select>
          </div>
          
          <!-- Status Filter -->
          <div class="filter-group">
            <select class="filter-select" 
                    [(ngModel)]="statusFilter" 
                    (change)="changeStatusFilter($event.target.value)">
              <option value="pending">Ch∆∞a</option>
              <option value="received">ƒê√£ Nh·∫≠n</option>
              <option value="all">To√†n B·ªô</option>
            </select>
          </div>
          
          <!-- Sort Filter -->
          <div class="filter-group">
            <select class="filter-select" 
                    [(ngModel)]="sortBy" 
                    (change)="changeSortBy($event.target.value)">
              <option value="importDate">Ng√†y nh·∫≠p</option>
              <option value="batchNumber">L√¥ h√†ng</option>
              <option value="materialCode">M√£ h√†ng</option>
              <option value="createdAt">Th·ªùi gian t·∫°o</option>
            </select>
          </div>

        </div>
        
        <!-- Date Range Selector -->
        <div class="date-range-selector">
          <input type="date" 
                 [(ngModel)]="startDate" 
                 (change)="applyFilters()"
                 class="date-input"
                 title="T·ª´ ng√†y">
          <span class="date-separator">‚Üí</span>
          <input type="date" 
                 [(ngModel)]="endDate" 
                 (change)="applyFilters()"
                 class="date-input"
                 title="ƒê·∫øn ng√†y">
        </div>
        
        
        <!-- ·∫®n Factory Badge v√¨ kh√¥ng c√≥ ch·ª©c nƒÉng -->
        <!-- <span class="factory-badge asm1-badge">ASM1</span> -->
      </div>
    </div>
    
    <!-- Loading State -->
    <div class="loading-container" *ngIf="isLoading">
      <div class="loading-spinner">
        <i class="material-icons spinning">refresh</i>
        <span>ƒêang t·∫£i d·ªØ li·ªáu ASM1...</span>
      </div>
    </div>
    
    <!-- Error Message -->
    <div class="error-message" *ngIf="errorMessage">
      <i class="material-icons">error</i>
      {{errorMessage}}
    </div>
    
    <!-- Excel-like Body -->
    <div class="excel-body" *ngIf="!isLoading">
      <table class="excel-table">
        <thead>
          <tr>
            <th class="factory-cell">FACTORY</th>
            <th class="row-header">#</th>
            <th class="date-cell">NG√ÄY NH·∫¨P</th>
            <th class="batch-cell">BATCH</th>
            <th class="lot-cell">L√î H√ÄNG/ DNNK</th>
            <th class="code-cell">M√É H√ÄNG</th>
            <th class="po-cell">S·ªê P.O</th>
            <th class="number-cell">L∆Ø·ª¢NG NH·∫¨P</th>
            <th class="location-cell">V·ªä TR√ç</th>
            <th class="type-cell">LO·∫†I H√åNH</th>
            <th class="status-cell">STATUS</th>
            <th class="date-cell">HSD</th>
            <th class="status-cell">KK</th>
            <th class="status-cell">ƒê√É NH·∫¨N</th>
            <th class="number-cell">L∆Ø·ª¢NG ƒê∆†N V·ªä</th>
            <th class="supplier-cell">NH√Ä CUNG C·∫§P</th>
            <th class="unitweight-cell">U.W (g)</th>
            <th class="remarks-cell">L∆ØU √ù</th>
            <!-- ·∫®n 2 c·ªôt MSNV v√† TH·ªúI GIAN -->
            <!-- <th class="employee-cell">MSNV</th> -->
            <!-- <th class="time-cell">TH·ªúI GIAN</th> -->
            <!-- C·ªôt HO√ÄN TH√ÄNH ƒë√£ ƒë∆∞·ª£c x√≥a v√¨ kh√¥ng c√≥ ch·ª©c nƒÉng -->
            <th class="action-cell">X√ìA</th>
            <th class="action-cell">QR</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let material of filteredMaterials; let i = index" 
              [class.received-row]="material.isReceived"
                              >
            <td class="factory-cell factory-asm1">
              ASM1
            </td>
            <td class="row-header">{{i + 1}}</td>
            <td class="date-cell">{{formatDate(material.importDate)}}</td>
            <td class="batch-cell">{{material.internalBatch}}</td>
            <td class="lot-cell">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.batchNumber" 
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Kh√¥ng th·ªÉ s·ª≠a - ƒë√£ trong Inventory' : 'S·ª≠a l√¥ h√†ng'">
            </td>
            <td class="code-cell" 
                [class.material-code-printed]="material.hasQRGenerated"
                [class.material-received]="material.isReceived">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.materialCode" 
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Kh√¥ng th·ªÉ s·ª≠a - ƒë√£ trong Inventory' : 'S·ª≠a m√£ h√†ng'">
            </td>
            <td class="po-cell">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.poNumber" 
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Kh√¥ng th·ªÉ s·ª≠a - ƒë√£ trong Inventory' : 'S·ª≠a s·ªë PO'">
            </td>
            <td class="number-cell">
              <span class="quantity-display" 
                    [title]="material.isReceived ? 'Kh√¥ng th·ªÉ s·ª≠a - ƒë√£ trong Inventory' : 'S·ª≠a s·ªë l∆∞·ª£ng'">
                {{ formatNumber(material.quantity) }}
              </span>
            </td>
            <td class="location-cell">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.location" 
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Kh√¥ng th·ªÉ s·ª≠a - ƒë√£ trong Inventory' : 'S·ª≠a v·ªã tr√≠'"
                     placeholder="V·ªã tr√≠">
            </td>
            <td class="type-cell">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.type" 
                     (blur)="validateType(material)"
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Kh√¥ng th·ªÉ s·ª≠a - ƒë√£ trong Inventory' : 'S·ª≠a lo·∫°i h√¨nh (A12, H11, ND, E31)'"
                     placeholder="A12/H11/ND/E31">
            </td>
            <td class="status-cell">
              <span class="iqc-status-badge" [ngClass]="getIQCStatusClass(material.iqcStatus || 'Ch·ªù ki·ªÉm')">
                {{ material.iqcStatus || 'Ch·ªù ki·ªÉm' }}
              </span>
            </td>
            <td class="date-cell">
              <input type="date" 
                     class="date-input" 
                     [value]="material.expiryDate ? material.expiryDate.toISOString().split('T')[0] : ''"
                     (change)="onExpiryDateChange($event, material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Kh√¥ng th·ªÉ s·ª≠a - ƒë√£ trong Inventory' : 'S·ª≠a h·∫°n s·ª≠ d·ª•ng'">
            </td>
                         <td class="status-cell">
               <input type="checkbox" 
                      [checked]="material.qualityCheck" 
                      (change)="onQualityCheckChange($event, material)"
                      [disabled]="!canEditMaterials || material.isReceived || !canEditInBatch(material)"
                      [title]="getQualityCheckTitle(material)">
             </td>
             <td class="status-cell">
               <input type="checkbox" 
                      [checked]="material.isReceived" 
                      (change)="onReceivedChange($event, material)"
                      [disabled]="material.isReceived || !canEditMaterials || !canEditInBatch(material)"
                      [title]="getReceivedTitle(material)">
             </td>
            <td class="number-cell">
              <input type="number" 
                     class="editable-input" 
                     [(ngModel)]="material.rollsOrBags" 
                     (change)="updateMaterial(material)"
                     (blur)="updateMaterial(material)"
                     step="0.01"
                     min="0"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Kh√¥ng th·ªÉ s·ª≠a - ƒë√£ trong Inventory' : 'S·ª≠a l∆∞·ª£ng ƒë∆°n v·ªã (t·ª± ƒë·ªông l∆∞u v√†o danh m·ª•c)'">
            </td>
            <td class="supplier-cell">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.supplier" 
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Kh√¥ng th·ªÉ s·ª≠a - ƒë√£ trong Inventory' : 'S·ª≠a nh√† cung c·∫•p'"
                     placeholder="Nh√† cung c·∫•p">
            </td>
            <td class="unitweight-cell">
              <input type="number" 
                     class="editable-input" 
                     [(ngModel)]="material.unitWeight" 
                     (change)="updateMaterial(material)"
                     (input)="validateUnitWeight(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Kh√¥ng th·ªÉ s·ª≠a - ƒë√£ trong Inventory' : 'S·ª≠a tr·ªçng l∆∞·ª£ng ƒë∆°n v·ªã (gram)'"
                     placeholder="gram"
                     step="0.01"
                     min="0"
                     max="99999.99">
            </td>
            <td class="remarks-cell">
              <input type="text" 
                     class="editable-input" 
                     [(ngModel)]="material.remarks" 
                     (change)="updateMaterial(material)"
                     [disabled]="!canEditMaterials || material.isReceived"
                     [title]="material.isReceived ? 'Kh√¥ng th·ªÉ s·ª≠a - ƒë√£ trong Inventory' : 'S·ª≠a l∆∞u √Ω'"
                     placeholder="L∆∞u √Ω">
            </td>
             <!-- ·∫®n 2 c·ªôt MSNV v√† TH·ªúI GIAN -->
             <!-- <td class="employee-cell">
               <span class="employee-display">{{ getEmployeeDisplay(material) }}</span>
             </td>
             <td class="time-cell">
               <span class="time-display">{{ getTimeDisplay(material) }}</span>
             </td> -->
             <!-- C·ªôt HO√ÄN TH√ÄNH ƒë√£ ƒë∆∞·ª£c x√≥a v√¨ kh√¥ng c√≥ ch·ª©c nƒÉng -->
            <td class="status-cell">
              <button class="action-btn delete-btn" 
                      (click)="deleteMaterial(material)" 
                      [disabled]="!canDeleteMaterials" 
                      [title]="material.isReceived ? 'X√≥a kh·ªèi Inbound (kh√¥ng ·∫£nh h∆∞·ªüng Inventory)' : 'X√≥a material'">
                <i class="material-icons">delete</i>
              </button>
            </td>
                         <td class="qr-cell">
               <button class="print-qr-btn" 
                       (click)="printQRCode(material)" 
                       [disabled]="!canGenerateQR || !material.rollsOrBags || material.rollsOrBags <= 0"
                       [title]="!material.rollsOrBags || material.rollsOrBags <= 0 ? 'Vui l√≤ng nh·∫≠p l∆∞·ª£ng ƒë∆°n v·ªã tr∆∞·ªõc' : 'In tem QR code'">
                 <i class="material-icons">print</i>
                 Print
               </button>
             </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- File Upload (Hidden) -->
<input type="file" 
       #fileInput 
       accept=".xlsx,.xls,.csv" 
       style="display: none" 
       (change)="onFileSelect($event)">

<!-- Batch Start Modal -->
<div class="modal-overlay batch-modal-overlay" *ngIf="showBatchModal" (click)="closeBatchModal()">
  <div class="modal-content batch-modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header batch-modal-header">
      <div class="header-left">
        <div class="header-icon">
          <i class="material-icons">inventory_2</i>
        </div>
        <div class="header-text">
          <h3>B·∫Øt ƒë·∫ßu ki·ªÉm l√¥ h√†ng</h3>
          <p class="header-subtitle">Quy tr√¨nh ki·ªÉm tra v√† nh·∫≠n h√†ng nh·∫≠p kho</p>
        </div>
      </div>
      <button class="close-btn" (click)="closeBatchModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body batch-modal-body">
      <!-- Thay scanner b·∫±ng input tr·ª±c ti·∫øp -->
      <div class="scanner-section batch-scanner-section" *ngIf="isBatchScanningMode">
        <!-- Step 1: Nh·∫≠p m√£ nh√¢n vi√™n -->
        <div class="step-container">
          <div class="step-header">
            <div class="step-number">1</div>
            <div class="step-title">
              <h4>Nh·∫≠p m√£ nh√¢n vi√™n</h4>
              <p>Nh·∫≠p ho·∫∑c qu√©t m√£ nh√¢n vi√™n ƒë·ªÉ x√°c th·ª±c</p>
            </div>
          </div>
          
          <div class="employee-input-section">
            <div class="input-wrapper">
              <i class="material-icons input-icon">badge</i>
              <input 
                type="text" 
                id="employeeCodeInput"
                [(ngModel)]="employeeCode"
                placeholder="Nh·∫≠p m√£ nh√¢n vi√™n (VD: ASP0106)"
                class="employee-input uppercase-input modern-input"
                [disabled]="isEmployeeCodeSaved"
                (input)="onEmployeeCodeInput($event)"
                (keyup)="onEmployeeCodeKeyup($event)"
                (keyup.enter)="saveEmployeeCode()">
            </div>
            
            <button 
              class="save-btn modern-btn" 
              (click)="saveEmployeeCode()"
              [disabled]="!employeeCode || isEmployeeCodeSaved">
              <i class="material-icons">{{ isEmployeeCodeSaved ? 'check_circle' : 'save' }}</i>
              {{ isEmployeeCodeSaved ? 'ƒê√£ l∆∞u' : 'L∆∞u' }}
            </button>
          </div>

          <!-- Hi·ªÉn th·ªã tr·∫°ng th√°i m√£ nh√¢n vi√™n -->
          <div class="employee-status-badge" *ngIf="isEmployeeCodeSaved">
            <i class="material-icons">check_circle</i>
            <div class="status-info">
              <span class="status-label">M√£ nh√¢n vi√™n ƒë√£ x√°c th·ª±c:</span>
              <span class="status-value">{{ employeeCode }}</span>
            </div>
          </div>
        </div>

        <!-- Step 2: Ch·ªçn l√¥ h√†ng -->
        <div class="step-container" *ngIf="isEmployeeCodeSaved">
          <div class="step-header">
            <div class="step-number">2</div>
            <div class="step-title">
              <h4>Ch·ªçn l√¥ h√†ng/DNNK</h4>
              <p>Ch·ªçn l√¥ h√†ng c·∫ßn ki·ªÉm tra t·ª´ danh s√°ch</p>
            </div>
          </div>

          <div class="batch-selection-section">
            <div class="input-wrapper">
              <i class="material-icons input-icon">inventory</i>
              <select 
                id="batchSelect"
                [(ngModel)]="selectedBatch"
                class="batch-select modern-select"
                (change)="onBatchSelectionChange()">
                <option value="">-- Ch·ªçn l√¥ h√†ng/DNNK --</option>
                <option 
                  *ngFor="let batch of availableBatches" 
                  [value]="batch.batchNumber">
                  {{ batch.batchNumber }}
                </option>
              </select>
            </div>
            
            <!-- Show if no batches available -->
            <div class="warning-message" *ngIf="availableBatches.length === 0">
              <i class="material-icons">warning</i>
              <span>Kh√¥ng c√≥ l√¥ h√†ng n√†o kh·∫£ d·ª•ng</span>
            </div>
            
            <!-- Show batch info if selected -->
            <div class="batch-info-card" *ngIf="selectedBatch">
              <i class="material-icons">info</i>
              <div class="info-content">
                <span class="info-label">L√¥ h√†ng ƒë√£ ch·ªçn:</span>
                <span class="info-value">{{ selectedBatch }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: B·∫Øt ƒë·∫ßu ki·ªÉm tra -->
        <div class="step-container" *ngIf="selectedBatch">
          <div class="step-header">
            <div class="step-number">3</div>
            <div class="step-title">
              <h4>S·∫µn s√†ng b·∫Øt ƒë·∫ßu</h4>
              <p>Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu qu√° tr√¨nh ki·ªÉm tra</p>
            </div>
          </div>

          <div class="start-inspection-section">
            <button 
              class="start-inspection-btn modern-btn primary-btn" 
              (click)="startInspection()">
              <i class="material-icons">play_arrow</i>
              <span>B·∫Øt ƒë·∫ßu ki·ªÉm tra</span>
            </button>
          </div>
        </div>

        <!-- N√∫t d·ª´ng -->
        <div class="modal-footer batch-modal-footer">
          <button class="done-btn modern-btn secondary-btn" (click)="stopBatchScanningMode()" title="D·ª´ng ch·∫ø ƒë·ªô scan">
            <i class="material-icons">stop</i>
            <span>D·ª´ng</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scanner Input for Physical Scanner Mode -->
<div class="scanner-input-overlay" *ngIf="isScannerInputActive">
  <div class="scanner-input-container">
    <div class="scanner-input-header">
      <h5><i class="material-icons">scanner</i> Ch·∫ø ƒë·ªô m√°y scan</h5>
      <button class="close-scanner-btn" (click)="stopScannerMode()">
        <i class="material-icons">close</i>
      </button>
    </div>
    <div class="scanner-input-body">
      <input type="text" 
             #scannerInput
             [(ngModel)]="scannerBuffer"
             (keydown)="onScannerKeydown($event)"
             (blur)="onScannerInputBlur()"
             placeholder="Qu√©t barcode/QR code b·∫±ng m√°y scan..."
             class="scanner-input-field"
             autofocus>
      <div class="scanner-instructions">
        <p><i class="material-icons">info</i> S·ª≠ d·ª•ng m√°y scan ƒë·ªÉ qu√©t m√£ h√†ng</p>
        <p><i class="material-icons">keyboard</i> Ho·∫∑c nh·∫≠p tr·ª±c ti·∫øp t·ª´ b√†n ph√≠m</p>
      </div>
    </div>
  </div>
</div>

<!-- Camera QR Scanner Modal -->
<div class="camera-modal" *ngIf="isCameraModeActive">
  <div class="camera-modal-content">
    <div class="camera-modal-header">
      <h5><i class="material-icons">qr_code_scanner</i> Qu√©t QR code b·∫±ng camera</h5>
      <button class="close-camera-btn" (click)="stopCameraMode()">
        <i class="material-icons">close</i>
      </button>
    </div>
    <div class="camera-modal-body">
      <div class="camera-container">
        <div id="qr-reader"></div>
        <div class="camera-overlay">
          <div class="camera-frame"></div>
          <div class="camera-hint">ƒê·∫∑t m√£ QR v√†o khung ƒë·ªÉ qu√©t</div>
        </div>
      </div>
      <div class="camera-instructions">
        <p><i class="material-icons">info</i> S·ª≠ d·ª•ng camera ƒëi·ªán tho·∫°i ƒë·ªÉ qu√©t m√£ QR</p>
        <p><i class="material-icons">smartphone</i> ƒê·∫£m b·∫£o camera c√≥ quy·ªÅn truy c·∫≠p</p>
      </div>
    </div>
  </div>
</div>

<!-- Delete by Batch Modal -->
<div class="modal-overlay" *ngIf="showDeleteByBatchModal" (click)="closeDeleteByBatchModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üóëÔ∏è X√≥a theo l√¥ h√†ng</h3>
      <button class="close-btn" (click)="closeDeleteByBatchModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="batch-input-section">
        <label for="batchToDelete">Nh·∫≠p m√£ l√¥ h√†ng/DNNK c·∫ßn x√≥a:</label>
        <input 
          type="text" 
          id="batchToDelete"
          [(ngModel)]="batchToDelete"
          placeholder="V√≠ d·ª•: KZDNN0925/0050"
          class="batch-delete-input"
          (keyup.enter)="deleteByBatch()">
        
        <div class="batch-preview" *ngIf="batchToDelete && batchToDelete.trim() !== ''">
          <p><strong>S·∫Ω x√≥a t·∫•t c·∫£ materials c√≥ l√¥ h√†ng:</strong> <span class="batch-code">{{ batchToDelete }}</span></p>
          <p class="warning-text">‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="cancel-btn" (click)="closeDeleteByBatchModal()">
          <i class="material-icons">cancel</i>
          H·ªßy
        </button>
        <button class="delete-batch-btn" 
                (click)="deleteByBatch()"
                [disabled]="!batchToDelete || batchToDelete.trim() === ''">
          <i class="material-icons">delete</i>
          X√≥a l√¥ h√†ng
        </button>
      </div>
    </div>
  </div>
</div>

<!-- IQC Modal -->
<div class="modal-overlay" *ngIf="showIQCModal" (click)="closeIQCModal()">
  <div class="modal-content iqc-modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üî¨ IQC - Ki·ªÉm tra ch·∫•t l∆∞·ª£ng</h3>
      <button class="close-btn" (click)="closeIQCModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <!-- Step 1: Scan Employee ID -->
      <div class="iqc-scanner-section" *ngIf="iqcStep === 1">
        <label for="iqcScanInput">
          <i class="material-icons">badge</i> 
          B∆∞·ªõc 1: Qu√©t m√£ nh√¢n vi√™n QA
        </label>
        <input 
          type="text" 
          id="iqcScanInput"
          [(ngModel)]="iqcScanInput"
          placeholder="Qu√©t ho·∫∑c nh·∫≠p m√£ nh√¢n vi√™n..."
          class="iqc-scan-input"
          (keyup)="onIQCScanKeyup($event)"
          autofocus>
        
        <button class="scan-submit-btn" (click)="verifyQAEmployee()">
          <i class="material-icons">verified_user</i>
          X√°c th·ª±c
        </button>
      </div>

      <!-- Employee Verified Badge -->
      <div class="employee-verified-badge" *ngIf="iqcEmployeeVerified">
        <i class="material-icons">check_circle</i>
        <span>Nh√¢n vi√™n QA: <strong>{{ iqcEmployeeId }}</strong></span>
      </div>

      <!-- Step 2: Scanner Section -->
      <div class="iqc-scanner-section" *ngIf="iqcStep === 2">
        <label for="iqcScanInput">
          <i class="material-icons">qr_code_scanner</i>
          B∆∞·ªõc 2: Qu√©t m√£ QR c·ªßa material
        </label>
        <input 
          type="text" 
          id="iqcScanInput"
          [(ngModel)]="iqcScanInput"
          placeholder="Qu√©t ho·∫∑c nh·∫≠p m√£ QR..."
          class="iqc-scan-input"
          (keyup)="onIQCScanKeyup($event)"
          autofocus>
        
        <button class="scan-submit-btn" (click)="processIQCScan()">
          <i class="material-icons">qr_code_scanner</i>
          Scan
        </button>
      </div>

      <!-- Scanned Material Info -->
      <div class="scanned-material-info" *ngIf="scannedMaterial">
        <h4>üì¶ Material ƒë√£ qu√©t:</h4>
        <div class="material-details">
          <div class="detail-row">
            <span class="label">M√£ h√†ng:</span>
            <span class="value">{{ scannedMaterial.materialCode }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Batch:</span>
            <span class="value">{{ scannedMaterial.internalBatch }}</span>
          </div>
          <div class="detail-row">
            <span class="label">L√¥ h√†ng:</span>
            <span class="value">{{ scannedMaterial.batchNumber }}</span>
          </div>
          <div class="detail-row">
            <span class="label">S·ªë l∆∞·ª£ng:</span>
            <span class="value">{{ formatNumber(scannedMaterial.quantity) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Tr·∫°ng th√°i hi·ªán t·∫°i:</span>
            <span class="value iqc-status-badge" [ngClass]="getIQCStatusClass(scannedMaterial.iqcStatus || 'Ch·ªù ki·ªÉm')">
              {{ scannedMaterial.iqcStatus || 'Ch·ªù ki·ªÉm' }}
            </span>
          </div>
        </div>

        <!-- IQC Status Selection -->
        <div class="iqc-status-selection">
          <h4>Ch·ªçn tr·∫°ng th√°i IQC:</h4>
          <div class="status-buttons">
            <button class="status-btn pass-btn" (click)="updateIQCStatus('Pass')">
              <i class="material-icons">check_circle</i>
              Pass
            </button>
            <button class="status-btn ng-btn" (click)="updateIQCStatus('NG')">
              <i class="material-icons">cancel</i>
              NG
            </button>
            <button class="status-btn special-btn" (click)="updateIQCStatus('ƒê·∫∑c C√°ch')">
              <i class="material-icons">star</i>
              ƒê·∫∑c C√°ch
            </button>
            <button class="status-btn pending-btn" (click)="updateIQCStatus('Ch·ªù ph√°n ƒë·ªãnh')">
              <i class="material-icons">access_time</i>
              Ch·ªù ph√°n ƒë·ªãnh
            </button>
          </div>
        </div>
      </div>

      <!-- Instructions -->
      <div class="iqc-instructions" *ngIf="iqcStep === 1 && !iqcEmployeeVerified">
        <p><i class="material-icons">info</i> Qu√©t m√£ nh√¢n vi√™n QA ƒë·ªÉ b·∫Øt ƒë·∫ßu ki·ªÉm tra</p>
        <p><i class="material-icons">security</i> Ch·ªâ nh√¢n vi√™n thu·ªôc b·ªô ph·∫≠n QA m·ªõi c√≥ quy·ªÅn th·ª±c hi·ªán IQC</p>
      </div>
      
      <div class="iqc-instructions" *ngIf="iqcStep === 2 && !scannedMaterial">
        <p><i class="material-icons">info</i> Qu√©t m√£ QR tr√™n tem material ƒë·ªÉ b·∫Øt ƒë·∫ßu ki·ªÉm tra</p>
        <p><i class="material-icons">qr_code_scanner</i> Format: MaterialCode|PO|Quantity|Date</p>
      </div>
    </div>
  </div>
</div>

<!-- Nh·∫≠n h√†ng tr·∫£ Modal -->
<div class="modal-overlay" *ngIf="showReturnGoodsModal" (click)="closeReturnGoodsModal()">
  <div class="modal-content return-goods-modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üì¶ Nh·∫≠n h√†ng tr·∫£ (TRA)</h3>
      <button class="close-btn" (click)="closeReturnGoodsModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <!-- Step 1: Scan Employee ID -->
      <div class="return-goods-scanner-section" *ngIf="returnGoodsStep === 1">
        <label for="returnGoodsEmployeeInput">
          <i class="material-icons">badge</i> 
          B∆∞·ªõc 1: Qu√©t m√£ nh√¢n vi√™n (7 k√Ω t·ª± ƒë·∫ßu ti√™n)
        </label>
        <input 
          type="text" 
          id="returnGoodsEmployeeInput"
          [(ngModel)]="returnGoodsEmployeeInput"
          placeholder="Qu√©t ho·∫∑c nh·∫≠p m√£ nh√¢n vi√™n..."
          class="return-goods-scan-input"
          (keyup)="onReturnGoodsEmployeeKeyup($event)"
          (input)="onReturnGoodsEmployeeInput($event)"
          maxlength="7"
          autofocus>
        
        <button class="scan-submit-btn" (click)="verifyReturnGoodsEmployee()">
          <i class="material-icons">verified_user</i>
          X√°c th·ª±c
        </button>
      </div>

      <!-- Employee Verified Badge -->
      <div class="employee-verified-badge" *ngIf="returnGoodsEmployeeVerified">
        <i class="material-icons">check_circle</i>
        <span>Nh√¢n vi√™n: <strong>{{ returnGoodsEmployeeId }}</strong></span>
      </div>

      <!-- Step 2: Scan QR Code -->
      <div class="return-goods-scanner-section" *ngIf="returnGoodsStep === 2">
        <label for="returnGoodsQRInput">
          <i class="material-icons">qr_code_scanner</i>
          B∆∞·ªõc 2: Qu√©t m√£ QR c·ªßa h√†ng h√≥a
        </label>
        <input 
          type="text" 
          id="returnGoodsQRInput"
          [(ngModel)]="returnGoodsQRInput"
          placeholder="Qu√©t ho·∫∑c nh·∫≠p m√£ QR..."
          class="return-goods-scan-input"
          (keyup)="onReturnGoodsQRKeyup($event)"
          autofocus>
        
        <button class="scan-submit-btn" (click)="processReturnGoodsScan()">
          <i class="material-icons">qr_code_scanner</i>
          Scan
        </button>
      </div>

      <!-- Scan Result -->
      <div class="return-goods-result" *ngIf="returnGoodsScanResult">
        <div class="result-message" [ngClass]="returnGoodsScanResult.success ? 'success' : 'error'">
          <i class="material-icons">{{ returnGoodsScanResult.success ? 'check_circle' : 'error' }}</i>
          <span>{{ returnGoodsScanResult.message }}</span>
        </div>
        <div class="result-details" *ngIf="returnGoodsScanResult.material">
          <div class="detail-row">
            <span class="label">M√£ h√†ng:</span>
            <span class="value">{{ returnGoodsScanResult.material.materialCode }}</span>
          </div>
          <div class="detail-row">
            <span class="label">PO:</span>
            <span class="value">{{ returnGoodsScanResult.material.poNumber }}</span>
          </div>
          <div class="detail-row">
            <span class="label">L∆∞·ª£ng nh·∫≠p:</span>
            <span class="value">{{ returnGoodsScanResult.material.quantity }}</span>
          </div>
          <div class="detail-row">
            <span class="label">L√¥ h√†ng:</span>
            <span class="value">{{ returnGoodsScanResult.material.batchNumber }}</span>
          </div>
        </div>
      </div>

      <!-- Instructions -->
      <div class="return-goods-instructions" *ngIf="returnGoodsStep === 1 && !returnGoodsEmployeeVerified">
        <p><i class="material-icons">info</i> Qu√©t m√£ nh√¢n vi√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫≠n h√†ng tr·∫£</p>
        <p><i class="material-icons">badge</i> H·ªá th·ªëng s·∫Ω ƒë·ªçc 7 k√Ω t·ª± ƒë·∫ßu ti√™n c·ªßa m√£ nh√¢n vi√™n</p>
      </div>
      
      <div class="return-goods-instructions" *ngIf="returnGoodsStep === 2">
        <p><i class="material-icons">info</i> Qu√©t m√£ QR tr√™n tem material</p>
        <p><i class="material-icons">qr_code_scanner</i> Format: MaterialCode|PO|Quantity|Date</p>
        <p><i class="material-icons">search</i> H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t√¨m v√† check ƒë√£ nh·∫≠n n·∫øu kh·ªõp v·ªõi l√¥ h√†ng TRA</p>
      </div>
    </div>
  </div>
</div>

<!-- Ki·ªÉm h√†ng v·ªÅ Scan Modal -->
<div class="modal-overlay" *ngIf="showInspectionScanModal" (click)="closeInspectionScanModal()">
  <div class="modal-content return-goods-modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üì¶ Ki·ªÉm h√†ng v·ªÅ - L√¥ h√†ng: {{ inspectionBatchNumber }}</h3>
      <button class="close-btn" (click)="closeInspectionScanModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <!-- Employee Verified Badge -->
      <div class="employee-verified-badge" *ngIf="inspectionEmployeeVerified">
        <i class="material-icons">check_circle</i>
        <span>Nh√¢n vi√™n: <strong>{{ inspectionEmployeeId }}</strong></span>
      </div>

      <!-- Scan QR Code -->
      <div class="return-goods-scanner-section">
        <label for="inspectionQRInput">
          <i class="material-icons">qr_code_scanner</i>
          Qu√©t m√£ QR c·ªßa h√†ng h√≥a
        </label>
        <input 
          type="text" 
          id="inspectionQRInput"
          [(ngModel)]="inspectionQRInput"
          placeholder="Qu√©t ho·∫∑c nh·∫≠p m√£ QR..."
          class="return-goods-scan-input"
          (keyup)="onInspectionQRKeyup($event)"
          autofocus>
        
        <button class="scan-submit-btn" (click)="processInspectionScan()">
          <i class="material-icons">qr_code_scanner</i>
          Scan
        </button>
      </div>

      <!-- Scan Result Message -->
      <div class="return-goods-result" *ngIf="inspectionScanResult">
        <div class="result-message" [ngClass]="inspectionScanResult.success ? 'success' : 'error'">
          <i class="material-icons">{{ inspectionScanResult.success ? 'check_circle' : 'error' }}</i>
          <span>{{ inspectionScanResult.message }}</span>
        </div>
        <div class="error-detail" *ngIf="!inspectionScanResult.success && inspectionScanResult.errorDetail">
          <p>{{ inspectionScanResult.errorDetail }}</p>
        </div>
      </div>

      <!-- Danh s√°ch Materials ƒë√£ scan -->
      <div class="scanned-materials-list" *ngIf="scannedMaterialsList.length > 0">
        <h4 class="list-title">
          <i class="material-icons">list</i>
          Danh s√°ch m√£ h√†ng ƒë√£ scan ({{ scannedMaterialsList.length }})
        </h4>
        <div class="materials-grid">
          <div 
            *ngFor="let item of scannedMaterialsList" 
            class="material-item"
            [ngClass]="{ 'complete': item.isComplete }">
            <div class="material-header">
              <div class="material-code">{{ item.material.materialCode }}</div>
              <div class="material-po">PO: {{ item.material.poNumber }}</div>
              <div class="complete-badge" *ngIf="item.isComplete">
                <i class="material-icons">check_circle</i>
                <span>ƒê√£ duy·ªát</span>
              </div>
            </div>
            <div class="material-quantity-info">
              <div class="quantity-row">
                <span class="label">S·ªë l∆∞·ª£ng nh·∫≠p:</span>
                <span class="value">{{ item.totalQuantity | number:'1.2-2' }}</span>
              </div>
              <div class="quantity-row">
                <span class="label">ƒê√£ scan:</span>
                <span class="value scanned">{{ item.scannedQuantity | number:'1.2-2' }}</span>
              </div>
              <div class="quantity-row">
                <span class="label">C√≤n l·∫°i:</span>
                <span class="value remaining" [ngClass]="{ 'zero': item.remainingQuantity === 0 }">
                  {{ item.remainingQuantity | number:'1.2-2' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Instructions -->
      <div class="return-goods-instructions">
        <p><i class="material-icons">info</i> Qu√©t m√£ QR tr√™n tem material</p>
        <p><i class="material-icons">qr_code_scanner</i> Format: MaterialCode|PO|Quantity|Date</p>
        <p><i class="material-icons">search</i> H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t√¨m v√† check ƒë√£ nh·∫≠n n·∫øu kh·ªõp v·ªõi l√¥ h√†ng {{ inspectionBatchNumber }}</p>
      </div>
    </div>
  </div>
</div>

<!-- More Options Popup -->
<div class="modal-overlay" *ngIf="showMorePopup" (click)="closeMorePopup()">
  <div class="modal-content more-popup-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>‚öôÔ∏è More Options</h3>
      <button class="close-btn" (click)="closeMorePopup()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body more-popup-body">
      <!-- Export/Import Section -->
      <div class="popup-section">
        <h4 class="popup-section-title">Export/Import</h4>
        <div class="popup-actions">
          <button class="popup-action-btn" (click)="exportToExcel(); closeMorePopup()">
            <i class="material-icons">file_download</i>
            <span>Export to Excel</span>
          </button>
          <button class="popup-action-btn" (click)="downloadTemplate(); closeMorePopup()">
            <i class="material-icons">description</i>
            <span>Download Template</span>
          </button>
          <button class="popup-action-btn" (click)="importFileFromPopup()">
            <i class="material-icons">file_upload</i>
            <span>Import File</span>
          </button>
          <button class="popup-action-btn" (click)="downloadInboundReport(); closeMorePopup()">
            <i class="material-icons">assessment</i>
            <span>Download Report</span>
          </button>
        </div>
      </div>
      
      <!-- Delete Section -->
      <div class="popup-section">
        <h4 class="popup-section-title">Delete Options</h4>
        <div class="popup-actions">
          <button class="popup-action-btn delete-action" (click)="deleteAllMaterials(); closeMorePopup()">
            <i class="material-icons">delete_sweep</i>
            <span>X√≥a t·∫•t c·∫£</span>
          </button>
          <button class="popup-action-btn delete-batch-action" (click)="closeMorePopup(); openDeleteByBatchModal()">
            <i class="material-icons">delete_outline</i>
            <span>X√≥a theo l√¥ h√†ng</span>
          </button>
        </div>
      </div>
      
      <!-- Settings Section -->
      <div class="popup-section">
        <h4 class="popup-section-title">Settings</h4>
        <div class="popup-toggle">
          <label class="toggle-label">
            <input type="checkbox" 
                   [(ngModel)]="hideReceivedAfterNextDay" 
                   (change)="applyFilters()"
                   class="toggle-checkbox">
            <span class="toggle-text">·∫®n m√£ ƒë√£ nh·∫≠n qua ng√†y h√¥m sau</span>
          </label>
        </div>
      </div>
      
      <!-- Actions Section -->
      <div class="popup-section">
        <h4 class="popup-section-title">Actions</h4>
        <div class="popup-actions">
          <button class="popup-action-btn" (click)="clearFilters(); closeMorePopup()">
            <i class="material-icons">clear</i>
            <span>Reset</span>
          </button>
          <button class="popup-action-btn" (click)="loadMaterials(); closeMorePopup()">
            <i class="material-icons">refresh</i>
            <span>Refresh</span>
          </button>
          <button class="popup-action-btn" (click)="clearBatchFilter(); closeMorePopup()">
            <i class="material-icons">filter_alt_off</i>
            <span>Clear Filter</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
