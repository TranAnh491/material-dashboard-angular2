<div class="utilization-container">
  <!-- Page Header - Hidden per user request -->
  <!--
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="material-icons">inventory</i>
        Warehouse Utilization
      </h1>
      <p class="page-subtitle">Monitor loading capacity and utilization of warehouse rack systems</p>
    </div>
  </div>
  -->

  <!-- Summary Statistics -->
  <div class="summary-stats-grid">
    <div class="stat-card total">
      <div class="stat-icon">
        <i class="material-icons">view_module</i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ getTotalRacks() }}</div>
        <div class="stat-label">Total Positions</div>
      </div>
    </div>

    <div class="stat-card weight">
      <div class="stat-icon">
        <i class="material-icons">fitness_center</i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ getTotalWeight() | number:'1.0-0' }}</div>
        <div class="stat-label">Total Weight (kg)</div>
      </div>
    </div>

    <!-- Hidden per user request: Overall Utilization -->
    <!--
    <div class="stat-card utilization">
      <div class="stat-icon">
        <i class="material-icons">assessment</i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ getUseRate() }}%</div>
        <div class="stat-label">Overall Utilization</div>
      </div>
    </div>
    -->

    <div class="stat-card critical">
      <div class="stat-icon">
        <i class="material-icons">warning</i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ getHighUsageRacks() }}</div>
        <div class="stat-label">Critical (>95%)</div>
      </div>
    </div>

    <!-- Hidden per user request: Occupied Racks and Available Racks -->
    <!--
    <div class="stat-card occupied">
      <div class="stat-icon">
        <i class="material-icons">inventory_2</i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ getOccupiedRacks() }}</div>
        <div class="stat-label">Occupied Racks</div>
      </div>
    </div>

    <div class="stat-card available">
      <div class="stat-icon">
        <i class="material-icons">add_box</i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ getAvailableRacks() }}</div>
        <div class="stat-label">Available Racks</div>
      </div>
    </div>
    -->
  </div>

  <!-- Controls Section -->
  <div class="controls-section">
    <div class="controls-row">
      <div class="info-section">
        <div class="last-update" *ngIf="lastRackDataUpdate">
          <i class="material-icons">schedule</i>
          <span>Last updated: {{ lastRackDataUpdate | date:'MMM d, h:mm a' }}</span>
        </div>
      </div>
      
      <div class="actions-section">
        <!-- Refresh Button (always visible) -->
        <button class="refresh-btn" (click)="refreshRackData()" [disabled]="isRefreshing">
          <i class="material-icons" [class.rotating]="isRefreshing">refresh</i>
          <span>{{ isRefreshing ? 'Refreshing...' : 'Refresh Data' }}</span>
        </button>
        
        <!-- More Dropdown -->
        <div class="more-dropdown">
          <button class="more-btn" (click)="toggleMoreMenu()">
            <i class="material-icons">more_vert</i>
            <span>More</span>
          </button>
          
          <div class="more-menu" *ngIf="showMoreMenu">
            <button class="menu-item" (click)="downloadTemplate(); showMoreMenu = false">
              <i class="material-icons">download</i>
              <span>Download Template</span>
            </button>
            
            <button class="menu-item" (click)="fileInput.click(); showMoreMenu = false">
              <i class="material-icons">upload_file</i>
              <span>Import Catalog</span>
            </button>
            
            <button class="menu-item" (click)="openImportUnitWeightPopup(); showMoreMenu = false">
              <i class="material-icons">edit</i>
              <span>Import Unit Weight</span>
            </button>
            
            <button class="menu-item" (click)="exportMissingUnitWeight(); showMoreMenu = false">
              <i class="material-icons">warning</i>
              <span>Export Missing ({{ missingUnitWeightCount }})</span>
            </button>
            
            <button class="menu-item danger" (click)="clearAllUnitWeight(); showMoreMenu = false">
              <i class="material-icons">delete_sweep</i>
              <span>Clear All Unit Weights</span>
            </button>
          </div>
        </div>
        
        <input #fileInput type="file" accept=".csv,.xlsx,.xls" style="display: none" (change)="onFileSelected($event)">
      </div>
    </div>
  </div>

  <!-- Rack Loading Table -->
  <div class="rack-loading-section">
    <div class="section-header">
      <h3 class="section-title">
        <i class="material-icons">view_list</i>
        Rack Loading Details
      </h3>
      <p class="section-description">Detailed capacity and utilization data for all warehouse rack positions</p>
    </div>

    <div class="rack-loading-table-container">
      <!-- Loading Overlay -->
      <div class="loading-overlay" *ngIf="isRefreshing">
        <div class="loading-content">
          <i class="material-icons rotating">refresh</i>
          <span>Loading rack data...</span>
        </div>
      </div>
      
      <table class="rack-loading-table">
        <thead>
          <tr>
            <th>Rack Position</th>
            <th>Max Capacity (kg)</th>
            <th>Current Load (kg)</th>
            <th>Usage (%)</th>
            <th>Status</th>
            <th>Items</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let rack of rackLoadingData" 
              [class]="getRackStatusClass(rack.usage)" 
              class="clickable-row"
              (click)="exportPositionDetails(rack.position)"
              title="Click ƒë·ªÉ t·∫£i chi ti·∫øt v·ªã tr√≠ {{ rack.position }}">
            <td class="rack-position">
              <div class="position-display">
                <i class="material-icons">view_module</i>
                <span class="position-code">{{ rack.position }}</span>
              </div>
            </td>
            <td class="max-capacity">{{ rack.maxCapacity | number }}</td>
            <td class="current-load">{{ rack.currentLoad | number:'1.1-1' }}</td>
            <td class="usage-percentage">
              <div class="usage-container">
                <div class="usage-bar">
                  <div class="usage-fill" 
                       [style.width.%]="rack.usage" 
                       [class]="getUsageBarClass(rack.usage)">
                  </div>
                </div>
                <span class="usage-text">{{ rack.usage | number:'1.1-1' }}%</span>
              </div>
            </td>
            <td class="status">
              <span class="status-badge" [class]="getRackStatusClass(rack.usage)">
                {{ getRackStatusLabel(rack.usage) }}
              </span>
            </td>
            <td class="item-count">
              <div class="items-display">
                <i class="material-icons">inventory_2</i>
                <span>{{ rack.itemCount }}</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Import Progress Modal -->
  <div class="modal-overlay" *ngIf="showImportProgress">
    <div class="progress-modal">
      <div class="progress-header">
        <h3>üì§ ƒêang Import Catalog</h3>
      </div>
      
      <div class="progress-body">
        <div class="progress-stats">
          <div class="stat-item">
            <span class="stat-label">Batch:</span>
            <span class="stat-value">{{ importCurrentBatch }} / {{ importTotalBatches }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Ti·∫øn ƒë·ªô:</span>
            <span class="stat-value">{{ importProgress }}%</span>
          </div>
          <div class="stat-item success">
            <span class="stat-label">‚úÖ Th√†nh c√¥ng:</span>
            <span class="stat-value">{{ importSuccessCount }}</span>
          </div>
          <div class="stat-item error" *ngIf="importErrorCount > 0">
            <span class="stat-label">‚ùå L·ªói:</span>
            <span class="stat-value">{{ importErrorCount }}</span>
          </div>
        </div>
        
        <div class="progress-bar-container">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="importProgress"></div>
          </div>
          <span class="progress-text">{{ importProgress }}%</span>
        </div>
        
        <p class="progress-note">‚è≥ Vui l√≤ng ƒë·ª£i... ƒêang x·ª≠ l√Ω d·ªØ li·ªáu</p>
      </div>
    </div>
  </div>

  <!-- Import Unit Weight Popup -->
  <div class="modal-overlay" *ngIf="showImportUnitWeightPopup" (click)="closeImportUnitWeightPopup()">
    <div class="modal-content unit-weight-popup" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üìù Import Unit Weight</h3>
        <button class="close-btn" (click)="closeImportUnitWeightPopup()">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>
            <i class="material-icons">qr_code</i>
            M√£ v·∫≠t t∆∞ <span class="required">*</span>
          </label>
          <input 
            type="text" 
            [(ngModel)]="unitWeightForm.materialCode" 
            (input)="calculateUnitWeight()"
            placeholder="Nh·∫≠p m√£ v·∫≠t t∆∞ (v√≠ d·ª•: B001003)"
            class="form-control"
            autocomplete="off">
        </div>
        
        <div class="form-group">
          <label>
            <i class="material-icons">inventory_2</i>
            S·ªë l∆∞·ª£ng <span class="required">*</span>
          </label>
          <input 
            type="number" 
            [(ngModel)]="unitWeightForm.quantity" 
            (input)="calculateUnitWeight()"
            placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng"
            class="form-control"
            step="0.01"
            min="0.01"
            autocomplete="off">
        </div>
        
        <div class="form-group">
          <label>
            <i class="material-icons">scale</i>
            Tr·ªçng l∆∞·ª£ng t·ªïng (gram) <span class="required">*</span>
          </label>
          <input 
            type="number" 
            [(ngModel)]="unitWeightForm.totalWeight" 
            (input)="calculateUnitWeight()"
            placeholder="Nh·∫≠p tr·ªçng l∆∞·ª£ng t·ªïng (gram)"
            class="form-control"
            step="0.01"
            min="0.01"
            autocomplete="off">
        </div>
        
        <div class="form-group">
          <label>
            <i class="material-icons">calculate</i>
            Unit Weight (gram) <span class="readonly-label">(T·ª± t√≠nh)</span>
          </label>
          <input 
            type="number" 
            [(ngModel)]="unitWeightForm.unitWeight" 
            placeholder="T·ª± ƒë·ªông t√≠nh = Tr·ªçng l∆∞·ª£ng t·ªïng / S·ªë l∆∞·ª£ng"
            class="form-control readonly"
            readonly>
          <small class="form-hint">Unit Weight = Tr·ªçng l∆∞·ª£ng t·ªïng √∑ S·ªë l∆∞·ª£ng</small>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-cancel" (click)="closeImportUnitWeightPopup()">
          <i class="material-icons">close</i>
          H·ªßy
        </button>
        <button 
          class="btn btn-save" 
          (click)="saveUnitWeight()"
          [disabled]="!canSaveUnitWeight()">
          <i class="material-icons">check</i>
          Xong
        </button>
      </div>
    </div>
  </div>
</div> 